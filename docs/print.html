<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Kubebuilder 中文文档</title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded affix "><a href="introduction.html">引言</a></li><li class="expanded affix "><a href="quick-start.html">快速入门</a></li><li class="spacer"></li><li class="expanded "><a href="cronjob-tutorial/cronjob-tutorial.html"><strong aria-hidden="true">1.</strong> 教程: 构建 CronJob</a></li><li><ol class="section"><li class="expanded "><a href="cronjob-tutorial/basic-project.html"><strong aria-hidden="true">1.1.</strong> 基础项目中什么?</a></li><li class="expanded "><a href="cronjob-tutorial/empty-main.html"><strong aria-hidden="true">1.2.</strong> 每个程序都需要一个 main 入口</a></li><li class="expanded "><a href="cronjob-tutorial/gvks.html"><strong aria-hidden="true">1.3.</strong> Groups、Versions 和 Kinds 之间的关系</a></li><li class="expanded "><a href="cronjob-tutorial/new-api.html"><strong aria-hidden="true">1.4.</strong> 创建一个 API</a></li><li class="expanded "><a href="cronjob-tutorial/api-design.html"><strong aria-hidden="true">1.5.</strong> 设计一个 API</a></li><li><ol class="section"><li class="expanded "><a href="cronjob-tutorial/other-api-files.html"><strong aria-hidden="true">1.5.1.</strong> 简要说明: 其他文件是干什么的?</a></li></ol></li><li class="expanded "><a href="cronjob-tutorial/controller-overview.html"><strong aria-hidden="true">1.6.</strong> controller 中有什么?</a></li><li class="expanded "><a href="cronjob-tutorial/controller-implementation.html"><strong aria-hidden="true">1.7.</strong> 实现一个 controller</a></li><li><ol class="section"><li class="expanded "><a href="cronjob-tutorial/main-revisited.html"><strong aria-hidden="true">1.7.1.</strong> main 文件修改什么?</a></li></ol></li><li class="expanded "><a href="cronjob-tutorial/webhook-implementation.html"><strong aria-hidden="true">1.8.</strong> 实现 defaulting webhooks 和 validating webhooks</a></li><li class="expanded "><a href="cronjob-tutorial/running.html"><strong aria-hidden="true">1.9.</strong> Running and deploying the controller</a></li><li><ol class="section"><li class="expanded "><a href="cronjob-tutorial/cert-manager.html"><strong aria-hidden="true">1.9.1.</strong> Deploying the cert manager</a></li><li class="expanded "><a href="cronjob-tutorial/running-webhook.html"><strong aria-hidden="true">1.9.2.</strong> Deploying webhooks</a></li></ol></li><li class="expanded "><a href="cronjob-tutorial/epilogue.html"><strong aria-hidden="true">1.10.</strong> Epilogue</a></li></ol></li><li class="expanded "><a href="multiversion-tutorial/tutorial.html"><strong aria-hidden="true">2.</strong> Tutorial: Multi-Version API</a></li><li><ol class="section"><li class="expanded "><a href="multiversion-tutorial/api-changes.html"><strong aria-hidden="true">2.1.</strong> Changing things up</a></li><li class="expanded "><a href="multiversion-tutorial/conversion-concepts.html"><strong aria-hidden="true">2.2.</strong> Hubs, spokes, and other wheel metaphors</a></li><li class="expanded "><a href="multiversion-tutorial/conversion.html"><strong aria-hidden="true">2.3.</strong> Implementing conversion</a></li><li><ol class="section"><li class="expanded "><a href="multiversion-tutorial/webhooks.html"><strong aria-hidden="true">2.3.1.</strong> and setting up the webhooks</a></li></ol></li><li class="expanded "><a href="multiversion-tutorial/deployment.html"><strong aria-hidden="true">2.4.</strong> Deployment and Testing</a></li><li class="spacer"></li></ol></li><li class="expanded "><a href="migrations.html"><strong aria-hidden="true">3.</strong> Migrations</a></li><li><ol class="section"><li class="expanded "><a href="migration/v1vsv2.html"><strong aria-hidden="true">3.1.</strong> Kubebuilder v1 vs v2</a></li><li><ol class="section"><li class="expanded "><a href="migration/guide.html"><strong aria-hidden="true">3.1.1.</strong> Migration Guide</a></li></ol></li><li class="expanded "><a href="migration/multi-group.html"><strong aria-hidden="true">3.2.</strong> Single Group to Multi-Group</a></li><li class="spacer"></li></ol></li><li class="expanded "><a href="reference/reference.html"><strong aria-hidden="true">4.</strong> Reference</a></li><li><ol class="section"><li class="expanded "><a href="reference/generating-crd.html"><strong aria-hidden="true">4.1.</strong> Generating CRDs</a></li><li class="expanded "><a href="reference/using-finalizers.html"><strong aria-hidden="true">4.2.</strong> Using Finalizers</a></li><li class="expanded "><a href="reference/kind.html"><strong aria-hidden="true">4.3.</strong> Kind cluster</a></li><li class="expanded "><a href="reference/webhook-overview.html"><strong aria-hidden="true">4.4.</strong> What's a webhook?</a></li><li><ol class="section"><li class="expanded "><a href="reference/admission-webhook.html"><strong aria-hidden="true">4.4.1.</strong> Admission webhook</a></li><li class="expanded "><a href="reference/webhook-for-core-types.html"><strong aria-hidden="true">4.4.2.</strong> Webhooks for Core Types</a></li></ol></li><li class="expanded "><a href="reference/markers.html"><strong aria-hidden="true">4.5.</strong> Markers for Config/Code Generation</a></li><li><ol class="section"><li class="expanded "><a href="reference/markers/crd.html"><strong aria-hidden="true">4.5.1.</strong> CRD Generation</a></li><li class="expanded "><a href="reference/markers/crd-validation.html"><strong aria-hidden="true">4.5.2.</strong> CRD Validation</a></li><li class="expanded "><a href="reference/markers/crd-processing.html"><strong aria-hidden="true">4.5.3.</strong> CRD Processing</a></li><li class="expanded "><a href="reference/markers/webhook.html"><strong aria-hidden="true">4.5.4.</strong> Webhook</a></li><li class="expanded "><a href="reference/markers/object.html"><strong aria-hidden="true">4.5.5.</strong> Object/DeepCopy</a></li><li class="expanded "><a href="reference/markers/rbac.html"><strong aria-hidden="true">4.5.6.</strong> RBAC</a></li></ol></li><li class="expanded "><a href="reference/controller-gen.html"><strong aria-hidden="true">4.6.</strong> controller-gen CLI</a></li><li class="expanded "><a href="reference/artifacts.html"><strong aria-hidden="true">4.7.</strong> Artifacts</a></li><li class="expanded "><a href="reference/writing-tests.html"><strong aria-hidden="true">4.8.</strong> Writing controller tests</a></li><li><ol class="section"><li class="expanded "><a href="reference/testing/envtest.html"><strong aria-hidden="true">4.8.1.</strong> Using envtest in integration tests</a></li></ol></li><li class="expanded "><a href="reference/metrics.html"><strong aria-hidden="true">4.9.</strong> Metrics</a></li><li class="spacer"></li></ol></li><li class="expanded "><a href="TODO.html">Appendix: The TODO Landing Page</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Kubebuilder 中文文档</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                            <a href="https://github.com/xuejipeng/kubebuilder-doc-cn" title="Git repository" aria-label="Git repository">
                                <i id="git-repository-button" class="fa fa-github"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><strong>注意:</strong> 一些读者可能想直接去 <a href="quick-start.html">Quick
Start</a>.</p>
<p><strong>如果正在使用 Kubebuilder v1, 请查看 <a href="https://book-v1.book.kubebuilder.io">Kubebuilder v1</a>。</strong></p>
<p><strong>英文原版: <a href="https://book.kubebuilder.io/introduction.html">book.kubebuilder.io</a></strong></p>
<h2><a class="header" href="#哪些人适合看这个文档" id="哪些人适合看这个文档">哪些人适合看这个文档</a></h2>
<h4><a class="header" href="#kubernetes-的使用者" id="kubernetes-的使用者">Kubernetes 的使用者</a></h4>
<p>Kubernetes 的使用者将通过学习 API 是如何设计和实现的，获得对 Kubernetes 更深入的了解。 本书将教读者如何开发自己的 Kubernetes API 以及实现 Kubernetes API 的核心原理。</p>
<p>包括:</p>
<ul>
<li>如何构造 Kubernetes API 和 Resources</li>
<li>如何进行 API 版本控制</li>
<li>如何实现故障自愈</li>
<li>如何实现垃圾回收和 Finalizers</li>
<li>如何创建声明式和命令式 API</li>
<li>如何创建 Level-Based API 和 Edge-Base API</li>
<li>如何创建 Resources 和 Subresources</li>
</ul>
<h4><a class="header" href="#kubernetes-api-extension-developers" id="kubernetes-api-extension-developers">Kubernetes API extension developers</a></h4>
<p>API extension developers 将学习实现标准的 Kubernetes API 的原理和概念，以及用于快速构建 API 的工具和库。本书涵盖了开发人员通常会遇到的陷阱和误解。</p>
<p>包括:</p>
<ul>
<li>如何用一个 reconciliation 方法处理多个 events</li>
<li>如何定期执行 reconciliation 方法</li>
<li><strong>将来会有</strong>
<ul>
<li>何时使用 lister cache 与 live lookups(实时查找)</li>
<li>如何垃圾回收和 Finalizers</li>
<li>如何使用 Declarative Validation 和 Webhook Validation</li>
<li>如何实现 API 版本控制</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#相关资源" id="相关资源">相关资源</a></h2>
<ul>
<li>
<p>代码仓库: <a href="https://sigs.k8s.io/kubebuilder">sigs.k8s.io/kubebuilder</a></p>
</li>
<li>
<p>Slack channel: <a href="http://slack.k8s.io/#kubebuilder">#kubebuilder</a></p>
</li>
<li>
<p>Google Group:
<a href="https://groups.google.com/forum/#!forum/kubebuilder">kubebuilder@googlegroups.com</a></p>
</li>
</ul>
<h1><a class="header" href="#快速开始" id="快速开始">快速开始</a></h1>
<p>这个 Quick Start 指南包括:</p>
<ul>
<li><a href="quick-start.html#create-a-project">如何创建一个 project</a></li>
<li><a href="quick-start.html#create-an-api">如何创建一个 API</a></li>
<li><a href="quick-start.html#test-it-out">如何在本地运行 operator</a></li>
<li><a href="quick-start.html#run-it-on-the-cluster">如何在集群上运行 operator</a></li>
</ul>
<h2><a class="header" href="#环境准备" id="环境准备">环境准备</a></h2>
<ul>
<li><a href="https://golang.org/dl/">go</a> version v1.13+.</li>
<li><a href="https://docs.docker.com/install/">docker</a> version 17.03+.</li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a> version v1.11.3+.</li>
<li><a href="https://sigs.k8s.io/kustomize/docs/INSTALL.md">kustomize</a> v3.1.0+</li>
<li>Access to a Kubernetes v1.11.3+ cluster.</li>
</ul>
<p><span id="installation"></span></p>
<h2><a class="header" href="#安装" id="安装">安装</a></h2>
<p>安装 <a href="https://sigs.k8s.io/kubebuilder">kubebuilder</a>:</p>
<pre><code class="language-bash">os=$(go env GOOS)
arch=$(go env GOARCH)

# download kubebuilder and extract it to tmp
curl -L https://go.kubebuilder.io/dl/2.2.0/${os}/${arch} | tar -xz -C /tmp/

# move to a long-term location and put it on your path
# (you'll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)
sudo mv /tmp/kubebuilder_2.2.0_${os}_${arch} /usr/local/kubebuilder
export PATH=$PATH:/usr/local/kubebuilder/bin
</code></pre>
<aside class="note">
<h1><a class="header" href="#使用最新版本" id="使用最新版本">使用最新版本</a></h1>
<p>可以使用以下链接获取到最新版本 <code>https://go.kubebuilder.io/dl/latest/${os}/${arch}</code>.</p>
</aside>
<p><span id="create-a-project"></span></p>
<h2><a class="header" href="#创建一个-project" id="创建一个-project">创建一个 Project</a></h2>
<p>创建一个目录，然后运行 init 命令以初始化新项目</p>
<pre><code class="language-bash">mkdir $GOPATH/src/example
cd $GOPATH/src/example
kubebuilder init --domain my.domain
</code></pre>
<aside class="note">
<h1><a class="header" href="#项目不在-gopath-下" id="项目不在-gopath-下">项目不在 $GOPATH 下</a></h1>
<p>如果创建的项目不在<code>GOPATH</code>中，为了让 kubebuilder 和 Go 识别导入路径，需要运行 <code>go mod init &lt;modulename&gt;</code></p>
<p>对于 <code>GOPATH</code> 的解释可以参考 <a href="https://golang.org/doc/code.html">How to Write Go Code</a> 中的 <a href="https://golang.org/doc/code.html#GOPATH">The GOPATH environment variable</a> </p>
</aside>
<aside class="note">
<h1><a class="header" href="#go-package-问题" id="go-package-问题">Go package 问题</a></h1>
<p>如果报错 <code>cannot find package ... (from $GOROOT)</code> 请执行<code>$ export GO111MODULE=on</code> 开启 Go module 模式。</p>
</aside>
<p><span id="create-an-api"></span></p>
<h2><a class="header" href="#创建一个-api" id="创建一个-api">创建一个 API</a></h2>
<p>运行以下命令创建一个新的 API(group/version) --&gt;<code>webapp/v1</code>, 并在此 API 上创建一个新的 Kind(CRD) --&gt; <code>Guestbook </code></p>
<!--Run the following command to create a new API (group/version) as `webapp/v1` and the new Kind(CRD) `Guestbook` on it:
-->
<pre><code class="language-bash">kubebuilder create api --group webapp --version v1 --kind Guestbook
</code></pre>
<aside class="note">
<h1><a class="header" href="#选项说明" id="选项说明">选项说明</a></h1>
<p><code>Create Resource [y/n]：y</code> 创建文件<code>api/v1/guestbook_types.go</code>，此文件用来定义 API</p>
<p><code>Create Controller [y/n]：y</code> 创建文件 <code>controller/guestbook_controller.go</code>，此文件用来编写实现 Kind(CRD) 的业务逻辑</p>
</aside>
<p><strong>备注:</strong> 对于如何设计 API 和如何实现业务逻辑可以参考 <a href="/cronjob-tutorial/api-design.html">Designing an API</a> 和 <a href="cronjob-tutorial/controller-overview.html">What’s in
a Controller</a>.</p>
<details><summary>查看示例 `(api/v1/guestbook_types.go)` </summary>
<p>
<pre><code class="language-go">// GuestbookSpec defines the desired state of Guestbook
type GuestbookSpec struct {
	// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
	// Important: Run &quot;make&quot; to regenerate code after modifying this file

	// Quantity of instances
	// +kubebuilder:validation:Minimum=1
	// +kubebuilder:validation:Maximum=10
	Size int32 `json:&quot;size&quot;`

	// Name of the ConfigMap for GuestbookSpec's configuration
	// +kubebuilder:validation:MaxLength=15
	// +kubebuilder:validation:MinLength=1
	ConfigMapName string `json:&quot;configMapName&quot;`

	// +kubebuilder:validation:Enum=Phone;Address;Name
	Type string `json:&quot;alias,omitempty&quot;`
}

// GuestbookStatus defines the observed state of Guestbook
type GuestbookStatus struct {
	// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
	// Important: Run &quot;make&quot; to regenerate code after modifying this file

	// PodName of the active Guestbook node.
	Active string `json:&quot;active&quot;`

	// PodNames of the standby Guestbook nodes.
	Standby []string `json:&quot;standby&quot;`
}

type Guestbook struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   GuestbookSpec   `json:&quot;spec,omitempty&quot;`
	Status GuestbookStatus `json:&quot;status,omitempty&quot;`
}
</code></pre>
</p>
</details>
<p><span id="test-it-out"></span></p>
<h2><a class="header" href="#在本地运行-operator" id="在本地运行-operator">在本地运行 operator</a></h2>
<p>你需要一个 Kubernetes 测试集群来进行测试，你可以使用 <a href="https://sigs.k8s.io/kind">KIND</a> 来启动一个本地或者远程的测试集群</p>
<aside class="note">
<h1><a class="header" href="#context-使用" id="context-使用">Context 使用</a></h1>
<p>Controller 会自动使用你当前 context 中的 kubeconfig 文件操作 kubernetes 集群(即：<code>kubectl cluster-info</code> 显示的集群)</p>
</aside> 
<p>在集群中安装 CRDs</p>
<pre><code class="language-bash">make install
</code></pre>
<p>运行 controller (这个命令不会再后台运行 controller，所以建议新建一个 terminal 运行以下命令)</p>
<pre><code class="language-bash">make run
</code></pre>
<h2><a class="header" href="#安装-custom-resources-实例" id="安装-custom-resources-实例">安装 Custom Resources 实例</a></h2>
<p>创建 Project时，对于 <code>Create Resource [y/n]</code>，如果你选择 <code>y</code>, 将会在 <code>config/samples/</code> 目录中为你的 CRD 创建一个 CR 文件 xxx.yaml (如果你修改了 API 定义文件(api/v1/guestbook_types.go)，请务必修改此文件)</p>
<pre><code class="language-bash">kubectl apply -f config/samples/
</code></pre>
<p><span id="run-it-on-the-cluster"></span></p>
<h2><a class="header" href="#在集群上运行-operator" id="在集群上运行-operator">在集群上运行 operator</a></h2>
<p>Build 并 Push 镜像 <code>IMG</code>:</p>
<pre><code class="language-bash">make docker-build docker-push IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag
</code></pre>
<p>使用指定镜像<code>IMG</code>将 operator 部署到集群中:</p>
<pre><code class="language-bash">make deploy IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag
</code></pre>
<aside class="note">
<h1><a class="header" href="#rbac-errors" id="rbac-errors">RBAC errors</a></h1>
<p>如果你遇到 RBAC 相关错误，你需要使用 cluster-admin 权限或者使用 admin 登录，可以参考 <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control#iam-rolebinding-bootstrap">Prerequisites for using Kubernetes RBAC on GKE cluster v1.11.x and older</a></p>
</aside> 
<h2><a class="header" href="#卸载-crds" id="卸载-crds">卸载 CRDs</a></h2>
<p>从集群中删除 CRDs：</p>
<pre><code class="language-bash">make uninstall
</code></pre>
<h2><a class="header" href="#下一步" id="下一步">下一步</a></h2>
<p>现在，请继续学习 <a href="https://book.kubebuilder.io/cronjob-tutorial/cronjob-tutorial.html">CronJob tutorial</a> 教程，通过开发演示示例项目更好地了解其工作原理。</p>
<h1><a class="header" href="#教程构建-cronjob" id="教程构建-cronjob">教程：构建 CronJob</a></h1>
<p>很多教程都是从一些人为设置好的程序开始，或者是给你一些了解基础知识的小应用程序，这些不能让你深入了解更复杂的东西。 相反，本教程几乎带会您了解 Kubebuilder 的全部复杂性，从简单开始，然后逐步发展为功能齐全的产品。</p>
<p>现在让我们假设 Kubernetes 中实现的 <code>CronJob Controller</code> 并不能满足我们的需求，我们希望使用 Kubebuilder 重写它。</p>
<p><code>CronJob controller</code> 会控制 kubernetes 集群上的 job 每隔一段时间运行一次，它是基于 <code>Job controller</code> 实现的，<code>Job controller</code> 的 job 只会执行任务一次。</p>
<p>通过重写 <code>Job controller</code>，我们可以更加了解如何与不属于集群的资源类型进行交互。</p>
<aside class="note">
<h1><a class="header" href="#注意" id="注意">注意</a></h1>
<p>请注意，本教程的大部分内容是由 literal Go 动态生成的：<a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata">docs/book/src/cronjob-tutorial/testdata</a>，完整的可运行项目位于<a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata/project">project</a>中，而生成动态 markdown 的 GO 文件位于<a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata">testdata</a>目录下。</p>
</aside>
<h2><a class="header" href="#创建我们的项目" id="创建我们的项目">创建我们的项目</a></h2>
<p>如<a href="cronjob-tutorial/../quick-start.html">快速入门</a>中所述，我们需要创建一个新项目，请确保已经<a href="cronjob-tutorial/../quick-start.html#installation">安装Kubebuilder</a> ，然后执行如下命令创建一个新项目：</p>
<pre><code class="language-bash"># we'll use a domain of tutorial.kubebuilder.io,
# so all API groups will be &lt;group&gt;.tutorial.kubebuilder.io.
kubebuilder init --domain tutorial.kubebuilder.io
</code></pre>
<p>现在我们已经有了一个项目，下面让我们看一下到目前为止 Kubebuilder 为我们搭建的脚手架...</p>
<h1><a class="header" href="#基本项目中有什么" id="基本项目中有什么">基本项目中有什么？</a></h1>
<p>在创建新项目时，Kubebuilder 为我们提供了一些基本的模板。</p>
<h2><a class="header" href="#基础设施模板" id="基础设施模板">基础设施模板</a></h2>
<p>首先，会创建一些用于构建项目的 basic infrastructure：</p>
<details> <summary><code>go.mod</code>: 一个与项目匹配，包含最基本依赖关系的 go module 文件</summary>
<pre><code class="language-go">module tutorial.kubebuilder.io/project

go 1.13

require (
	github.com/go-logr/logr v0.1.0
	github.com/robfig/cron v1.2.0
	k8s.io/api v0.17.2
	k8s.io/apimachinery v0.17.2
	k8s.io/client-go v0.17.2
	sigs.k8s.io/controller-runtime v0.5.0
)
</code></pre>
</details>
<details><summary><code>Makefile</code>: 用于构建和部署 controller</summary>
<pre><code class="language-makefile">
# Image URL to use all building/pushing image targets
IMG ?= controller:latest
# Produce CRDs that work back to Kubernetes 1.11 (no version conversion)
CRD_OPTIONS ?= &quot;crd:trivialVersions=true&quot;

all: manager

# Run tests
test: generate fmt vet manifests
	go test ./api/... ./controllers/... -coverprofile cover.out

# Build manager binary
manager: generate fmt vet
	go build -o bin/manager main.go

# Run against the configured Kubernetes cluster in ~/.kube/config
run: generate fmt vet
	go run ./main.go

# Install CRDs into a cluster
install: manifests
	kubectl apply -f config/crd/bases

# Deploy controller in the configured Kubernetes cluster in ~/.kube/config
deploy: manifests
	kubectl apply -f config/crd/bases
	kustomize build config/default | kubectl apply -f -

# Generate manifests e.g. CRD, RBAC etc.
manifests: controller-gen
	$(CONTROLLER_GEN) $(CRD_OPTIONS) rbac:roleName=manager-role webhook paths=&quot;./api/...;./controllers/...&quot; output:crd:artifacts:config=config/crd/bases

# Run go fmt against code
fmt:
	go fmt ./...

# Run go vet against code
vet:
	go vet ./...

# Generate code
generate: controller-gen
	$(CONTROLLER_GEN) object:headerFile=./hack/boilerplate.go.txt paths=./api/...

# Build the docker image
docker-build: test
	docker build . -t ${IMG}
	@echo &quot;updating kustomize image patch file for manager resource&quot;
	sed -i'' -e 's@image: .*@image: '&quot;${IMG}&quot;'@' ./config/default/manager_image_patch.yaml

# Push the docker image
docker-push:
	docker push ${IMG}

# find or download controller-gen
# download controller-gen if necessary
controller-gen:
ifeq (, $(shell which controller-gen))
	go get sigs.k8s.io/controller-tools/cmd/controller-gen@v0.2.0-rc.0
CONTROLLER_GEN=$(shell go env GOPATH)/bin/controller-gen
else
CONTROLLER_GEN=$(shell which controller-gen)
endif
</code></pre>
</details>
<details><summary><code>PROJECT</code>: 用于创建新组件的 Kubebuilder 元数据</summary>
<pre><code class="language-yaml">version: &quot;2&quot;
domain: tutorial.kubebuilder.io
repo: tutorial.kubebuilder.io/project
</code></pre>
</details>
<h2><a class="header" href="#启动配置项模板" id="启动配置项模板">启动配置项模板</a></h2>
<p>我们能在 <a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata/project/config"><code>config/</code></a> 目录下找到运行 operator 所需的所有配置文件，现在它只包含运行 controller 所需要的 <a href="https://sigs.k8s.io/kustomize">Kustomize</a> YAML 配置文件，后续我们编写 operator 时，这个目录还会包含 CustomResourceDefinitions(CRD)、RBAC 和 Webhook 等相关的配置文件</p>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata/project/config/default"><code>config/default</code></a> 包含 <a href="https://github.com/kubernetes-sigs/kubebuilder/blob/master/docs/book/src/cronjob-tutorial/testdata/project/config/default/kustomization.yaml">Kustomize base</a> 文件，用于以标准配置启动 controller。</p>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata/project/config"><code>config/</code></a>目录下每个目录都包含不同的配置：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata/project/config/manager"><code>config/manager</code></a>: 包含在 k8s 集群中以 pod 形式运行 controller 的 YAML 配置文件 </p>
</li>
<li>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata/project/config/rbac"><code>config/rbac</code></a>: 包含运行 controller 所需最小权限的配置文件</p>
</li>
</ul>
<h2><a class="header" href="#程序入口" id="程序入口">程序入口</a></h2>
<p>最后，但同样重要的是，Kubebuilder 创建了我们项目的程序入口：main.go。下面让我们看看这个文件...</p>
<h1><a class="header" href="#每个程序都需要一个-main-入口" id="每个程序都需要一个-main-入口">每个程序都需要一个 main 入口</a></h1>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/emptymain-cn.go">emptymain-cn.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<p>我们的 main.go 文件最开始会 import 一些基础的 package。 例如：</p>
<ul>
<li>比较核心的库： <a href="https://godoc.org/sigs.k8s.io/controller-runtime">controller-runtime</a></li>
<li>controller-runtime 的默认日志库：Zap（稍后会详细介绍）</li>
</ul>
<pre><code class="language-go">package main

import (
	&quot;flag&quot;
	&quot;fmt&quot;
	&quot;os&quot;

	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	_ &quot;k8s.io/client-go/plugin/pkg/client/auth/gcp&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/cache&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/log/zap&quot;
	// +kubebuilder:scaffold:imports
)
</code></pre>
<p>每组 controller 都需要一个 <a href="https://book.kubebuilder.io/cronjob-tutorial/gvks.html#err-but-whats-that-scheme-thing"><em>Scheme</em></a>，
Scheme 会提供 Kinds 与 Go types 之间的映射关系(现在你只需要记住这一点)。
在编写 API 定义时，我们将会进一步讨论 Kinds。</p>
<pre><code class="language-go">var (
	scheme   = runtime.NewScheme()
	setupLog = ctrl.Log.WithName(&quot;setup&quot;)
)

func init() {

	// +kubebuilder:scaffold:scheme
}
</code></pre>
<p>此时，我们 main.go 的功能相对来说比较简单：</p>
<ol>
<li>
<p>为 metrics 绑定一些基本的 flags。</p>
</li>
<li>
<p>实例化一个 manager，用于跟踪我们运行的所有 controllers，并设置 shared caches 和可以连接到 API server 的 k8s clients 实例，并将 Scheme 配置传入 manager。</p>
</li>
<li>
<p>运行我们的 manager, 而 manager 又运行所有的 controllers 和 webhook。manager 会一直处于运行状态，直到收到正常关闭信号为止。
这样，当我们的 operator 运行在 Kubernetes 上时，我们可以通过优雅的方式终止这个 Pod。</p>
</li>
</ol>
<p>虽然目前我们还没有什么可以运行，但是请记住 <code>+kubebuilder:scaffold:builder</code> 注释的位置 -- 很快那里就会变得有趣。</p>
<pre><code class="language-go">func main() {
	var metricsAddr string
	flag.StringVar(&amp;metricsAddr, &quot;metrics-addr&quot;, &quot;:8080&quot;, &quot;The address the metric endpoint binds to.&quot;)
	flag.Parse()

	ctrl.SetLogger(zap.New(zap.UseDevMode(true)))

	mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{Scheme: scheme, MetricsBindAddress: metricsAddr})
	if err != nil {
		setupLog.Error(err, &quot;unable to start manager&quot;)
		os.Exit(1)
	}
</code></pre>
<p>请注意：下面代码如果指定了 Namespace 字段, controllers 仍然可以 watch cluster 级别的资源(例如Node), 但是对于 namespace 级别的资源，cache 将仅可以缓存指定 namespace 中的资源。</p>
<pre><code class="language-go">	mgr, err = ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{
		Scheme:             scheme,
		Namespace:          namespace,
		MetricsBindAddress: metricsAddr,
	})
</code></pre>
<p>上面的示例将 operator 应用的获取资源范围限制在了单个 namespace。在这种情况下，建议将默认的 ClusterRole 和 ClusterRoleBinding 分别替换​​为 Role 和 RoleBinding 来将授权限制于此名称空间。
有关更多信息，请参见如何使用 <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">RBAC Authorization</a>。</p>
<p>除此之外，你也可以使用 MultiNamespacedCacheBuilder 来监视一组特定的 namespaces：</p>
<pre><code class="language-go">	var namespaces []string // List of Namespaces

	mgr, err = ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{
		Scheme:             scheme,
		NewCache:           cache.MultiNamespacedCacheBuilder(namespaces),
		MetricsBindAddress: fmt.Sprintf(&quot;%s:%d&quot;, metricsHost, metricsPort),
	})
</code></pre>
<p>有关更多信息，请参见 <a href="https://godoc.org/github.com/kubernetes-sigs/controller-runtime/pkg/cache#MultiNamespacedCacheBuilder">MultiNamespacedCacheBuilder</a></p>
<pre><code class="language-go">	// +kubebuilder:scaffold:builder

	setupLog.Info(&quot;starting manager&quot;)
	if err := mgr.Start(ctrl.SetupSignalHandler()); err != nil {
		setupLog.Error(err, &quot;problem running manager&quot;)
		os.Exit(1)
	}
}
</code></pre>
</div>
<p>有了这些，我们就可以继续创建我们的API！</p>
<h1><a class="header" href="#groupsversions-和-kinds-之间的关系" id="groupsversions-和-kinds-之间的关系">Groups、Versions 和 Kinds 之间的关系</a></h1>
<p>在开始编写 API 之前，让我们讨论一些关键术语</p>
<p>当描述 Kubernetes 中的 API 时，我们经常用到的四个术语是：<code>groups</code>、
<code>versions</code>、<code>kinds</code> 和 <code>resources</code></p>
<h2><a class="header" href="#groups-和-versions" id="groups-和-versions">Groups 和 Versions</a></h2>
<p>Kubernetes 中的 <code>API Group</code> 只是相关功能的集合, <strong>每个 <code>group</code> 包含一个或者多个 <code>versions</code></strong>, 这样的关系可以让我们随着时间的推移，通过创建不同的 <code>versions </code> 来更改 API 的工作方式。</p>
<h2><a class="header" href="#kinds-和-resources" id="kinds-和-resources">Kinds 和 Resources</a></h2>
<h3><a class="header" href="#kinds" id="kinds">Kinds</a></h3>
<p><strong>每个 <code>API group-version</code> 包含一个或者多个 API 类型, 我们称之为 <code>Kinds</code></strong>.
虽然同类型 <code>Kind</code> 在不同的 <code>version</code> 之间的表现形式可能不同，但是同类型 <code>Kind</code> 必须能够存储其他 <code>Kind</code> 的全部数据，也就是说同类型 <code>Kind</code> 之间必须是互相兼容的(我们可以把数据存到 fields 或者 annotations)，这样当你使用老版本的 <code>API group-version</code> 时不会造成丢失或损坏, 有关更多信息，请参见<a href="https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md">Kubernetes API指南</a>。</p>
<aside class="note">
<h1><a class="header" href="#自己的理解" id="自己的理解">自己的理解</a></h1>
<p>通常部署到 k8s 集群中的 YAML 文件前几行格式如下, 其中<code>extensions/v1beta1</code> 就是 <code>API group-version</code>、<code>extensions</code> 是 <code>Group</code>、 <code>v1beta1</code> 是 <code>version</code>、 <code>Deployment</code> 是 <code>Kind</code>。</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
</code></pre>
</aside>
<h3><a class="header" href="#resources" id="resources">Resources</a></h3>
<p>你应该听别人提到过 <code>Resources</code>， <code>Resource</code> 是 <code>Kind</code> 在 API 中的标识，通常情况下 <code>Kind</code> 和 <code>Resource</code> 是一一对应的, 但是有时候相同的 <code>Kind</code> 可能对应多个 <code>Resources</code>, 比如 Scale Kind 可能对应很多 Resources：deployments/scale 或者 replicasets/scale, 但是在 CRD 中，每个 <code>Kind</code> 只会对应一种 <code>Resource</code>。</p>
<p>请注意，<code>Resource</code> 始终是小写形式，并且通常情况下是 <code>Kind</code> 的小写形式。
具体对应关系可以查看 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fyq.aliyun.com%2Fgo%2FarticleRenderRedirect%3Furl%3Dhttps%253A%252F%252Fkubernetes.io%252Fdocs%252Freference%252Fkubectl%252Foverview%252F%2523resource-types">resource type</a>。</p>
<aside class="note">
<h1><a class="header" href="#自己的理解-1" id="自己的理解-1">自己的理解</a></h1>
<p>当我们使用 kubectl 操作 API 时，操作的就是 <code>Resource</code>，比如 <code>kubectl get pods</code>, 这里的 <code>pods</code> 就是指 <code>Resource</code>。</p>
<p>而我们在编写 YAML 文件时，会编写类似 <code>Kind: Pod</code> 这样的内容，这里 <code>Pod</code> 就是 <code>Kind</code></p>
</aside>
<h2><a class="header" href="#那么以上类型在框架中是如何定义的呢" id="那么以上类型在框架中是如何定义的呢">那么以上类型在框架中是如何定义的呢</a></h2>
<p>当我们在一个特定的 <code>group-version</code>中使用 <code>Kind</code> 时，我们称它为 <code>GroupVersionKind</code>, 简称 <code>GVK</code>, 同样的 <code>resources</code> 我们称它为 <code>GVR</code>。
稍后我们将看到每个 <code>GVK</code> 都对应一个 root Go type (比如：Deployment 就关联着 K8s 源码里面 k8s.io/api/apps/v1 package 中的 Deployment struct)。</p>
<p>现在我们已经熟悉了一些关键术语，那么我们可以开始创建我们的 API 了！</p>
<h2><a class="header" href="#额-但是-scheme-是什么东东" id="额-但是-scheme-是什么东东">额, 但是 Scheme 是什么东东?</a></h2>
<p><code>Scheme</code> 提供了 <code>GVK</code> 与对应 Go types(struct) 之间的映射（请不要和 <a href="https://godoc.org/k8s.io/apimachinery/pkg/runtime#Scheme">godocs</a> 中的 Scheme 混淆）</p>
<p>也就是说给定 Go type 就可以获取到它的 GVK，给定 GVK 可以获取到它的 Go type</p>
<p>例如，让我们假设 <code>tutorial.kubebuilder.io/api/v1/cronjob_types.go</code> 中的 <code>CronJob</code> 结构体在 <code>batch.tutorial.kubebuilder.io/v1</code>  API group 中（也就是说，假设这个 API group 有一种 Kind：<code>CronJob</code>，并且已经注册到 Api Server 中）</p>
<p>那么我们可以从 Api Server 获取到数据并反序列化至 <code>&amp;CronJob{}</code>中，那么结果会是如下格式:</p>
<pre><code class="language-json">{
    &quot;kind&quot;: &quot;CronJob&quot;,
    &quot;apiVersion&quot;: &quot;batch.tutorial.kubebuilder.io/v1&quot;,
    ...
}
</code></pre>
<p><em>ps：这里翻译的不好，请继续向后看，慢慢就理解了 ：）</em></p>
<h1><a class="header" href="#创建一个-api-1" id="创建一个-api-1">创建一个 API</a></h1>
<p>创建一个新的 Kind (你还记得<a href="cronjob-tutorial/./gvks.html#kinds-and-resources">上一章</a>的内容, 对吗?)和相应的 controller，我们可以使用<code> kubebuilder create api</code> 命令:</p>
<pre><code class="language-bash">kubebuilder create api --group batch --version v1 --kind CronJob
</code></pre>
<p>当我们第一次执行这个命令时，它会为创建一个新的 <code>group-version</code> 目录</p>
<p>在这里，<a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/api/v1"><code>api/v1/</code></a> 这个目录会被创建, 对应的 <code>group-version</code> 是 <code>batch.tutorial.kubebuilder.io/v1</code> (还记得我们一开始设置的<a href="cronjob-tutorial/cronjob-tutorial.html#scaffolding-out-our-project"><code>--domain</code>
setting</a>) 参数么)</p>
<p>它也会创建 <code>api/v1/cronjob_types.go</code> 文件并添加  <code>CronJob Kind</code>, 每次我们运行这个命令但是指定不同的 <code>Kind</code> 时, 他都会为我们创建一个 <code>xxx_types.go</code> 文件。</p>
<p>先让我们看看我们得到了什么开箱即用的东西，然后我们就开始填写它。</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/emptyapi-cn.go">emptyapi-cn.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<p>最开始我们导入了 <code>meta/v1</code> 库，该库通常不会直接使用，但是它包含了 Kubernetes 所有 kind 的 metadata 结构体类型。</p>
<pre><code class="language-go">package v1

import (
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
)
</code></pre>
<p>下一步，我们为我们的 Kind 定义 Spec(<code>CronJobSpec</code>) 和 Status(<code>CronJobStatus</code>) 的类型。
Kubernetes 的功能是将期望状态(<code>Spec</code>)与集群实际状态(其他对象的<code>Status</code>)和外部状态进行协调。
然后记录下观察到的状态（<code>Status</code>）。
因此，每个具有功能的对象都包含 <code>Spec</code> 和 <code>Status</code> 。
但是 ConfigMap 之类的一些类型不遵循此模式，因为它们不会维护一种状态，但是大多数类型都需要。</p>
<pre><code class="language-go">// EDIT THIS FILE!  THIS IS SCAFFOLDING FOR YOU TO OWN!
// NOTE: json tags are required.  Any new fields you add must have json tags for the fields to be serialized.

// CronJobSpec defines the desired state of CronJob
type CronJobSpec struct {
	// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
	// Important: Run &quot;make&quot; to regenerate code after modifying this file
}

// CronJobStatus defines the observed state of CronJob
type CronJobStatus struct {
	// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
	// Important: Run &quot;make&quot; to regenerate code after modifying this file
}
</code></pre>
<p><span id="moment"></span></p>
<p>然后，我们定义了 Kinds 对应的结构体类型，<code>CronJob</code> 和 <code>CronJobList</code>。
<code>CronJob</code> 是我们的 root type，用来描述 <code>CronJob Kind</code>。和所有 Kubernetes 对象一样，
它包含 <code>TypeMeta</code> (用来定义 API version 和 Kind) 和 <code>ObjectMeta</code> (用来定义 name、namespace 和 labels等一些字段)</p>
<p><code>CronJobList</code> 包含了一个 <code>CronJob</code> 的切片，它是用来批量操作 <code>Kind</code> 的，比如 LIST 操作</p>
<p>通常，我们不会修改它们 -- 所有的修改都是在 Spec 和 Status 上进行的。</p>
<p><code>+kubebuilder:object:root</code> 注释称为标记(marker)。
稍后我们还会看到更多它们，它们提供了一些元数据，
来告诉 <a href="https://github.com/kubernetes-sigs/controller-tools">controller-tools</a>(我们的代码和 YAML 生成器) 一些额外的信息。
这个注释告诉 <code>object</code> 这是一种 <code>Kind</code>。
然后，<code>object</code> 生成器会为我们生成 <a href="https://godoc.org/k8s.io/apimachinery/pkg/runtime#Object">runtime.Object</a> 接口的实现，
这是所有 Kinds 必须实现的接口。</p>
<pre><code class="language-go">// +kubebuilder:object:root=true

// CronJob is the Schema for the cronjobs API
type CronJob struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   CronJobSpec   `json:&quot;spec,omitempty&quot;`
	Status CronJobStatus `json:&quot;status,omitempty&quot;`
}

// +kubebuilder:object:root=true

// CronJobList contains a list of CronJob
type CronJobList struct {
	metav1.TypeMeta `json:&quot;,inline&quot;`
	metav1.ListMeta `json:&quot;metadata,omitempty&quot;`
	Items           []CronJob `json:&quot;items&quot;`
}
</code></pre>
<p>最后，我们将 Kinds 注册到 API group 中。这使我们可以将此 API group 中的 Kind 添加到任何 <a href="https://godoc.org/k8s.io/apimachinery/pkg/runtime#Scheme">Scheme</a> 中。</p>
<pre><code class="language-go">func init() {
	SchemeBuilder.Register(&amp;CronJob{}, &amp;CronJobList{})
}
</code></pre>
</div>
<p>现在，我们已经认识了基础的结构体，下一步我们开始填写它们！</p>
<h1><a class="header" href="#设计一个-api" id="设计一个-api">设计一个 API</a></h1>
<p>在 Kubernetes 中，我们有一些设计 API 的规范。比如：所有可序列化字段必须是<code>camelCase</code>(驼峰) 格式，所以我们使用 JSON 的 tags 去指定它们，当一个字段可以为空时，我们会用 <code>omitempty</code> tag 去标记它。</p>
<p>字段类型大多是原始数据类型，Numbers 类型比较特殊：处于兼容性的考虑，numbers 类型只接受三种数据类型：整形只能使用 <code>int32</code> 和 <code>int64</code> 声明, 小数只能使用 <code>resource.Quantity</code> 声明</p>
<details><summary>我的天, Quantity 又是什么鬼</summary>
<p>Quantity 是十进制数字的一种特殊表示法，具有明确固定的表示形式，使它们在计算机之间更易于移植。在Kubernetes中指定资源请求和Pod的限制时，您可能已经注意到它们。</p>
<p>从概念上讲，它们的工作方式类似于浮点数：它们具有有效位数，基数和指数。它们的可序列化和人类可读格式使用整数和后缀来指定值，这与我们描述计算机存储的方式非常相似。</p>
<p>例如，该值2m表示0.002十进制表示法。 2Ki 表示2048十进制，而2K表示2000十进制。如果要指定分数，请切换到一个后缀，该后缀使我们可以使用整数：2.5is 2500m。</p>
<p>支持两个基数：10和2（分别称为十进制和二进制）。十进制基数用“常规” SI后缀（例如 M和K）表示，而二进制基数用“ mebi”表示法（例如Mi 和Ki）指定。想想<a href="https://en.wikipedia.org/wiki/Binary_prefix">megabytes vs
mebibytes</a>。</p>
</details>
<p>我们还使用了另一种特殊类型：<code>metav1.Time</code>。它除了格式在 Kubernetes 中比较通用外，功能与 <code> time.Time</code> 完全相同。</p>
<p>顺便让我们看一下 CronJob object 的内容！</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/api/v1/cronjob_types.go">project/api/v1/cronjob_types.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<pre><code class="language-go">package v1

import (
	batchv1beta1 &quot;k8s.io/api/batch/v1beta1&quot;
	corev1 &quot;k8s.io/api/core/v1&quot;
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
)

// EDIT THIS FILE!  THIS IS SCAFFOLDING FOR YOU TO OWN!
// NOTE: json tags are required.  Any new fields you add must have json tags for the fields to be serialized.
</code></pre>
</details>
<p>首先，让我们看一下 <code>spec</code>，如我们之前说的，<code>spec</code> 表明<strong>期望的状态</strong>，所以有关 controller 的任何 “inputs” 都在这里声明。</p>
<p>一个基本的 CronJob 需要以下功能：</p>
<ul>
<li>一个 schedule(调度器) -- (CronJob 中的 “Cron”)</li>
<li>用来运行 Job 的模板 -- (CronJob 中的 “Job”)</li>
</ul>
<p>为了让用户体现更好，我们也需要一些额外的功能：</p>
<ul>
<li>一个截止时间（<code>StartingDeadlineSeconds</code>）, 如果错过了这个截止时间，Job 将会等到下一个调度时间点再被调度。</li>
<li>如果多个 Job 同时启动要怎么做（<code>ConcurrencyPolicy</code>）（等待？停掉最老的一个？还是同时运行？）</li>
<li>一个暂停(<code>Suspend</code>)功能，以防止 Job 在运行过程中出现什么错误。</li>
<li>限制历史 Job 的数量（<code>SuccessfulJobsHistoryLimit</code>）</li>
</ul>
<p>请记住，因为 job 不会读取自己的状态，所以我们需要用一些方式去跟踪一个 job 是否运行，
我们可以用至少一个 old job 来完成这个功能。（不明白，回头再改）</p>
<p>我们会用几个标记 (<code>// +comment</code>) 去定义一些额外的数据，这些标记在
<a href="https://github.com/kubernetes-sigs/controller-tools">controller-tools</a>
生成 CRD manifest 时会被使用。
稍后我们还将看到，controller-tools 还会使用 GoDoc 来为字段生成描述信息。</p>
<pre><code class="language-go">// CronJobSpec defines the desired state of CronJob
type CronJobSpec struct {
	// +kubebuilder:validation:MinLength=0

	// The schedule in Cron format, see https://en.wikipedia.org/wiki/Cron.
	Schedule string `json:&quot;schedule&quot;`

	// +kubebuilder:validation:Minimum=0

	// Optional deadline in seconds for starting the job if it misses scheduled
	// time for any reason.  Missed jobs executions will be counted as failed ones.
	// +optional
	StartingDeadlineSeconds *int64 `json:&quot;startingDeadlineSeconds,omitempty&quot;`

	// Specifies how to treat concurrent executions of a Job.
	// Valid values are:
	// - &quot;Allow&quot; (default): allows CronJobs to run concurrently;
	// - &quot;Forbid&quot;: forbids concurrent runs, skipping next run if previous run hasn't finished yet;
	// - &quot;Replace&quot;: cancels currently running job and replaces it with a new one
	// +optional
	ConcurrencyPolicy ConcurrencyPolicy `json:&quot;concurrencyPolicy,omitempty&quot;`

	// This flag tells the controller to suspend subsequent executions, it does
	// not apply to already started executions.  Defaults to false.
	// +optional
	Suspend *bool `json:&quot;suspend,omitempty&quot;`

	// Specifies the job that will be created when executing a CronJob.
	JobTemplate batchv1beta1.JobTemplateSpec `json:&quot;jobTemplate&quot;`

	// +kubebuilder:validation:Minimum=0

	// The number of successful finished jobs to retain.
	// This is a pointer to distinguish between explicit zero and not specified.
	// +optional
	SuccessfulJobsHistoryLimit *int32 `json:&quot;successfulJobsHistoryLimit,omitempty&quot;`

	// +kubebuilder:validation:Minimum=0

	// The number of failed finished jobs to retain.
	// This is a pointer to distinguish between explicit zero and not specified.
	// +optional
	FailedJobsHistoryLimit *int32 `json:&quot;failedJobsHistoryLimit,omitempty&quot;`
}
</code></pre>
<p>我们自定义了一个类型（<code>ConcurrencyPolicy</code>）来保存我们的并发策略。
它实际上只是一个字符串，但是这个类型名称提供了额外的说明，
我们还将验证附加到类型上,而不是字段上，从而使验证更易于重用。</p>
<pre><code class="language-go">// ConcurrencyPolicy describes how the job will be handled.
// Only one of the following concurrent policies may be specified.
// If none of the following policies is specified, the default one
// is AllowConcurrent.
// +kubebuilder:validation:Enum=Allow;Forbid;Replace
type ConcurrencyPolicy string

const (
	// AllowConcurrent allows CronJobs to run concurrently.
	AllowConcurrent ConcurrencyPolicy = &quot;Allow&quot;

	// ForbidConcurrent forbids concurrent runs, skipping next run if previous
	// hasn't finished yet.
	ForbidConcurrent ConcurrencyPolicy = &quot;Forbid&quot;

	// ReplaceConcurrent cancels currently running job and replaces it with a new one.
	ReplaceConcurrent ConcurrencyPolicy = &quot;Replace&quot;
)
</code></pre>
<p>下面，让我们设计 <code>status</code>,它用来存储观察到的状态。它包含我们希望用户或其他 controllers 能够获取的所有信息</p>
<p>我们将保留一份正在运行的 Job 列表，以及上一次成功运行 Job 的列表。
注意，如上所述，我们使用 metav1.Time 而不是 time.Time 来获得稳定的序列化。</p>
<pre><code class="language-go">// CronJobStatus defines the observed state of CronJob
type CronJobStatus struct {
	// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
	// Important: Run &quot;make&quot; to regenerate code after modifying this file

	// A list of pointers to currently running jobs.
	// +optional
	Active []corev1.ObjectReference `json:&quot;active,omitempty&quot;`

	// Information when was the last time the job was successfully scheduled.
	// +optional
	LastScheduleTime *metav1.Time `json:&quot;lastScheduleTime,omitempty&quot;`
}
</code></pre>
<p><span id="installation"></span>
最后我们只剩下了 <code>CronJob</code> 结构体，如之前说的，我们不需要修改改结构体的任何内容，
但是我们希望操作改 Kind 像操作 Kubernetes 内置资源一样，所以我们需要增加一个 mark <code>+kubebuilder:subresource:status</code>,
来声明一个status subresource, 关于 subresource 的更多信息可以参考
<a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#subresources">k8s 文档</a></p>
<pre><code class="language-go">// +kubebuilder:object:root=true
// +kubebuilder:subresource:status

// CronJob is the Schema for the cronjobs API
type CronJob struct {
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Root Object Definitions</span></pre></summary>
<pre><code class="language-go">	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   CronJobSpec   `json:&quot;spec,omitempty&quot;`
	Status CronJobStatus `json:&quot;status,omitempty&quot;`
}

// +kubebuilder:object:root=true

// CronJobList contains a list of CronJob
type CronJobList struct {
	metav1.TypeMeta `json:&quot;,inline&quot;`
	metav1.ListMeta `json:&quot;metadata,omitempty&quot;`
	Items           []CronJob `json:&quot;items&quot;`
}

func init() {
	SchemeBuilder.Register(&amp;CronJob{}, &amp;CronJobList{})
}
</code></pre>
</details></div>
<p>现在，我们已经有了一个 API，然后我们需要编写一个 controller 来实现具体功能。</p>
<h1><a class="header" href="#简要说明-其他文件是干什么的" id="简要说明-其他文件是干什么的">简要说明: 其他文件是干什么的?</a></h1>
<p><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/api/v1"><code>api/v1/</code></a>目录下除 <code>cronjob_types.go</code> 外还有另外两个文件：<code>groupversion_info.go</code>  和  <code>zz_generated.deepcopy.go</code>。</p>
<p>这两个文件都不需要编辑(前者保持不变，后者是自动生成的), 但是知道其中有什么是非常有用的。</p>
<h2><a class="header" href="#groupversion_infogo" id="groupversion_infogo"><code>groupversion_info.go</code></a></h2>
<p><code>groupversion_info.go</code> 包含和 group-version 有关的元数据:</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/api/v1/groupversion_info.go">project/api/v1/groupversion_info.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<p>首先，我们有一些 <code>package-level</code> 的标记，<code>+kubebuilder:object:generate=true</code> 表示该程序包中有 Kubernetes 对象，
<code>+groupName=batch.tutorial.kubebuilder.io</code> 表示该程序包的 Api group 是 <code>batch.tutorial.kubebuilder.io</code>。
<code>object</code> 生成器使用前者，而 CRD 生成器使用后者, 来为由此包创建的 CRD 生成正确的元数据。</p>
<pre><code class="language-go">// Package v1 contains API Schema definitions for the batch v1 API group
// +kubebuilder:object:generate=true
// +groupName=batch.tutorial.kubebuilder.io
package v1

import (
	&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/scheme&quot;
)
</code></pre>
<p>然后，我们定义一些全局变量帮助我们建立 Scheme。
由于我们需要在 controller 中使用此程序包中的所有 types，
因此需要一种方便的方法（或约定）可以将所有 types 添加到其他 <code>Scheme</code> 中。
<code>SchemeBuilder</code> 让我们做这件事情变的容易。</p>
<pre><code class="language-go">var (
	// GroupVersion is group version used to register these objects
	GroupVersion = schema.GroupVersion{Group: &quot;batch.tutorial.kubebuilder.io&quot;, Version: &quot;v1&quot;}

	// SchemeBuilder is used to add go types to the GroupVersionKind scheme
	SchemeBuilder = &amp;scheme.Builder{GroupVersion: GroupVersion}

	// AddToScheme adds the types in this group-version to the given scheme.
	AddToScheme = SchemeBuilder.AddToScheme
)
</code></pre>
</div>
<h2><a class="header" href="#zz_generateddeepcopygo" id="zz_generateddeepcopygo"><code>zz_generated.deepcopy.go</code></a></h2>
<p><code>zz_generated.deepcopy.go</code> 包含<a href="cronjob-tutorial/new-api.html#moment">之前所说的</a>由 <code>+kubebuilder:object:root</code>自动生成的 <code>runtime.Object</code> 接口的实现。</p>
<p><code>runtime.Object</code> interface 的核心是一个 deep-copy 方法：<code>DeepCopyObject</code>。</p>
<p>controller-tools 中的 <code>object</code> 生成器也为每个 root type(<code>CronJob</code>) 和他的 sub-types(<code>CronJobList,CronJobSpec,CronJob1Status</code>) 都生成了两个方法：<code>DeepCopy</code>  和 <code>DeepCopyInto</code></p>
<h1><a class="header" href="#controller-中有什么" id="controller-中有什么">controller 中有什么?</a></h1>
<p><code>Controllers</code> 是 operator 和 Kubernetes 的核心组件。</p>
<p>controller 的职责是确保实际的状态（包括群集状态，以及潜在的外部状态，例如正在运行的 Kubelet 容器和云提供商的 loadbalancers）与给定 object 期望的状态相匹配。
每个 controller 专注于一个 <code>root Kind</code>，但也可以与其他 <code>Kinds</code> 进行交互。</p>
<p>这种努力达到期望状态的过程，我们称之为 <code>reconciling</code>(调和，使...一直)。</p>
<p>在 controller-runtime 库中，实现 Kind reconciling 的逻辑我们称为
<a href="https://godoc.org/sigs.k8s.io/controller-runtime/pkg/reconcile"><em>Reconciler</em></a>。
<code>reconciler</code> 获取对象的名称并返回是否需要重试(例如: 发生错误或是一些周期性的 controllers，像 HorizontalPodAutoscale)。</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/emptycontroller.go">emptycontroller.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<p>首先，我们会 import 一些标准库。和以前一样，我们需要 <code>controller-runtime</code> 库，client 包以及我们定义的有关 API 类型的软件包。</p>
<pre><code class="language-go">package controllers

import (
	&quot;context&quot;

	&quot;github.com/go-logr/logr&quot;
	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;

	batchv1 &quot;tutorial.kubebuilder.io/project/api/v1&quot;
)
</code></pre>
<p>接下来，kubebuilder 为我们搭建了一个基本的 <code>reconciler</code> 结构体。
几乎每个 <code>reconciler</code> 都需要记录日志，并且需要能够获取对象，因此这个结构体是开箱即用的。</p>
<pre><code class="language-go">// CronJobReconciler reconciles a CronJob object
type CronJobReconciler struct {
	client.Client
	Log    logr.Logger
	Scheme *runtime.Scheme
}
</code></pre>
<p>大多数 controllers 最终都会运行在 k8s 集群上，因此它们需要 RBAC 权限,
我们使用 controller-tools <a href="cronjob-tutorial//reference/markers/rbac.html">RBAC markers</a> 指定了这些权限。
这是运行所需的最小权限。
随着我们添加更多功能，我们将会重新定义这些权限。</p>
<pre><code class="language-go">// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=get;list;watch;create;update;patch;delete
// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs/status,verbs=get;update;patch
</code></pre>
<p><code>Reconcile</code> 方法对个某个单一的 object 执行 <code>reconciling</code> 动作，
我们的 <a href="https://godoc.org/sigs.k8s.io/controller-runtime/pkg/reconcile#Request">Request</a>只是一个 name，
但是 client 可以通过 name 信息从 cache 中获取到对应的 object。</p>
<p>我们返回的 result 为空，且 error 为 nil，
这表明 controller-runtime 已经成功 reconciled 了这个 object，无需进行任何重试，直到这个 object 被更改。</p>
<p>大多数 controller 都需要一个 logging handle 和一个 context，因此我们在这里进行了设置。</p>
<p><a href="https://golang.org/pkg/context/">context</a> 是用于允许取消请求或者用于跟踪之类的事情。
这是所有 client 方法的第一个参数。
<code>Background</code> context 只是一个 basic context，没有任何额外的数据或时间限制。</p>
<p>logging handle 用于记录日志, controller-runtime 通过 <a href="https://github.com/go-logr/logr">logr</a> 库结构化日志记录。
稍后我们将看到，日志记录通过将 key-value 添加到静态消息中而起作用。
我们可以在 reconcile 方法的顶部提前分配一些 key-value ,以便查找在这个 reconciler 中所有的日志</p>
<pre><code class="language-go">func (r *CronJobReconciler) Reconcile(req ctrl.Request) (ctrl.Result, error) {
	_ = context.Background()
	_ = r.Log.WithValues(&quot;cronjob&quot;, req.NamespacedName)

	// your logic here

	return ctrl.Result{}, nil
}
</code></pre>
<p>最后，我们将此 reconciler 加到 manager，以便在启动 manager 时启动 reconciler。</p>
<p>现在，我们仅记录了 reconciler 在 <code>CronJob</code> 上的动作。稍后，我们将使用它来标记我们关心的 objects。</p>
<pre><code class="language-go">func (r *CronJobReconciler) SetupWithManager(mgr ctrl.Manager) error {
	return ctrl.NewControllerManagedBy(mgr).
		For(&amp;batchv1.CronJob{}).
		Complete(r)
}
</code></pre>
</div>
<p>现在，我们已经看到了 controller 的基本结构，下一步让我们来填写 <code>CronJob</code> 的逻辑</p>
<h1><a class="header" href="#实现一个-controller" id="实现一个-controller">实现一个 controller</a></h1>
<p>我们的 CronJob controller 的基本逻辑是：</p>
<ol>
<li>
<p>加载 CronJob</p>
</li>
<li>
<p>列出所有 active jobs，并更新状态</p>
</li>
<li>
<p>根据历史记录清理 old jobs</p>
</li>
<li>
<p>检查 Job 是否已被 suspended（如果被 suspended，请不要执行任何操作）</p>
</li>
<li>
<p>获取到下一次要 schedule 的 Job</p>
</li>
<li>
<p>运行新的 Job, 确定新 Job 没有超过 deadline 时间，且不会被我们 concurrency 规则 block</p>
</li>
<li>
<p>如果 Job 正在运行或者它应该下次运行，请重新排队</p>
</li>
</ol>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/controllers/cronjob_controller.go">project/controllers/cronjob_controller.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<p>我们从一些 import 开始，正如你看到的，我们使用的 package 比脚手架帮我们生成的多，在使用它们时，我们会逐一讨论。</p>
<pre><code class="language-go">package controllers

import (
	&quot;context&quot;
	&quot;fmt&quot;
	&quot;sort&quot;
	&quot;time&quot;

	&quot;github.com/go-logr/logr&quot;
	&quot;github.com/robfig/cron&quot;
	kbatch &quot;k8s.io/api/batch/v1&quot;
	corev1 &quot;k8s.io/api/core/v1&quot;
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	ref &quot;k8s.io/client-go/tools/reference&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;

	batch &quot;tutorial.kubebuilder.io/project/api/v1&quot;
)
</code></pre>
<p>接下来，我们需要一个 Clock 字段，它帮我们在测试中伪装计时。</p>
<pre><code class="language-go">// CronJobReconciler reconciles a CronJob object
type CronJobReconciler struct {
	client.Client
	Log    logr.Logger
	Scheme *runtime.Scheme
	Clock
}
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Clock</span></pre></summary>
<p>我们模拟时钟，以便在测试时更容易跳转，
<code>realClock</code> 只是调用了 <code>time.Now</code> 函数。</p>
<pre><code class="language-go">type realClock struct{}

func (_ realClock) Now() time.Time { return time.Now() }

// clock 知道如何获取当前时间
//它可以用来在测试时伪造时间。
type Clock interface {
	Now() time.Time
}
</code></pre>
</details>
<p>请注意，我们需要更多的 RBAC 权限 -- 由于我们现在正在创建和管理 Job，因此我们需要这些权限，
这意味着要添加更多 <a href="cronjob-tutorial//reference/markers/rbac.html">markers</a>，所以我们增加了最下面两行。</p>
<pre><code class="language-go">// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=get;list;watch;create;update;patch;delete
// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs/status,verbs=get;update;patch
// +kubebuilder:rbac:groups=batch,resources=jobs,verbs=get;list;watch;create;update;patch;delete
// +kubebuilder:rbac:groups=batch,resources=jobs/status,verbs=get
</code></pre>
<p>现在， 我们到了 controller 的核心部分 -- 实现 reconciler 的逻辑</p>
<pre><code class="language-go">var (
	scheduledTimeAnnotation = &quot;batch.tutorial.kubebuilder.io/scheduled-at&quot;
)

func (r *CronJobReconciler) Reconcile(req ctrl.Request) (ctrl.Result, error) {
	ctx := context.Background()
	log := r.Log.WithValues(&quot;cronjob&quot;, req.NamespacedName)
</code></pre>
<pre><code>### 1: 按 namespace 加载 CronJob

我们使用 client 获取 CronJob。
所有的 client 方法都将 context（用来取消请求）作为其第一个参数，
并将所讨论的 object 作为其最后一个参数。 Get 方法有点特殊，
因为它使用 [`NamespacedName`](https://godoc.org/sigs.k8s.io/controller-runtime/pkg/client#ObjectKey)
作为中间参数（大多数没有中间参数，如下所示）。

最后，许多 client 方法也采用可变参数选项(也就是 &quot;...&quot;)。
</code></pre>
<pre><code class="language-go">	var cronJob batch.CronJob
	if err := r.Get(ctx, req.NamespacedName, &amp;cronJob); err != nil {
		log.Error(err, &quot;unable to fetch CronJob&quot;)
		// we'll ignore not-found errors, since they can't be fixed by an immediate
		// requeue (we'll need to wait for a new notification), and we can get them
		// on deleted requests.
		return ctrl.Result{}, client.IgnoreNotFound(err)
	}
</code></pre>
<pre><code>### 2: 列出所有 active jobs，并更新状态
要完全更新我们的状态，我们需要列出此 namespace 中属于此 CronJob 的所有 Job。
与 Get 方法类似，我们可以使用 List 方法列出 Job。
注意，我们使用可变参数选项来设置 `client.InNamespace` 和 `client.MatchingFields`。
</code></pre>
<pre><code class="language-go">	var childJobs kbatch.JobList
	if err := r.List(ctx, &amp;childJobs, client.InNamespace(req.Namespace), client.MatchingFields{jobOwnerKey: req.Name}); err != nil {
		log.Error(err, &quot;unable to list child Jobs&quot;)
		return ctrl.Result{}, err
	}
</code></pre>
<pre><code>当得到所有的 Job 后，我们把 Job 的状态分为 active、successful和 failed,
并跟踪他们最近的运行情况，以便将其记录在 status 中。
请记住，status 应该可以从整体的状态重新构造，
因此从 root object 的状态读取信息通常不是一个好主意。
相反，您应该在每次运行时重新构建它。
这就是我们在这里要做的。

我们可以使用 status conditions 来检查作业是“完成”、成功或失败。
我们将把这种逻辑放在匿名函数中，以使我们的代码更整洁。
</code></pre>
<pre><code class="language-go">	// 查找状态为 active 的 Jobs
	var activeJobs []*kbatch.Job
	var successfulJobs []*kbatch.Job
	var failedJobs []*kbatch.Job
	var mostRecentTime *time.Time // 找到最后一次运行 Job，以便我们更新状态
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">isJobFinished</span></pre></summary>
<pre><code>如果一项工作的 &quot;succeeded&quot; 或 &quot;failed&quot; 的 Conditions 标记为 &quot;true&quot;，我们认为该工作 &quot;finished&quot;。
`Status.conditions` 使我们可以向 objects 添加可扩展的状态信息，
其他人和 controller 可以通过检查这些状态信息以确定 Job 完成和健康状况。
</code></pre>
<pre><code class="language-go">	isJobFinished := func(job *kbatch.Job) (bool, kbatch.JobConditionType) {
		for _, c := range job.Status.Conditions {
			if (c.Type == kbatch.JobComplete || c.Type == kbatch.JobFailed) &amp;&amp; c.Status == corev1.ConditionTrue {
				return true, c.Type
			}
		}

		return false, &quot;&quot;
	}
</code></pre>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">getScheduledTimeForJob</span></pre></summary>
<p>我们将使用匿名函数从创建 Job 时添加的 annotation 中获取到 Job 计划执行的时间。</p>
<pre><code class="language-go">	getScheduledTimeForJob := func(job *kbatch.Job) (*time.Time, error) {
		timeRaw := job.Annotations[scheduledTimeAnnotation]
		if len(timeRaw) == 0 {
			return nil, nil
		}

		timeParsed, err := time.Parse(time.RFC3339, timeRaw)
		if err != nil {
			return nil, err
		}
		return &amp;timeParsed, nil
	}
</code></pre>
</details>
<pre><code class="language-go">	// 根据 Job 的状态将 Job 放到不同的切片中, 并获得最近一个 Job
	for i, job := range childJobs.Items {
		_, finishedType := isJobFinished(&amp;job)
		switch finishedType {
		case &quot;&quot;: // ongoing
			activeJobs = append(activeJobs, &amp;childJobs.Items[i])
		case kbatch.JobFailed:
			failedJobs = append(failedJobs, &amp;childJobs.Items[i])
		case kbatch.JobComplete:
			successfulJobs = append(successfulJobs, &amp;childJobs.Items[i])
		}

		// 把运行时间存在 annotation，以便我们重新获取他们
		scheduledTimeForJob, err := getScheduledTimeForJob(&amp;job)
		if err != nil {
			log.Error(err, &quot;unable to parse schedule time for child job&quot;, &quot;job&quot;, &amp;job)
			continue
		}
		// 获取最后一个 Job
		if scheduledTimeForJob != nil {
			if mostRecentTime == nil {
				mostRecentTime = scheduledTimeForJob
			} else if mostRecentTime.Before(*scheduledTimeForJob) {
				mostRecentTime = scheduledTimeForJob
			}
		}
	}

	if mostRecentTime != nil {
		cronJob.Status.LastScheduleTime = &amp;metav1.Time{Time: *mostRecentTime}
	} else {
		cronJob.Status.LastScheduleTime = nil
	}
	cronJob.Status.Active = nil
	for _, activeJob := range activeJobs {
		jobRef, err := ref.GetReference(r.Scheme, activeJob)
		if err != nil {
			log.Error(err, &quot;unable to make reference to active job&quot;, &quot;job&quot;, activeJob)
			continue
		}
		cronJob.Status.Active = append(cronJob.Status.Active, *jobRef)
	}
</code></pre>
<p>在这里，我们将以略高的日志记录级别记录观察到的 Job 数量，以进行调试。
请注意，我们是使用固定消息在键值对中附加额外的信息，而不是使用字符串格式。
这样可以更轻松地过滤和查询日志行。</p>
<pre><code class="language-go">	log.V(1).Info(&quot;job count&quot;, &quot;active jobs&quot;, len(activeJobs), &quot;successful jobs&quot;, len(successfulJobs), &quot;failed jobs&quot;, len(failedJobs))
</code></pre>
<p>我们根据我们得到的时间更新 CRD 的状态。
和以前一样，我们使用 client。
为了更新 subresource 的状态，我们将使用 client 的 <code>Status().Update</code> 方法</p>
<p>subresource status 会忽略对 spec 的更改,
因此它与其他任何 update 发生冲突的可能性较小, 并且它可以具有单独的权限。</p>
<pre><code class="language-go">	if err := r.Status().Update(ctx, &amp;cronJob); err != nil {
		log.Error(err, &quot;unable to update CronJob status&quot;)
		return ctrl.Result{}, err
	}
</code></pre>
<p>一旦我们正确 update 了我们的 status，我们可以确保整体的状态是符合我们在 spec 中指定的。</p>
<h3><a class="header" href="#3-根据历史记录清理过期-jobs" id="3-根据历史记录清理过期-jobs">3: 根据历史记录清理过期 jobs</a></h3>
<p>首先，我们会尝试清理过期的 jobs，以免留下太多闲杂事。</p>
<pre><code class="language-go">	// 注意：这里是尽量删除，如果删除失败，我们不会为了删除让它们重新排队
	if cronJob.Spec.FailedJobsHistoryLimit != nil {
		// 把失败的 Job 按时间排序
		sort.Slice(failedJobs, func(i, j int) bool {
			if failedJobs[i].Status.StartTime == nil {
				return failedJobs[j].Status.StartTime != nil
			}
			return failedJobs[i].Status.StartTime.Before(failedJobs[j].Status.StartTime)
		})
		// 如果 failedJob 超出 FailedJobsHistoryLimit 就删掉
		for i, job := range failedJobs {
			if int32(i) &gt;= int32(len(failedJobs))-*cronJob.Spec.FailedJobsHistoryLimit {
				break
			}
			if err := r.Delete(ctx, job, client.PropagationPolicy(metav1.DeletePropagationBackground)); client.IgnoreNotFound(err) != nil {
				log.Error(err, &quot;unable to delete old failed job&quot;, &quot;job&quot;, job)
			} else {
				log.V(0).Info(&quot;deleted old failed job&quot;, &quot;job&quot;, job)
			}
		}
	}
	// 如果 successfulJob 超出 SuccessfulJobsHistoryLimit 就删掉
	if cronJob.Spec.SuccessfulJobsHistoryLimit != nil {
		sort.Slice(successfulJobs, func(i, j int) bool {
			if successfulJobs[i].Status.StartTime == nil {
				return successfulJobs[j].Status.StartTime != nil
			}
			return successfulJobs[i].Status.StartTime.Before(successfulJobs[j].Status.StartTime)
		})
		for i, job := range successfulJobs {
			if int32(i) &gt;= int32(len(successfulJobs))-*cronJob.Spec.SuccessfulJobsHistoryLimit {
				break
			}
			if err := r.Delete(ctx, job, client.PropagationPolicy(metav1.DeletePropagationBackground)); (err) != nil {
				log.Error(err, &quot;unable to delete old successful job&quot;, &quot;job&quot;, job)
			} else {
				log.V(0).Info(&quot;deleted old successful job&quot;, &quot;job&quot;, job)
			}
		}
	}
</code></pre>
<h3><a class="header" href="#4-检查-job-是否已被-suspended" id="4-检查-job-是否已被-suspended">4: 检查 Job 是否已被 suspended</a></h3>
<p>如果这个 object 已被 suspended，且我们不想运行任何其他 Jobs，我们会立即 return。
这对调试 Job 的问题非常有用。</p>
<pre><code class="language-go">	if cronJob.Spec.Suspend != nil &amp;&amp; *cronJob.Spec.Suspend {
		log.V(1).Info(&quot;cronjob suspended, skipping&quot;)
		return ctrl.Result{}, nil
	}
</code></pre>
<h3><a class="header" href="#5-获取到下一次要-schedule-的-job" id="5-获取到下一次要-schedule-的-job">5: 获取到下一次要 schedule 的 Job</a></h3>
<p>如果 Job 没有被暂停，则需要计算下一次 schedule 的 Job，以及是否有尚未处理的 Job。</p>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">getNextSchedule</span></pre></summary>
<pre><code>我们将使用有用的 cron 库来计算下一个 scheduled 时间。
我们将从上次 Job 开始的时间计算下一次运行的时间，如果找不到上次运行的时间，就创建一个 CronJob。

如果错过的 Job 数量太多，并且我们没有设置任何 deadlines，我们将释放这个 Job，
以免造成 controller 重启。

否则，我们将只返回错过的 Job（我们将使用最后一个运行的 Job）和下一次要运行的 Job，
以便让我们知道何时该重新进行 reconcile。
</code></pre>
<pre><code class="language-go">	getNextSchedule := func(cronJob *batch.CronJob, now time.Time) (lastMissed time.Time, next time.Time, err error) {
		sched, err := cron.ParseStandard(cronJob.Spec.Schedule)
		if err != nil {
			return time.Time{}, time.Time{}, fmt.Errorf(&quot;Unparseable schedule %q: %v&quot;, cronJob.Spec.Schedule, err)
		}

		// for optimization purposes, cheat a bit and start from our last observed run time
		// we could reconstitute this here, but there's not much point, since we've
		// just updated it.
		var earliestTime time.Time
		if cronJob.Status.LastScheduleTime != nil {
			earliestTime = cronJob.Status.LastScheduleTime.Time
		} else {
			earliestTime = cronJob.ObjectMeta.CreationTimestamp.Time
		}
		if cronJob.Spec.StartingDeadlineSeconds != nil {
			// controller is not going to schedule anything below this point
			schedulingDeadline := now.Add(-time.Second * time.Duration(*cronJob.Spec.StartingDeadlineSeconds))

			if schedulingDeadline.After(earliestTime) {
				earliestTime = schedulingDeadline
			}
		}
		if earliestTime.After(now) {
			return time.Time{}, sched.Next(now), nil
		}

		starts := 0
		for t := sched.Next(earliestTime); !t.After(now); t = sched.Next(t) {
			lastMissed = t
			// An object might miss several starts. For example, if
			// controller gets wedged on Friday at 5:01pm when everyone has
			// gone home, and someone comes in on Tuesday AM and discovers
			// the problem and restarts the controller, then all the hourly
			// jobs, more than 80 of them for one hourly scheduledJob, should
			// all start running with no further intervention (if the scheduledJob
			// allows concurrency and late starts).
			//
			// However, if there is a bug somewhere, or incorrect clock
			// on controller's server or apiservers (for setting creationTimestamp)
			// then there could be so many missed start times (it could be off
			// by decades or more), that it would eat up all the CPU and memory
			// of this controller. In that case, we want to not try to list
			// all the missed start times.
			starts++
			if starts &gt; 100 {
				// We can't get the most recent times so just return an empty slice
				return time.Time{}, time.Time{}, fmt.Errorf(&quot;Too many missed start times (&gt; 100). Set or decrease .spec.startingDeadlineSeconds or check clock skew.&quot;)
			}
		}
		return lastMissed, sched.Next(now), nil
	}
</code></pre>
</details>
<pre><code class="language-go">	// figure out the next times that we need to create
	// jobs at (or anything we missed).
	missedRun, nextRun, err := getNextSchedule(&amp;cronJob, r.Now())
	if err != nil {
		log.Error(err, &quot;unable to figure out CronJob schedule&quot;)
		// we don't really care about requeuing until we get an update that
		// fixes the schedule, so don't return an error
		return ctrl.Result{}, nil
	}
</code></pre>
<p>我们把下次执行 Job 的 object 存到 scheduledResult 变量中，知道下次需要需要执行的时间点，然后确定 Job 是否真的需要运行。</p>
<pre><code class="language-go">	scheduledResult := ctrl.Result{RequeueAfter: nextRun.Sub(r.Now())} // save this so we can re-use it elsewhere
	log = log.WithValues(&quot;now&quot;, r.Now(), &quot;next run&quot;, nextRun)
</code></pre>
<h3><a class="header" href="#6-运行新的-job-确定新-job-没有超过-deadline-时间且不会被我们-concurrency-规则-block" id="6-运行新的-job-确定新-job-没有超过-deadline-时间且不会被我们-concurrency-规则-block">6: 运行新的 Job, 确定新 Job 没有超过 deadline 时间，且不会被我们 concurrency 规则 block</a></h3>
<p>如果我们错过了一个 Job 的运行时间点，但是 Job 还在 deadline 时间内，我们需要再次运行这个 Job</p>
<pre><code class="language-go">	if missedRun.IsZero() {
		log.V(1).Info(&quot;no upcoming scheduled times, sleeping until next&quot;)
		return scheduledResult, nil
	}

	// 确地没有超过 StartingDeadlineSeconds 时间
	log = log.WithValues(&quot;current run&quot;, missedRun)
	tooLate := false
	if cronJob.Spec.StartingDeadlineSeconds != nil {
		tooLate = missedRun.Add(time.Duration(*cronJob.Spec.StartingDeadlineSeconds) * time.Second).Before(r.Now())
	}
	if tooLate {
		log.V(1).Info(&quot;missed starting deadline for last run, sleeping till next&quot;)
		// TODO(directxman12): events
		return scheduledResult, nil
	}
</code></pre>
<p>如果我们不得不运行一个 Job，那么需要等现有 Job 完成之后，替换现有 Job 或添加一个新 Job。
如果我们的信息由于 cache 的延迟而过时，那么我们将在获得 up-to-date 信息时重新排队。</p>
<pre><code class="language-go">	// 判断如何运行此 Job -- 并发策略可能会禁止我们同时运行多个 Job
	if cronJob.Spec.ConcurrencyPolicy == batch.ForbidConcurrent &amp;&amp; len(activeJobs) &gt; 0 {
		log.V(1).Info(&quot;concurrency policy blocks concurrent runs, skipping&quot;, &quot;num active&quot;, len(activeJobs))
		return scheduledResult, nil
	}

	// ...或者希望我们替换一个 Job...
	if cronJob.Spec.ConcurrencyPolicy == batch.ReplaceConcurrent {
		for _, activeJob := range activeJobs {
			// 我们不关心 Job 是否已经被删除
			if err := r.Delete(ctx, activeJob, client.PropagationPolicy(metav1.DeletePropagationBackground)); client.IgnoreNotFound(err) != nil {
				log.Error(err, &quot;unable to delete active job&quot;, &quot;job&quot;, activeJob)
				return ctrl.Result{}, err
			}
		}
	}
</code></pre>
<p>一旦弄清楚如何处理现有 Job，我们便会真正创建所需的 Job。</p>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">constructJobForCronJob</span></pre></summary>
<p>我们需要基于 CronJob 的 template 构建 Job, 我们将从 template 复制 spec，然后复制一些基本的字段。</p>
<p>然后，我们将设置 “scheduled time” annotation，
以便我们可以在每次 reconcile 时重新构造我们的 <code>LastScheduleTime</code> 字段。</p>
<p>最后，我们需要设置 owner reference。 这使 Kubernetes 垃圾收集器在删除 CronJob 时清理 Job，
并允许 controller-runtime 找出给定 Job 被更改（added，deleted，completes）时需要协调哪个 CronJob。</p>
<pre><code class="language-go">	constructJobForCronJob := func(cronJob *batch.CronJob, scheduledTime time.Time) (*kbatch.Job, error) {
		// We want job names for a given nominal start time to have a deterministic name to avoid the same job being created twice
		// 这里防止 Job 名称冲突
		name := fmt.Sprintf(&quot;%s-%d&quot;, cronJob.Name, scheduledTime.Unix())

		job := &amp;kbatch.Job{
			ObjectMeta: metav1.ObjectMeta{
				Labels:      make(map[string]string),
				Annotations: make(map[string]string),
				Name:        name,
				Namespace:   cronJob.Namespace,
			},
			Spec: *cronJob.Spec.JobTemplate.Spec.DeepCopy(),
		}
		for k, v := range cronJob.Spec.JobTemplate.Annotations {
			job.Annotations[k] = v
		}
		job.Annotations[scheduledTimeAnnotation] = scheduledTime.Format(time.RFC3339)
		for k, v := range cronJob.Spec.JobTemplate.Labels {
			job.Labels[k] = v
		}
		if err := ctrl.SetControllerReference(cronJob, job, r.Scheme); err != nil {
			return nil, err
		}

		return job, nil
	}
</code></pre>
</details>
<pre><code class="language-go">	// actually make the job...
	job, err := constructJobForCronJob(&amp;cronJob, missedRun)
	if err != nil {
		log.Error(err, &quot;unable to construct job from template&quot;)
		// don't bother requeuing until we get a change to the spec
		return scheduledResult, nil
	}

	// 在 k8s 集群上启动一个 Job Resource
	if err := r.Create(ctx, job); err != nil {
		log.Error(err, &quot;unable to create Job for CronJob&quot;, &quot;job&quot;, job)
		return ctrl.Result{}, err
	}

	log.V(1).Info(&quot;created Job for CronJob run&quot;, &quot;job&quot;, job)
</code></pre>
<h3><a class="header" href="#7-如果-job-正在运行或者它应该下次运行请重新排队" id="7-如果-job-正在运行或者它应该下次运行请重新排队">7: 如果 Job 正在运行或者它应该下次运行，请重新排队</a></h3>
<p>最后，我们将返回上面准备的结果，这表示我们想在下次运行的 Job 需要重新排队时使用。
这被视为 maximum deadline -- 如果两者之间有其他变化，例如我们的 Job 开始或完成，
或者我们得到一个修改信息，我们需要尽快 reconcile。</p>
<pre><code class="language-go">	// 当 Job 运行的时候把下次需要运行的 Job object 放到队列中，并更新状态
	return scheduledResult, nil
}
</code></pre>
<h3><a class="header" href="#setup" id="setup">Setup</a></h3>
<p>最后，我们将更新我们的设置。
为了使我们的 reconciler 可以按其 owner 快速查找 Jobs，我们需要一个 index。
我们声明一个 index key，以后可以与 client 一起使用它作为伪字段名称，然后描述如何从 Job 对象中提取 index key。
索引器将自动为我们处理 namespace，因此，如果 Job 有一个 CronJob owner，我们只需提取所有者名称。</p>
<p>此外，我们会通知 manager 该 controller 拥有一些 Jobs，
以便在作业发生更改，删除等情况时，它将自动在基础 CronJob 上调用 Reconcile。</p>
<pre><code class="language-go">var (
	jobOwnerKey = &quot;.metadata.controller&quot;
	apiGVStr    = batch.GroupVersion.String()
)

func (r *CronJobReconciler) SetupWithManager(mgr ctrl.Manager) error {
	// set up a real clock, since we're not in a test
	if r.Clock == nil {
		r.Clock = realClock{}
	}

	if err := mgr.GetFieldIndexer().IndexField(&amp;kbatch.Job{}, jobOwnerKey, func(rawObj runtime.Object) []string {
		// grab the job object, extract the owner...
		job := rawObj.(*kbatch.Job)
		owner := metav1.GetControllerOf(job)
		if owner == nil {
			return nil
		}
		// ...make sure it's a CronJob...
		if owner.APIVersion != apiGVStr || owner.Kind != &quot;CronJob&quot; {
			return nil
		}

		// ...and if so, return it
		return []string{owner.Name}
	}); err != nil {
		return err
	}

	return ctrl.NewControllerManagedBy(mgr).
		For(&amp;batch.CronJob{}).
		Owns(&amp;kbatch.Job{}).
		Complete(r)
}
</code></pre>
</div>
<p>很明显，我们现在有了一个可以运行 controller ，让我们针对集群进行测试，然后，如果我们没有任何问题，把它部署到集群中！
让我们针对集群进行测试，然后，如果我们没有任何问题，请对其进行部署！</p>
<h1><a class="header" href="#main-文件修改什么" id="main-文件修改什么">main 文件修改什么?</a></h1>
<p>还记得最开始我们说要<a href="cronjob-tutorial/./empty-main.html">回到  <code>main.go</code>
文件</a>么? 让我们看看 <code>main.go</code> 新增了什么。</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/main.go">project/main.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<pre><code class="language-go">package main

import (
	&quot;flag&quot;
	&quot;os&quot;

	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	clientgoscheme &quot;k8s.io/client-go/kubernetes/scheme&quot;
	_ &quot;k8s.io/client-go/plugin/pkg/client/auth/gcp&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/log/zap&quot;

	batchv1 &quot;tutorial.kubebuilder.io/project/api/v1&quot;
	&quot;tutorial.kubebuilder.io/project/controllers&quot;
	// +kubebuilder:scaffold:imports
)
</code></pre>
</details>
<p>首先要注意的是 kubebuilder 已将新 API group 的 package(<code>batchv1</code>）添加到我们的 scheme 中了。
这意味着我们可以在 controller 中使用这些对象了。</p>
<p>如果要使用任何其他 CRD，则必须以相同的方式添加其 scheme。
诸如 Job 之类的内置类型的 scheme 是由 <code>clientgoscheme</code> 添加的。</p>
<pre><code class="language-go">var (
	scheme   = runtime.NewScheme()
	setupLog = ctrl.Log.WithName(&quot;setup&quot;)
)

func init() {
	_ = clientgoscheme.AddToScheme(scheme)

	_ = batchv1.AddToScheme(scheme)
	// +kubebuilder:scaffold:scheme
}
</code></pre>
<p>另一处更改是 kubebuilder 添加了一个块代码，
该代码调用了我们的 CronJob controller 的 <code>SetupWithManager</code> 方法。</p>
<pre><code class="language-go">func main() {
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">old stuff</span></pre></summary>
<pre><code class="language-go">	var metricsAddr string
	var enableLeaderElection bool
	flag.StringVar(&amp;metricsAddr, &quot;metrics-addr&quot;, &quot;:8080&quot;, &quot;The address the metric endpoint binds to.&quot;)
	flag.BoolVar(&amp;enableLeaderElection, &quot;enable-leader-election&quot;, false,
		&quot;Enable leader election for controller manager. Enabling this will ensure there is only one active controller manager.&quot;)
	flag.Parse()

	ctrl.SetLogger(zap.New(zap.UseDevMode(true)))

	mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{
		Scheme:             scheme,
		MetricsBindAddress: metricsAddr,
		LeaderElection:     enableLeaderElection,
		Port:               9443,
	})
	if err != nil {
		setupLog.Error(err, &quot;unable to start manager&quot;)
		os.Exit(1)
	}
</code></pre>
</details>
<pre><code class="language-go">	if err = (&amp;controllers.CronJobReconciler{
		Client: mgr.GetClient(),
		Log:    ctrl.Log.WithName(&quot;controllers&quot;).WithName(&quot;Captain&quot;),
		Scheme: mgr.GetScheme(),
	}).SetupWithManager(mgr); err != nil {
		setupLog.Error(err, &quot;unable to create controller&quot;, &quot;controller&quot;, &quot;Captain&quot;)
		os.Exit(1)
	}
</code></pre>
<p>我们还会为我们的 type 设置 webhook。
我们只需要将它们添加到 manager 中就行。
由于我们可能想单独运行 webhook，或者在本地测试 controller 不运行它们，因此我们将其是否启动放在环境变量里面。</p>
<p>如不需要启动 webhook，只需要设置 <code>ENABLE_WEBHOOKS = false</code> 即可。</p>
<pre><code class="language-go">	if os.Getenv(&quot;ENABLE_WEBHOOKS&quot;) != &quot;false&quot; {
		if err = (&amp;batchv1.CronJob{}).SetupWebhookWithManager(mgr); err != nil {
			setupLog.Error(err, &quot;unable to create webhook&quot;, &quot;webhook&quot;, &quot;Captain&quot;)
			os.Exit(1)
		}
	}
	// +kubebuilder:scaffold:builder
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">old stuff</span></pre></summary>
<pre><code class="language-go">	setupLog.Info(&quot;starting manager&quot;)
	if err := mgr.Start(ctrl.SetupSignalHandler()); err != nil {
		setupLog.Error(err, &quot;problem running manager&quot;)
		os.Exit(1)
	}
</code></pre>
</details>
<pre><code class="language-go">}
</code></pre>
</div>
<p>现在，我们可以实现我们的 controller 了</p>
<h1><a class="header" href="#实现-defaulting-webhooks-和-validating-webhooks" id="实现-defaulting-webhooks-和-validating-webhooks">实现 defaulting webhooks 和 validating webhooks</a></h1>
<p>如果你想为你的 CRD 实现 <a href="cronjob-tutorial/../reference/admission-webhook.html">admission webhooks</a>，你只需要实现 <code>Defaulter</code> 和 (或)  <code>Validator</code>  接口即可。</p>
<p>其余的东西 Kubebuilder 会为你实现，比如：</p>
<ol>
<li>创建一个 webhook server</li>
<li>确保这个 server 被添加到 manager 中</li>
<li>为你的 webhooks 创建一个 handlers</li>
<li>将每个 handler 以 path 形式注册到你的 server 中</li>
</ol>
<p>首先，让我们为 CRD（CronJob）创建 webhooks，我们需要用到 <code>--defaulting</code> 和 <code>--programmatic-validation</code> 参数(因为我们的测试项目将使用 defaulting webhooks 和 validating webhooks)：</p>
<pre><code class="language-bash">kubebuilder create webhook --group batch --version v1 --kind CronJob --defaulting --programmatic-validation
</code></pre>
<p>这将创建 Webhook 功能相关的方法，并在 <code>main.go</code> 中注册 Webhook 到你的 manager 中。</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/project/api/v1/cronjob_webhook.go">project/api/v1/cronjob_webhook.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Go imports</span></pre></summary>
<pre><code class="language-go">package v1

import (
	&quot;github.com/robfig/cron&quot;
	apierrors &quot;k8s.io/apimachinery/pkg/api/errors&quot;
	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;
	validationutils &quot;k8s.io/apimachinery/pkg/util/validation&quot;
	&quot;k8s.io/apimachinery/pkg/util/validation/field&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	logf &quot;sigs.k8s.io/controller-runtime/pkg/runtime/log&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/webhook&quot;
)
</code></pre>
</details>
<p>下一步，为我们的 webhooks 创建一个 logger。</p>
<pre><code class="language-go">var cronjoblog = logf.Log.WithName(&quot;cronjob-resource&quot;)
</code></pre>
<p>然后, 我们通过 manager 构建 webhook。</p>
<pre><code class="language-go">func (r *CronJob) SetupWebhookWithManager(mgr ctrl.Manager) error {
	return ctrl.NewWebhookManagedBy(mgr).
		For(r).
		Complete()
}
</code></pre>
<p>注意，下面我们使用 kubebuilder 的 marker 语句生成 webhook manifests(配置 webhook 的 yaml 文件)，
这个 marker 会生成一个 mutating Webhook 的 manifests。</p>
<p>关于每个参数的解释都可以在<a href="cronjob-tutorial/../reference/markers/webhook.html">这里</a>找到。</p>
<pre><code class="language-go">// +kubebuilder:webhook:path=/mutate-batch-tutorial-kubebuilder-io-v1-cronjob,mutating=true,failurePolicy=fail,groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=create;update,versions=v1,name=mcronjob.kb.io
</code></pre>
<p>我们使用 <code>webhook.Defaulter</code> 接口将 webhook 的默认值设置为我们的 CRD，
这将自动生成一个 Webhook(defaulting webhooks)，并调用它的 Default 方法。</p>
<p><code>Default</code> 方法用来改变接受到的内容，并设置默认值。</p>
<pre><code class="language-go">var _ webhook.Defaulter = &amp;CronJob{}

// Default implements webhook.Defaulter so a webhook will be registered for the type
func (r *CronJob) Default() {
	cronjoblog.Info(&quot;default&quot;, &quot;name&quot;, r.Name)

	if r.Spec.ConcurrencyPolicy == &quot;&quot; {
		r.Spec.ConcurrencyPolicy = AllowConcurrent
	}
	if r.Spec.Suspend == nil {
		r.Spec.Suspend = new(bool)
	}
	if r.Spec.SuccessfulJobsHistoryLimit == nil {
		r.Spec.SuccessfulJobsHistoryLimit = new(int32)
		*r.Spec.SuccessfulJobsHistoryLimit = 3
	}
	if r.Spec.FailedJobsHistoryLimit == nil {
		r.Spec.FailedJobsHistoryLimit = new(int32)
		*r.Spec.FailedJobsHistoryLimit = 1
	}
}
</code></pre>
<p>这个 marker 负责生成一个 validating webhook manifest。</p>
<pre><code class="language-go">// TODO(user): change verbs to &quot;verbs=create;update;delete&quot; if you want to enable deletion validation.
// +kubebuilder:webhook:verbs=create;update,path=/validate-batch-tutorial-kubebuilder-io-v1-cronjob,mutating=false,failurePolicy=fail,groups=batch.tutorial.kubebuilder.io,resources=cronjobs,versions=v1,name=vcronjob.kb.io
</code></pre>
<p>我们可以通过声明式验证(declarative validation)来验证我们的 CRD，
通常情况下，声明式验证就足够了，但是有时更高级的用例需要进行复杂的验证。</p>
<p>例如，我们将在后面看到我们使验证(declarative validation)来验证 cron schedule(是否是 * * * * * 这种格式) 的格式是否正确，
而不是编写复杂的正则表达式来验证。</p>
<p>如果实现了 <code>webhook.Validator</code> 接口，将会自动生成一个 Webhook(validating webhooks) 来调用我们验证方法。</p>
<p><code>ValidateCreate</code>、<code>ValidateUpdate</code> 和 <code>ValidateDelete</code> 方法分别在创建，更新和删除 resrouces 时验证它们收到的信息。
我们将 <code>ValidateCreate</code> 与 <code>ValidateUpdate</code> 方法分开，因为某些字段可能是固定不变的，
他们只能在 <code>ValidateCreate</code> 方法中被调用，这样会提高一些安全性，
<code>ValidateDelete</code> 和 <code>ValidateUpdate</code> 方法也被分开，以便在进行删除操作时进行单独的验证。
但是在这里，我们在 <code>ValidateDelete</code> 中什么也没有做，
只是对 <code>ValidateCreate</code> 和 <code>ValidateUpdate</code> 使用同一个方法进行了验证，
因为我们不需要在删除时验证任何内容。</p>
<pre><code class="language-go">var _ webhook.Validator = &amp;CronJob{}

// ValidateCreate implements webhook.Validator so a webhook will be registered for the type
func (r *CronJob) ValidateCreate() error {
	cronjoblog.Info(&quot;validate create&quot;, &quot;name&quot;, r.Name)

	return r.validateCronJob()
}

// ValidateUpdate implements webhook.Validator so a webhook will be registered for the type
func (r *CronJob) ValidateUpdate(old runtime.Object) error {
	cronjoblog.Info(&quot;validate update&quot;, &quot;name&quot;, r.Name)

	return r.validateCronJob()
}

// ValidateDelete implements webhook.Validator so a webhook will be registered for the type
func (r *CronJob) ValidateDelete() error {
	cronjoblog.Info(&quot;validate delete&quot;, &quot;name&quot;, r.Name)

	// TODO(user): fill in your validation logic upon object deletion.
	return nil
}
</code></pre>
<p>验证 CronJob 的 name 和 spec 字段</p>
<pre><code class="language-go">func (r *CronJob) validateCronJob() error {
	var allErrs field.ErrorList
	if err := r.validateCronJobName(); err != nil {
		allErrs = append(allErrs, err)
	}
	if err := r.validateCronJobSpec(); err != nil {
		allErrs = append(allErrs, err)
	}
	if len(allErrs) == 0 {
		return nil
	}

	return apierrors.NewInvalid(
		schema.GroupKind{Group: &quot;batch.tutorial.kubebuilder.io&quot;, Kind: &quot;CronJob&quot;},
		r.Name, allErrs)
}
</code></pre>
<p>一些字段是用 OpenAPI schema 方式进行验证，
你可以在 <a href="cronjob-tutorial/./api-design.html">设计API</a> 中找到有关 kubebuilder 的验证 markers(注释前缀为<code>//+kubebuilder:validation</code>)。
你也可以通过运行 <code>controller-gen crd -w</code> 或 在<a href="cronjob-tutorial//reference/markers/crd-validation.html">这里</a>
找到所有关于使用 markers 验证的格式信息。</p>
<pre><code class="language-go">func (r *CronJob) validateCronJobSpec() *field.Error {
	// The field helpers from the kubernetes API machinery help us return nicely
	// structured validation errors.
	return validateScheduleFormat(
		r.Spec.Schedule,
		field.NewPath(&quot;spec&quot;).Child(&quot;schedule&quot;))
}
</code></pre>
<p>我们在这里验证 <a href="https://en.wikipedia.org/wiki/Cron">cron</a> schedule 的格式</p>
<pre><code class="language-go">func validateScheduleFormat(schedule string, fldPath *field.Path) *field.Error {
	if _, err := cron.ParseStandard(schedule); err != nil {
		return field.Invalid(fldPath, schedule, err.Error())
	}
	return nil
}
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Validate object name</span></pre></summary>
<p>验证字符串字段的长度可以以声明方式完成。</p>
<p>但是 <code>ObjectMeta.Name</code> 字段是在 <code>apimachinery</code> 库下的 package 中定义的，
因此我们无法以声明性的方式对其进行验证。</p>
<pre><code class="language-go">func (r *CronJob) validateCronJobName() *field.Error {
	if len(r.ObjectMeta.Name) &gt; validationutils.DNS1035LabelMaxLength-11 {
		// The job name length is 63 character like all Kubernetes objects
		// (which must fit in a DNS subdomain). The cronjob controller appends
		// a 11-character suffix to the cronjob (`-$TIMESTAMP`) when creating
		// a job. The job name length limit is 63 characters. Therefore cronjob
		// names must have length &lt;= 63-11=52. If we don't validate this here,
		// then job creation will fail later.
		return field.Invalid(field.NewPath(&quot;metadata&quot;).Child(&quot;name&quot;), r.Name, &quot;must be no more than 52 characters&quot;)
	}
	return nil
}
</code></pre>
</details></div>
<h1><a class="header" href="#running-and-deploying-the-controller" id="running-and-deploying-the-controller">Running and deploying the controller</a></h1>
<p>To test out the controller, we can run it locally against the cluster.
Before we do so, though, we’ll need to install our CRDs, as per the <a href="cronjob-tutorial//quick-start.html">quick
start</a>.  This will automatically update the YAML
manifests using controller-tools, if needed:</p>
<pre><code class="language-bash">make install
</code></pre>
<p>Now that we’ve installed our CRDs, we can run the controller against our
cluster.  This will use whatever credentials that we connect to the
cluster with, so we don’t need to worry about RBAC just yet.</p>
<aside class="note"> 
<h1><a class="header" href="#running-webhooks-locally" id="running-webhooks-locally">Running webhooks locally</a></h1>
<p>If you want to run the webhooks locally, you’ll have to generate
certificates for serving the webhooks, and place them in the right
directory (<code>/tmp/k8s-webhook-server/serving-certs/tls.{crt,key}</code>, by
default).</p>
<p>If you’re not running a local API server, you’ll also need to figure out
how to proxy traffic from the remote cluster to your local webhook server.
For this reason, we generally reccomended disabling webhooks when doing
your local code-run-test cycle, as we do below.</p>
</aside>
<p>In a separate terminal, run</p>
<pre><code class="language-bash">make run ENABLE_WEBHOOKS=false
</code></pre>
<p>You should see logs from the controller about starting up, but it won’t do
anything just yet.</p>
<p>At this point, we need a CronJob to test with.  Let’s write a sample to
<code>config/samples/batch_v1_cronjob.yaml</code>, and use that:</p>
<pre><code class="language-yaml">apiVersion: batch.tutorial.kubebuilder.io/v1
kind: CronJob
metadata:
  name: cronjob-sample
spec:
  schedule: &quot;*/1 * * * *&quot;
  startingDeadlineSeconds: 60
  concurrencyPolicy: Allow # explicitly specify, but Allow is also default.
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            args:
            - /bin/sh
            - -c
            - date; echo Hello from the Kubernetes cluster
          restartPolicy: OnFailure
</code></pre>
<pre><code class="language-bash">kubectl create -f config/samples/batch_v1_cronjob.yaml
</code></pre>
<p>At this point, you should see a flurry of activity.  If you watch the
changes, you should see your cronjob running, and updating status:</p>
<pre><code class="language-bash">kubectl get cronjob.batch.tutorial.kubebuilder.io -o yaml
kubectl get job
</code></pre>
<p>Now that we know it’s working, we can run it in the cluster. Stop the
<code>make run</code> invocation, and run</p>
<pre><code class="language-bash">make docker-build docker-push IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag
make deploy IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag
</code></pre>
<p>If we list cronjobs again like we did before, we should see the controller
functioning again!</p>
<h1><a class="header" href="#deploying-the-cert-manager" id="deploying-the-cert-manager">Deploying the cert manager</a></h1>
<p>We suggest using <a href="https://github.com/jetstack/cert-manager">cert manager</a> for
provisioning the certificates for the webhook server. Other solutions should
also work as long as they put the certificates in the desired location.</p>
<p>You can follow
<a href="https://docs.cert-manager.io/en/latest/getting-started/install/kubernetes.html">the cert manager documentation</a>
to install it.</p>
<p>Cert manager also has a component called CA injector, which is responsible for
injecting the CA bundle into the Mutating|ValidatingWebhookConfiguration.</p>
<p>To accomplish that, you need to use an annotation with key
<code>certmanager.k8s.io/inject-ca-from</code>
in the Mutating|ValidatingWebhookConfiguration objects.
The value of the annotation should point to an existing certificate CR instance
in the format of <code>&lt;certificate-namespace&gt;/&lt;certificate-name&gt;</code>.</p>
<p>This is the <a href="https://github.com/kubernetes-sigs/kustomize">kustomize</a> patch we
used for annotating the Mutating|ValidatingWebhookConfiguration objects.</p>
<pre><code class="language-yaml"># This patch add annotation to admission webhook config and
# the variables $(CERTIFICATE_NAMESPACE) and $(CERTIFICATE_NAME) will be substituted by kustomize.
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: mutating-webhook-configuration
  annotations:
    certmanager.k8s.io/inject-ca-from: $(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: ValidatingWebhookConfiguration
metadata:
  name: validating-webhook-configuration
  annotations:
    certmanager.k8s.io/inject-ca-from: $(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)
</code></pre>
<h1><a class="header" href="#deploying-admission-webhooks" id="deploying-admission-webhooks">Deploying Admission Webhooks</a></h1>
<h2><a class="header" href="#kind-cluster" id="kind-cluster">Kind Cluster</a></h2>
<p>It is recommended to develop your webhook with a
<a href="cronjob-tutorial/../reference/kind.html">kind</a> cluster for faster iteration.
Why?</p>
<ul>
<li>You can bring up a multi-node cluster locally within 1 minute.</li>
<li>You can tear it down in seconds.</li>
<li>You don’t need to push your images to remote registry.</li>
</ul>
<h2><a class="header" href="#cert-manager" id="cert-manager">Cert Manager</a></h2>
<p>You need follow <a href="cronjob-tutorial/./cert-manager.html">this</a> to install the cert manager bundle.</p>
<h2><a class="header" href="#build-your-image" id="build-your-image">Build your image</a></h2>
<p>Run the following command to build your image locally.</p>
<pre><code class="language-bash">make docker-build
</code></pre>
<p>You don’t need to push the image to a remote container registry if you are using
a kind cluster. You can directly load your local image to your kind cluster:</p>
<pre><code class="language-bash">kind load docker-image your-image-name:your-tag
</code></pre>
<h2><a class="header" href="#deploy-webhooks" id="deploy-webhooks">Deploy Webhooks</a></h2>
<p>You need to enable the webhook and cert manager configuration through kustomize.
<code>config/default/kustomization.yaml</code> should now look like the following:</p>
<pre><code class="language-yaml"># Adds namespace to all resources.
namespace: project-system

# Value of this field is prepended to the
# names of all resources, e.g. a deployment named
# &quot;wordpress&quot; becomes &quot;alices-wordpress&quot;.
# Note that it should also match with the prefix (text before '-') of the namespace
# field above.
namePrefix: project-

# Labels to add to all resources and selectors.
#commonLabels:
#  someName: someValue

bases:
- ../crd
- ../rbac
- ../manager
# [WEBHOOK] To enable webhook, uncomment all the sections with [WEBHOOK] prefix including the one in
# crd/kustomization.yaml
- ../webhook
# [CERTMANAGER] To enable cert-manager, uncomment all sections with 'CERTMANAGER'. 'WEBHOOK' components are required.
- ../certmanager
# [PROMETHEUS] To enable prometheus monitor, uncomment all sections with 'PROMETHEUS'.
#- ../prometheus

patchesStrategicMerge:
  # Protect the /metrics endpoint by putting it behind auth.
  # If you want your controller-manager to expose the /metrics
  # endpoint w/o any authn/z, please comment the following line.
- manager_auth_proxy_patch.yaml

# [WEBHOOK] To enable webhook, uncomment all the sections with [WEBHOOK] prefix including the one in
# crd/kustomization.yaml
- manager_webhook_patch.yaml

# [CERTMANAGER] To enable cert-manager, uncomment all sections with 'CERTMANAGER'.
# Uncomment 'CERTMANAGER' sections in crd/kustomization.yaml to enable the CA injection in the admission webhooks.
# 'CERTMANAGER' needs to be enabled to use ca injection
- webhookcainjection_patch.yaml

# the following config is for teaching kustomize how to do var substitution
vars:
# [CERTMANAGER] To enable cert-manager, uncomment all sections with 'CERTMANAGER' prefix.
- name: CERTIFICATE_NAMESPACE # namespace of the certificate CR
  objref:
    kind: Certificate
    group: cert-manager.io
    version: v1alpha2
    name: serving-cert # this name should match the one in certificate.yaml
  fieldref:
    fieldpath: metadata.namespace
- name: CERTIFICATE_NAME
  objref:
    kind: Certificate
    group: cert-manager.io
    version: v1alpha2
    name: serving-cert # this name should match the one in certificate.yaml
- name: SERVICE_NAMESPACE # namespace of the service
  objref:
    kind: Service
    version: v1
    name: webhook-service
  fieldref:
    fieldpath: metadata.namespace
- name: SERVICE_NAME
  objref:
    kind: Service
    version: v1
    name: webhook-service
</code></pre>
<p>Now you can deploy it to your cluster by</p>
<pre><code class="language-bash">make deploy IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag
</code></pre>
<p>Wait a while til the webhook pod comes up and the certificates are provisioned.
It usually completes within 1 minute.</p>
<p>Now you can create a valid CronJob to test your webhooks. The creation should
successfully go through.</p>
<pre><code class="language-bash">kubectl create -f config/samples/batch_v1_cronjob.yaml
</code></pre>
<p>You can also try to create an invalid CronJob (e.g. use an ill-formatted
schedule field). You should see a creation failure with a validation error.</p>
<aside class="note warning">
<h1><a class="header" href="#the-bootstrapping-problem" id="the-bootstrapping-problem">The Bootstrapping Problem</a></h1>
<p>If you are deploying a webhook for pods in the same cluster, be
careful about the bootstrapping problem, since the creation request of the
webhook pod would be sent to the webhook pod itself, which hasn’t come up yet.</p>
<p>To make it work, you can either use <a href="https://github.com/kubernetes/api/blob/kubernetes-1.14.5/admissionregistration/v1beta1/types.go#L189-L233">namespaceSelector</a> if your kubernetes
version is 1.9+ or use <a href="https://github.com/kubernetes/api/blob/kubernetes-1.15.2/admissionregistration/v1beta1/types.go#L262-L274">objectSelector</a> if your kubernetes version is 1.15+ to
skip itself.</p>
</aside>
<h1><a class="header" href="#epilogue" id="epilogue">Epilogue</a></h1>
<p>By this point, we’ve got a pretty full-featured implementation of the
CronJob controller, and have made use of most of the features of
KubeBuilder.</p>
<p>If you want more, head over to the <a href="cronjob-tutorial//multiversion-tutorial/tutorial.html">Multi-Version
Tutorial</a> to learn how to add new API
versions to a project.</p>
<p>Additionally, you can try the following steps on your own -- we’ll have
a tutorial section on them Soon™: </p>
<ul>
<li>writing unit/integration tests (check out <a href="https://godoc.org/sigs.k8s.io/controller-runtime/pkg/envtest">envtest</a>)</li>
<li>adding <a href="cronjob-tutorial//reference/generating-crd.html#additional-printer-columns">additional printer columns</a> <code>kubectl get</code></li>
</ul>
<h1><a class="header" href="#tutorial-multi-version-api" id="tutorial-multi-version-api">Tutorial: Multi-Version API</a></h1>
<p>Most projects start out with an alpha API that changes release to release.
However, eventually, most projects will need to move to a more stable API.
Once your API is stable though, you can’t make breaking changes to it.
That’s where API versions come into play.</p>
<p>Let’s make some changes to the <code>CronJob</code> API spec and make sure all the
different versions are supported by our CronJob project.</p>
<p>If you haven’t already, make sure you’ve gone through the base <a href="multiversion-tutorial//cronjob-tutorial/cronjob-tutorial.html">CronJob
Tutorial</a>.</p>
<aside class="note">
<h1><a class="header" href="#following-along-vs-jumping-ahead" id="following-along-vs-jumping-ahead">Following Along vs Jumping Ahead</a></h1>
<p>Note that most of this tutorial is generated from literate Go files that
form a runnable project, and live in the book source directory:
<a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/multiversion-tutorial/testdata/project">docs/book/src/multiversion-tutorial/testdata/project</a>.</p>
</aside>
<aside class="note warning">
<h1><a class="header" href="#minimum-kubernetes-versions-incoming" id="minimum-kubernetes-versions-incoming">Minimum Kubernetes Versions Incoming!</a></h1>
<p>CRD conversion support was introduced as an alpha feature in Kubernetes
1.13 (which means it’s not on by default, and needs to be enabled via
a <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/" title="Kubernetes Feature Gates">feature gate</a>), and became beta in Kubernetes 1.15
(which means it’s on by default).</p>
<p>If you’re on Kubernetes 1.13-1.14, make sure to enable the feature gate.
If you’re on Kubernetes 1.12 or below, you’ll need a new cluster to use
conversion. Check out the <a href="multiversion-tutorial//reference/kind.html">KinD instructions</a> for
instructions on how to set up a all-in-one cluster.</p>
</aside>
<p>Next, let’s figure out what changes we want to make...</p>
<h1><a class="header" href="#changing-things-up" id="changing-things-up">Changing things up</a></h1>
<p>A fairly common change in a Kubernetes API is to take some data that used
to be unstructured or stored in some special string format, and change it
to structured data.   Our <code>schedule</code> field fits the bill quite nicely for
this -- right now, in <code>v1</code>, our schedules look like</p>
<pre><code class="language-yaml">schedule: &quot;*/1 * * * *&quot;
</code></pre>
<p>That’s a pretty textbook example of a special string format (it’s also
pretty unreadable unless you’re a Unix sysadmin).</p>
<p>Let’s make it a bit more structured.  According to the our <a href="multiversion-tutorial//TODO.html">CronJob
code</a>, we support “standard” Cron format.</p>
<p>In Kubernetes, <strong>all versions must be safely round-tripable through each
other</strong>.  This means that if we convert from version 1 to version 2, and
then back to version 1, we must not lose information.  Thus, any change we
make to our API must be compatible with whatever we supported in v1, and
also need to make sure anything we add in v2 is supported in v2.  In some
cases, this means we need to add new fields to v1, but in our case, we
won’t have to, since we’re not adding new functionality.</p>
<p>Keeping all that in mind, let’s convert our example above to be
slightly more structured:</p>
<pre><code class="language-yaml">schedule:
  minute: */1
</code></pre>
<p>Now, at least, we’ve got labels for each of our fields, but we can still
easily support all the different syntax for each field.</p>
<p>We’ll need a new API version for this change.  Let’s call it v2:</p>
<pre><code class="language-shell">kubebuilder create api --group batch --version v2 --kind CronJob
</code></pre>
<p>Now, let’s copy over our existing types, and make the change:</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/multiversion-tutorial/testdata/project/api/v2/cronjob_types.go">project/api/v2/cronjob_types.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<p>Since we’re in a v2 package, controller-gen will assume this is for the v2
version automatically.  We could override that with the <a href="multiversion-tutorial//reference/markers/crd.html"><code>+versionName</code>
marker</a>.</p>
<pre><code class="language-go">package v2
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<pre><code class="language-go">import (
	batchv1beta1 &quot;k8s.io/api/batch/v1beta1&quot;
	corev1 &quot;k8s.io/api/core/v1&quot;
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
)

// EDIT THIS FILE!  THIS IS SCAFFOLDING FOR YOU TO OWN!
// NOTE: json tags are required.  Any new fields you add must have json tags for the fields to be serialized.
</code></pre>
</details>
<p>We’ll leave our spec largely unchanged, except to change the schedule field to a new type.</p>
<pre><code class="language-go">// CronJobSpec defines the desired state of CronJob
type CronJobSpec struct {
	// The schedule in Cron format, see https://en.wikipedia.org/wiki/Cron.
	Schedule CronSchedule `json:&quot;schedule&quot;`
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">The rest of Spec</span></pre></summary>
<pre><code class="language-go">	// +kubebuilder:validation:Minimum=0

	// Optional deadline in seconds for starting the job if it misses scheduled
	// time for any reason.  Missed jobs executions will be counted as failed ones.
	// +optional
	StartingDeadlineSeconds *int64 `json:&quot;startingDeadlineSeconds,omitempty&quot;`

	// Specifies how to treat concurrent executions of a Job.
	// Valid values are:
	// - &quot;Allow&quot; (default): allows CronJobs to run concurrently;
	// - &quot;Forbid&quot;: forbids concurrent runs, skipping next run if previous run hasn't finished yet;
	// - &quot;Replace&quot;: cancels currently running job and replaces it with a new one
	// +optional
	ConcurrencyPolicy ConcurrencyPolicy `json:&quot;concurrencyPolicy,omitempty&quot;`

	// This flag tells the controller to suspend subsequent executions, it does
	// not apply to already started executions.  Defaults to false.
	// +optional
	Suspend *bool `json:&quot;suspend,omitempty&quot;`

	// Specifies the job that will be created when executing a CronJob.
	JobTemplate batchv1beta1.JobTemplateSpec `json:&quot;jobTemplate&quot;`

	// +kubebuilder:validation:Minimum=0

	// The number of successful finished jobs to retain.
	// This is a pointer to distinguish between explicit zero and not specified.
	// +optional
	SuccessfulJobsHistoryLimit *int32 `json:&quot;successfulJobsHistoryLimit,omitempty&quot;`

	// +kubebuilder:validation:Minimum=0

	// The number of failed finished jobs to retain.
	// This is a pointer to distinguish between explicit zero and not specified.
	// +optional
	FailedJobsHistoryLimit *int32 `json:&quot;failedJobsHistoryLimit,omitempty&quot;`
</code></pre>
</details>
<pre><code class="language-go">}
</code></pre>
<p>Next, we’ll need to define a type to hold our schedule.
Based on our proposed YAML above, it’ll have a field for
each corresponding Cron “field”.</p>
<pre><code class="language-go">// describes a Cron schedule.
type CronSchedule struct {
	// specifies the minute during which the job executes.
	// +optional
	Minute *CronField `json:&quot;minute,omitempty&quot;`
	// specifies the hour during which the job executes.
	// +optional
	Hour *CronField `json:&quot;hour,omitempty&quot;`
	// specifies the day of the month during which the job executes.
	// +optional
	DayOfMonth *CronField `json:&quot;dayOfMonth,omitempty&quot;`
	// specifies the month during which the job executes.
	// +optional
	Month *CronField `json:&quot;month,omitempty&quot;`
	// specifies the day of the week during which the job executes.
	// +optional
	DayOfWeek *CronField `json:&quot;dayOfWeek,omitempty&quot;`
}
</code></pre>
<p>Finally, we’ll define a wrapper type to represent a field.
We could attach additional validation to this field,
but for now we’ll just use it for documentation purposes.</p>
<pre><code class="language-go">// represents a Cron field specifier.
type CronField string
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Other Types</span></pre></summary>
<p>All the other types will stay the same as before.</p>
<pre><code class="language-go">// ConcurrencyPolicy describes how the job will be handled.
// Only one of the following concurrent policies may be specified.
// If none of the following policies is specified, the default one
// is AllowConcurrent.
// +kubebuilder:validation:Enum=Allow;Forbid;Replace
type ConcurrencyPolicy string

const (
	// AllowConcurrent allows CronJobs to run concurrently.
	AllowConcurrent ConcurrencyPolicy = &quot;Allow&quot;

	// ForbidConcurrent forbids concurrent runs, skipping next run if previous
	// hasn't finished yet.
	ForbidConcurrent ConcurrencyPolicy = &quot;Forbid&quot;

	// ReplaceConcurrent cancels currently running job and replaces it with a new one.
	ReplaceConcurrent ConcurrencyPolicy = &quot;Replace&quot;
)

// CronJobStatus defines the observed state of CronJob
type CronJobStatus struct {
	// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
	// Important: Run &quot;make&quot; to regenerate code after modifying this file

	// A list of pointers to currently running jobs.
	// +optional
	Active []corev1.ObjectReference `json:&quot;active,omitempty&quot;`

	// Information when was the last time the job was successfully scheduled.
	// +optional
	LastScheduleTime *metav1.Time `json:&quot;lastScheduleTime,omitempty&quot;`
}

// +kubebuilder:object:root=true
// +kubebuilder:subresource:status

// CronJob is the Schema for the cronjobs API
type CronJob struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   CronJobSpec   `json:&quot;spec,omitempty&quot;`
	Status CronJobStatus `json:&quot;status,omitempty&quot;`
}

// +kubebuilder:object:root=true

// CronJobList contains a list of CronJob
type CronJobList struct {
	metav1.TypeMeta `json:&quot;,inline&quot;`
	metav1.ListMeta `json:&quot;metadata,omitempty&quot;`
	Items           []CronJob `json:&quot;items&quot;`
}

func init() {
	SchemeBuilder.Register(&amp;CronJob{}, &amp;CronJobList{})
}
</code></pre>
</details></div>
<h2><a class="header" href="#storage-versions" id="storage-versions">Storage Versions</a></h2>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/multiversion-tutorial/testdata/project/api/v1/cronjob_types.go">project/api/v1/cronjob_types.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<pre><code class="language-go">package v1
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<pre><code class="language-go">import (
	batchv1beta1 &quot;k8s.io/api/batch/v1beta1&quot;
	corev1 &quot;k8s.io/api/core/v1&quot;
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
)

// EDIT THIS FILE!  THIS IS SCAFFOLDING FOR YOU TO OWN!
// NOTE: json tags are required.  Any new fields you add must have json tags for the fields to be serialized.
</code></pre>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">old stuff</span></pre></summary>
<pre><code class="language-go">// CronJobSpec defines the desired state of CronJob
type CronJobSpec struct {
	// +kubebuilder:validation:MinLength=0

	// The schedule in Cron format, see https://en.wikipedia.org/wiki/Cron.
	Schedule string `json:&quot;schedule&quot;`

	// +kubebuilder:validation:Minimum=0

	// Optional deadline in seconds for starting the job if it misses scheduled
	// time for any reason.  Missed jobs executions will be counted as failed ones.
	// +optional
	StartingDeadlineSeconds *int64 `json:&quot;startingDeadlineSeconds,omitempty&quot;`

	// Specifies how to treat concurrent executions of a Job.
	// Valid values are:
	// - &quot;Allow&quot; (default): allows CronJobs to run concurrently;
	// - &quot;Forbid&quot;: forbids concurrent runs, skipping next run if previous run hasn't finished yet;
	// - &quot;Replace&quot;: cancels currently running job and replaces it with a new one
	// +optional
	ConcurrencyPolicy ConcurrencyPolicy `json:&quot;concurrencyPolicy,omitempty&quot;`

	// This flag tells the controller to suspend subsequent executions, it does
	// not apply to already started executions.  Defaults to false.
	// +optional
	Suspend *bool `json:&quot;suspend,omitempty&quot;`

	// Specifies the job that will be created when executing a CronJob.
	JobTemplate batchv1beta1.JobTemplateSpec `json:&quot;jobTemplate&quot;`

	// +kubebuilder:validation:Minimum=0

	// The number of successful finished jobs to retain.
	// This is a pointer to distinguish between explicit zero and not specified.
	// +optional
	SuccessfulJobsHistoryLimit *int32 `json:&quot;successfulJobsHistoryLimit,omitempty&quot;`

	// +kubebuilder:validation:Minimum=0

	// The number of failed finished jobs to retain.
	// This is a pointer to distinguish between explicit zero and not specified.
	// +optional
	FailedJobsHistoryLimit *int32 `json:&quot;failedJobsHistoryLimit,omitempty&quot;`
}

// ConcurrencyPolicy describes how the job will be handled.
// Only one of the following concurrent policies may be specified.
// If none of the following policies is specified, the default one
// is AllowConcurrent.
// +kubebuilder:validation:Enum=Allow;Forbid;Replace
type ConcurrencyPolicy string

const (
	// AllowConcurrent allows CronJobs to run concurrently.
	AllowConcurrent ConcurrencyPolicy = &quot;Allow&quot;

	// ForbidConcurrent forbids concurrent runs, skipping next run if previous
	// hasn't finished yet.
	ForbidConcurrent ConcurrencyPolicy = &quot;Forbid&quot;

	// ReplaceConcurrent cancels currently running job and replaces it with a new one.
	ReplaceConcurrent ConcurrencyPolicy = &quot;Replace&quot;
)

// CronJobStatus defines the observed state of CronJob
type CronJobStatus struct {
	// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
	// Important: Run &quot;make&quot; to regenerate code after modifying this file

	// A list of pointers to currently running jobs.
	// +optional
	Active []corev1.ObjectReference `json:&quot;active,omitempty&quot;`

	// Information when was the last time the job was successfully scheduled.
	// +optional
	LastScheduleTime *metav1.Time `json:&quot;lastScheduleTime,omitempty&quot;`
}
</code></pre>
</details>
<p>Since we’ll have more than one version, we’ll need to mark a storage version.
This is the version that the Kubernetes API server uses to store our data.
We’ll chose the v1 version for our project.</p>
<p>We’ll use the <a href="multiversion-tutorial//reference/markers/crd.html"><code>+kubebuilder:storageversion</code></a> to do this.</p>
<p>Note that multiple versions may exist in storage if they were written before
the storage version changes -- changing the storage version only affects how
objects are created/updated after the change.</p>
<pre><code class="language-go">// +kubebuilder:object:root=true
// +kubebuilder:subresource:status
// +kubebuilder:storageversion

// CronJob is the Schema for the cronjobs API
type CronJob struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   CronJobSpec   `json:&quot;spec,omitempty&quot;`
	Status CronJobStatus `json:&quot;status,omitempty&quot;`
}
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">old stuff</span></pre></summary>
<pre><code class="language-go">// +kubebuilder:object:root=true

// CronJobList contains a list of CronJob
type CronJobList struct {
	metav1.TypeMeta `json:&quot;,inline&quot;`
	metav1.ListMeta `json:&quot;metadata,omitempty&quot;`
	Items           []CronJob `json:&quot;items&quot;`
}

func init() {
	SchemeBuilder.Register(&amp;CronJob{}, &amp;CronJobList{})
}
</code></pre>
</details></div>
<p>Now that we’ve got our types in place, we’ll need to set up conversion...</p>
<h1><a class="header" href="#hubs-spokes-and-other-wheel-metaphors" id="hubs-spokes-and-other-wheel-metaphors">Hubs, spokes, and other wheel metaphors</a></h1>
<p>Since we now have two different versions, and users can request either
version, we’ll have to define a way to convert between our version. For
CRDs, this is done using a webhook, similar to the defaulting and
validating webhooks we <a href="multiversion-tutorial//cronjob-tutorial/webhook-implementation.html">defined in the base
tutorial</a>.  Like before,
controller-runtime will help us wire together the nitty-gritty bits, we
just have to implement the actual conversion.</p>
<p>Before we do that, though, we’ll need to understand how controller-runtime
thinks about versions.  Namely:</p>
<h2><a class="header" href="#complete-graphs-are-insufficiently-nautical" id="complete-graphs-are-insufficiently-nautical">Complete graphs are insufficiently nautical</a></h2>
<p>A simple approach to defining conversion might be to define conversion
functions to convert between each of our versions.  Then, whenever we need
to convert, we’d look up the appropriate function, and call it to run the
conversion.</p>
<p>This works fine when we just have two versions, but what if we had
4 types? 8 types? That’d be a lot of conversion functions.</p>
<p>Instead, controller-runtime models conversion in terms of a “hub and
spoke” model -- we mark one version as the “hub”, and all other versions
just define conversion to and from the hub:</p>
<!-- include these inline so we can style an match variables -->
<div class="diagrams">
<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.0" width="10352" height="10352" preserveAspectRatio="xMidYMid meet" viewBox="0 0 10352 10352" alt="an eight-vertex complete graph"> 
<g style="fill:none;stroke-width:70">
<path d="M 7089,557 L 9795,7089 L 3263,9795 L 557,3263 L 7089,557 L 7089,9795 L 557,7089 L 3263,557 L 9795,3263 L 7089,9795 L 557,3263 L 9795,3263 L 3263,9795 L 3263,557 L 9795,7089 L 557,7089 L 7089,557 M 9795,7089 L 557,3263 M 3263,557 L 7089,9795 M 9795,3263 L 557,7089"/> 
<polyline points="6913,381 9619,3087 9619,6913 6913,9619 3087,9619 381,6913 381,3087 3087,381 6913,381 3087,9619" transform="translate(176,176)" />
</g>
<g style="fill:blue;stroke-width:70" transform="translate(2831,9505)">
<circle r="200" cx="419" cy="-8996"/> 
<circle r="200" cx="-2311" cy="-6258"/> 
<circle r="200" cx="-2314" cy="-2403"/> 
<circle r="200" cx="6999" cy="-2410"/> 
<circle r="200" cx="6999" cy="-6258"/> 
<circle r="200" cx="4266" cy="-8989"/> 
<circle r="200" cx="4257" cy="306"/> 
<circle r="200" cx="411" cy="315"/>
</g></svg>
<div>becomes</div>
<svg
   xmlns="http://www.w3.org/2000/svg"
   version="1.1"
   width="10352"
   height="10352"
   preserveAspectRatio="xMidYMid meet" viewBox="0 0 10352 10352"
   alt="a seven-spoke hub-spoke graph"
   id="hub-spoke-graph">
  <defs
     id="defs37" />
  <g
     style="fill:none;stroke-width:70"
     transform="translate(276, 300)"
     id="g32">
    <path
       style="fill:none;stroke-width:70;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="M 113.08429,6113.9954 4982.533,4864.2096 9887.353,6125.7859"
       id="path848"/>
    <path
       style="fill:none;stroke-width:70;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="m 4997.2126,1.63198 10.3317,4900.09452 -2180.0607,4597.941"
       id="path852"/>
    <path
       style="fill:none;stroke-width:70;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="M 7216.7333,9562.1046 5010.9543,4876.7586"
       id="path854"/>
    <path
       style="fill:none;stroke-width:70;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="M 1079.8998,1881.2301 5007.5443,4901.7265 8914.6424,1866.492"
       id="path850"/>
    <g
       style="fill:blue;stroke-width:70"
       id="g30">
      <circle
         cx="2831"
         cy="9505"
         r="200"
         id="circle14" />
      <circle
         cx="5000"
         cy="0"
         r="200"
         id="circle16" />
      <circle
         cx="8909"
         cy="1883"
         r="200"
         id="circle18" />
      <circle
         cx="9875"
         cy="6113"
         r="200"
         id="circle20" />
      <circle
         cx="7169"
         cy="9505"
         r="200"
         id="circle22" />
      <circle
         cx="2831"
         cy="9505"
         r="200"
         id="circle24" />
      <circle
         cx="125"
         cy="6113"
         r="200"
         id="circle26" />
      <circle
         cx="1091"
         cy="1883"
         r="200"
         id="circle28" />
      <circle
         id="circle41"
         r="200"
         cy="4876"
         cx="5000" />
    </g>
  </g>
</svg>
</div>
<p>Then, if we have to convert between two non-hub versions, we first convert
to the hub version, and then to our desired version:</p>
<div class="diagrams">
<svg alt="spoke to hub to spoke" version="1.1" width="1068" height="623" preserveAspectRation="xMidYMid meet" viewBox="120.0 120.0 1068.0 623.0" fill="none" stroke="none" stroke-linecap="square" stroke-miterlimit="10" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg"><g><path fill="#cfe2f3" d="m120.51706 436.18896l0 0c0 -35.49408 28.773636 -64.2677 64.267715 -64.2677l0 0c17.04486 0 33.3916 6.7710266 45.444138 18.823578c12.052536 12.052521 18.823578 28.399261 18.823578 45.444122l0 0c0 35.49408 -28.773636 64.26773 -64.267715 64.26773l0 0c-35.49408 0 -64.267715 -28.773651 -64.267715 -64.26773z" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m120.51706 436.18896l0 0c0 -35.49408 28.773636 -64.2677 64.267715 -64.2677l0 0c17.04486 0 33.3916 6.7710266 45.444138 18.823578c12.052536 12.052521 18.823578 28.399261 18.823578 45.444122l0 0c0 35.49408 -28.773636 64.26773 -64.267715 64.26773l0 0c-35.49408 0 -64.267715 -28.773651 -64.267715 -64.26773z" fill-rule="evenodd"/><path fill="#000000" class="text invert" d="m172.06798 450.58896l-7.890625 -20.75l3.703125 0l4.453125 12.421875q0.71875 2.015625 1.328125 4.1875q0.46875 -1.640625 1.3125 -3.953125l4.609375 -12.65625l3.609375 0l-7.84375 20.75l-3.28125 0zm31.734375 -3.375l0 3.375l-18.921875 0q-0.046875 -1.265625 0.40625 -2.4375q0.71875 -1.9375 2.3125 -3.8125q1.59375 -1.875 4.59375 -4.34375q4.671875 -3.828125 6.3125 -6.0625q1.640625 -2.234375 1.640625 -4.21875q0 -2.09375 -1.5 -3.53125q-1.484375 -1.4375 -3.890625 -1.4375q-2.53125 0 -4.0625 1.53125q-1.515625 1.515625 -1.546875 4.21875l-3.609375 -0.375q0.375 -4.046875 2.796875 -6.15625q2.421875 -2.125 6.5 -2.125q4.125 0 6.515625 2.28125q2.40625 2.28125 2.40625 5.671875q0 1.71875 -0.703125 3.375q-0.703125 1.65625 -2.328125 3.5q-1.625 1.828125 -5.421875 5.03125q-3.15625 2.65625 -4.0625 3.609375q-0.890625 0.9375 -1.484375 1.90625l14.046875 0z" fill-rule="nonzero"/><path fill="#cfe2f3" d="m1060.3674 426.88452l0 0c0 -35.49408 28.773682 -64.26773 64.2677 -64.26773l0 0c17.044922 0 33.3916 6.771057 45.444214 18.823578c12.05249 12.052551 18.823486 28.399292 18.823486 45.444153l0 0c0 35.49408 -28.77356 64.2677 -64.2677 64.2677l0 0c-35.49402 0 -64.2677 -28.77362 -64.2677 -64.2677z" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m1060.3674 426.88452l0 0c0 -35.49408 28.773682 -64.26773 64.2677 -64.26773l0 0c17.044922 0 33.3916 6.771057 45.444214 18.823578c12.05249 12.052551 18.823486 28.399292 18.823486 45.444153l0 0c0 35.49408 -28.77356 64.2677 -64.2677 64.2677l0 0c-35.49402 0 -64.2677 -28.77362 -64.2677 -64.2677z" fill-rule="evenodd"/><path fill="#000000" class="text invert" d="m1111.9183 441.28452l-7.890625 -20.75l3.703125 0l4.453125 12.421875q0.71875 2.015625 1.328125 4.1875q0.46875 -1.640625 1.3125 -3.953125l4.609375 -12.65625l3.609375 0l-7.84375 20.75l-3.28125 0zm13.28125 -7.5625l3.515625 -0.46875q0.59375 2.984375 2.046875 4.3125q1.46875 1.3125 3.546875 1.3125q2.484375 0 4.1875 -1.71875q1.71875 -1.71875 1.71875 -4.25q0 -2.421875 -1.59375 -4.0q-1.578125 -1.578125 -4.015625 -1.578125q-1.0 0 -2.484375 0.390625l0.390625 -3.078125q0.359375 0.03125 0.578125 0.03125q2.234375 0 4.03125 -1.171875q1.796875 -1.171875 1.796875 -3.609375q0 -1.9375 -1.3125 -3.203125q-1.296875 -1.265625 -3.375 -1.265625q-2.046875 0 -3.421875 1.296875q-1.359375 1.28125 -1.75 3.859375l-3.515625 -0.625q0.640625 -3.53125 2.921875 -5.46875q2.296875 -1.953125 5.6875 -1.953125q2.34375 0 4.3125 1.015625q1.984375 1.0 3.03125 2.734375q1.046875 1.734375 1.046875 3.6875q0 1.859375 -1.0 3.390625q-1.0 1.515625 -2.953125 2.40625q2.546875 0.59375 3.953125 2.4375q1.40625 1.84375 1.40625 4.625q0 3.75 -2.734375 6.359375q-2.734375 2.609375 -6.921875 2.609375q-3.765625 0 -6.265625 -2.25q-2.484375 -2.25 -2.828125 -5.828125z" fill-rule="nonzero"/><path fill="#cfe2f3" d="m575.7323 436.18896l0 0c0 -35.49408 28.77362 -64.2677 64.2677 -64.2677l0 0c17.04486 0 33.3916 6.7710266 45.444153 18.823578c12.05249 12.052521 18.823547 28.399261 18.823547 45.444122l0 0c0 35.49408 -28.77362 64.26773 -64.2677 64.26773l0 0c-35.49408 0 -64.2677 -28.773651 -64.2677 -64.26773z" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m575.7323 436.18896l0 0c0 -35.49408 28.77362 -64.2677 64.2677 -64.2677l0 0c17.04486 0 33.3916 6.7710266 45.444153 18.823578c12.05249 12.052521 18.823547 28.399261 18.823547 45.444122l0 0c0 35.49408 -28.77362 64.26773 -64.2677 64.26773l0 0c-35.49408 0 -64.2677 -28.773651 -64.2677 -64.26773z" fill-rule="evenodd"/><path fill="#000000" class="text invert" d="m627.2832 450.58896l-7.890625 -20.75l3.703125 0l4.453125 12.421875q0.71875 2.015625 1.328125 4.1875q0.46875 -1.640625 1.3125 -3.953125l4.609375 -12.65625l3.609375 0l-7.84375 20.75l-3.28125 0zm26.5 0l-3.515625 0l0 -22.40625q-1.265625 1.21875 -3.328125 2.4375q-2.0625 1.203125 -3.703125 1.796875l0 -3.390625q2.953125 -1.390625 5.15625 -3.359375q2.203125 -1.96875 3.125 -3.828125l2.265625 0l0 28.75z" fill-rule="nonzero"/><path fill="#000000" fill-opacity="0.0" d="m249.05249 436.18896l326.6772 0" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m249.05249 436.18896l326.6772 0" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m704.2677 436.18896l356.09448 -9.291321" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m704.2677 436.18896l356.09448 -9.291321" fill-rule="evenodd"/><path fill="#000000" class="text" transform="translate(0, 8)" d="m495.57812 348.6966l2.859375 -0.25q0.203125 1.71875 0.9375 2.828125q0.75 1.09375 2.3125 1.78125q1.5625 0.671875 3.515625 0.671875q1.734375 0 3.0625 -0.515625q1.328125 -0.515625 1.96875 -1.40625q0.65625 -0.90625 0.65625 -1.96875q0 -1.078125 -0.625 -1.875q-0.625 -0.8125 -2.0625 -1.359375q-0.921875 -0.359375 -4.078125 -1.109375q-3.15625 -0.765625 -4.421875 -1.4375q-1.640625 -0.859375 -2.453125 -2.125q-0.796875 -1.28125 -0.796875 -2.859375q0 -1.734375 0.984375 -3.234375q0.984375 -1.515625 2.875 -2.296875q1.890625 -0.78125 4.203125 -0.78125q2.546875 0 4.484375 0.828125q1.953125 0.8125 3.0 2.40625q1.046875 1.59375 1.125 3.609375l-2.90625 0.21875q-0.234375 -2.171875 -1.59375 -3.28125q-1.34375 -1.109375 -3.984375 -1.109375q-2.75 0 -4.015625 1.015625q-1.25 1.0 -1.25 2.421875q0 1.234375 0.890625 2.03125q0.875 0.796875 4.5625 1.640625q3.703125 0.828125 5.078125 1.453125q2.0 0.921875 2.953125 2.34375q0.953125 1.40625 0.953125 3.25q0 1.828125 -1.046875 3.453125q-1.046875 1.609375 -3.015625 2.515625q-1.953125 0.890625 -4.40625 0.890625q-3.109375 0 -5.21875 -0.90625q-2.09375 -0.90625 -3.296875 -2.71875q-1.1875 -1.828125 -1.25 -4.125zm28.15625 4.84375l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796875 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm1.703125 -5.78125q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.921875 8.296875l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm21.515625 -2.046875q-1.5625 1.328125 -3.015625 1.875q-1.4375 0.546875 -3.09375 0.546875q-2.734375 0 -4.203125 -1.328125q-1.46875 -1.34375 -1.46875 -3.421875q0 -1.21875 0.546875 -2.21875q0.5625 -1.015625 1.453125 -1.625q0.90625 -0.609375 2.03125 -0.921875q0.828125 -0.21875 2.5 -0.421875q3.40625 -0.40625 5.015625 -0.96875q0.015625 -0.578125 0.015625 -0.734375q0 -1.71875 -0.796875 -2.421875q-1.078125 -0.953125 -3.203125 -0.953125q-1.984375 0 -2.9375 0.703125q-0.9375 0.6875 -1.390625 2.453125l-2.75 -0.375q0.375 -1.765625 1.234375 -2.84375q0.859375 -1.09375 2.484375 -1.671875q1.625 -0.59375 3.765625 -0.59375q2.125 0 3.453125 0.5q1.328125 0.5 1.953125 1.265625q0.625 0.75 0.875 1.90625q0.140625 0.71875 0.140625 2.59375l0 3.75q0 3.921875 0.171875 4.96875q0.1875 1.03125 0.71875 1.984375l-2.9375 0q-0.4375 -0.875 -0.5625 -2.046875zm-0.234375 -6.28125q-1.53125 0.625 -4.59375 1.0625q-1.734375 0.25 -2.453125 0.5625q-0.71875 0.3125 -1.109375 0.921875q-0.390625 0.59375 -0.390625 1.328125q0 1.125 0.84375 1.875q0.859375 0.75 2.5 0.75q1.625 0 2.890625 -0.703125q1.265625 -0.71875 1.859375 -1.953125q0.453125 -0.953125 0.453125 -2.8125l0 -1.03125zm6.6875 9.703125l2.734375 0.40625q0.171875 1.265625 0.953125 1.84375q1.046875 0.78125 2.859375 0.78125q1.953125 0 3.015625 -0.78125q1.0625 -0.78125 1.4375 -2.1875q0.21875 -0.859375 0.203125 -3.609375q-1.84375 2.171875 -4.59375 2.171875q-3.421875 0 -5.296875 -2.46875q-1.875 -2.46875 -1.875 -5.921875q0 -2.375 0.859375 -4.375q0.859375 -2.015625 2.484375 -3.109375q1.640625 -1.09375 3.84375 -1.09375q2.9375 0 4.84375 2.375l0 -2.0l2.59375 0l0 14.34375q0 3.875 -0.796875 5.484375q-0.78125 1.625 -2.5 2.5625q-1.703125 0.9375 -4.203125 0.9375q-2.96875 0 -4.796875 -1.34375q-1.828125 -1.328125 -1.765625 -4.015625zm2.328125 -9.96875q0 3.265625 1.296875 4.765625q1.296875 1.5 3.25 1.5q1.9375 0 3.25 -1.484375q1.3125 -1.5 1.3125 -4.6875q0 -3.046875 -1.359375 -4.59375q-1.34375 -1.546875 -3.25 -1.546875q-1.875 0 -3.1875 1.53125q-1.3125 1.515625 -1.3125 4.515625zm27.34375 3.25l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm13.5625 10.28125l6.640625 -23.6875l2.25 0l-6.625 23.6875l-2.265625 0zm11.453125 -0.390625l0 -22.90625l3.03125 0l0 9.40625l11.90625 0l0 -9.40625l3.03125 0l0 22.90625l-3.03125 0l0 -10.796875l-11.90625 0l0 10.796875l-3.03125 0zm33.53125 0l0 -2.4375q-1.9375 2.8125 -5.265625 2.8125q-1.46875 0 -2.75 -0.5625q-1.265625 -0.5625 -1.890625 -1.40625q-0.609375 -0.859375 -0.859375 -2.09375q-0.171875 -0.828125 -0.171875 -2.625l0 -10.28125l2.8125 0l0 9.203125q0 2.203125 0.171875 2.96875q0.265625 1.109375 1.125 1.75q0.859375 0.625 2.125 0.625q1.265625 0 2.375 -0.640625q1.109375 -0.65625 1.5625 -1.765625q0.46875 -1.125 0.46875 -3.25l0 -8.890625l2.8125 0l0 16.59375l-2.515625 0zm9.515625 0l-2.609375 0l0 -22.90625l2.8125 0l0 8.171875q1.78125 -2.234375 4.546875 -2.234375q1.53125 0 2.890625 0.625q1.375 0.609375 2.25 1.734375q0.890625 1.109375 1.390625 2.6875q0.5 1.578125 0.5 3.375q0 4.265625 -2.109375 6.59375q-2.109375 2.328125 -5.0625 2.328125q-2.9375 0 -4.609375 -2.453125l0 2.078125zm-0.03125 -8.421875q0 2.984375 0.8125 4.3125q1.328125 2.171875 3.59375 2.171875q1.84375 0 3.1875 -1.59375q1.34375 -1.609375 1.34375 -4.78125q0 -3.25 -1.296875 -4.796875q-1.28125 -1.546875 -3.109375 -1.546875q-1.84375 0 -3.1875 1.609375q-1.34375 1.59375 -1.34375 4.625zm28.734375 8.421875l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm22.75 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm15.640625 9.890625l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm9.5625 -4.953125l2.78125 -0.4375q0.234375 1.671875 1.296875 2.5625q1.078125 0.890625 3.0 0.890625q1.9375 0 2.875 -0.78125q0.9375 -0.796875 0.9375 -1.859375q0 -0.953125 -0.828125 -1.5q-0.578125 -0.375 -2.875 -0.953125q-3.09375 -0.78125 -4.296875 -1.34375q-1.1875 -0.578125 -1.8125 -1.578125q-0.609375 -1.015625 -0.609375 -2.234375q0 -1.109375 0.5 -2.046875q0.515625 -0.953125 1.390625 -1.578125q0.65625 -0.484375 1.78125 -0.8125q1.140625 -0.34375 2.4375 -0.34375q1.953125 0 3.421875 0.5625q1.484375 0.5625 2.1875 1.53125q0.703125 0.953125 0.96875 2.5625l-2.75 0.375q-0.1875 -1.28125 -1.09375 -2.0q-0.890625 -0.71875 -2.53125 -0.71875q-1.9375 0 -2.765625 0.640625q-0.828125 0.640625 -0.828125 1.5q0 0.546875 0.34375 0.984375q0.34375 0.453125 1.078125 0.75q0.421875 0.15625 2.484375 0.71875q2.984375 0.796875 4.15625 1.3125q1.1875 0.5 1.859375 1.46875q0.671875 0.96875 0.671875 2.40625q0 1.40625 -0.828125 2.65625q-0.8125 1.234375 -2.359375 1.921875q-1.546875 0.671875 -3.5 0.671875q-3.234375 0 -4.9375 -1.34375q-1.6875 -1.34375 -2.15625 -3.984375zm17.140625 -14.71875l0 -3.234375l2.8125 0l0 3.234375l-2.8125 0zm0 19.671875l0 -16.59375l2.8125 0l0 16.59375l-2.8125 0zm6.046875 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0z" fill-rule="nonzero"/><path fill="#cfe2f3" d="m619.48816 332.5013l-46.907715 -39.92914l19.9646 0l0 0c-25.05365 -70.51779 -112.57651 -119.7874 -212.7911 -119.7874l39.92914 0l0 0c100.21457 0 187.73746 49.269608 212.7911 119.7874l19.964539 0z" fill-rule="evenodd"/><path fill="#a5b4c2" d="m399.7185 173.44518l0 0c-113.16971 7.5024567 -199.80511 76.46913 -199.80511 159.05614l-39.92914 0l0 0c0 -44.88263 25.985397 -87.693954 71.59561 -117.95491c45.61023 -30.260956 106.63559 -45.178513 168.13864 -41.101227z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m399.7185 173.44518l0 0c-113.16971 7.5024567 -199.80511 76.46913 -199.80511 159.05614l-39.92914 0l0 0c0 -88.209 98.394226 -159.71654 219.76968 -159.71654l39.92914 0l0 0c100.21457 0 187.73746 49.269608 212.7911 119.7874l19.964539 0l-32.95056 39.92914l-46.907715 -39.92914l19.9646 0l0 0c-25.05365 -70.51779 -112.57651 -119.7874 -212.7911 -119.7874" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m399.7185 173.44518l0 0c-113.16971 7.5024567 -199.80511 76.46913 -199.80511 159.05614l-39.92914 0l0 0c0 -88.209 98.394226 -159.71654 219.76968 -159.71654l39.92914 0l0 0c100.21457 0 187.73746 49.269608 212.7911 119.7874l19.964539 0l-32.95056 39.92914l-46.907715 -39.92914l19.9646 0l0 0c-25.05365 -70.51779 -112.57651 -119.7874 -212.7911 -119.7874" fill-rule="evenodd"/><path fill="#cfe2f3" d="m683.3543 523.43304l47.112305 39.92914l-19.9646 0c25.787903 70.51782 115.875854 119.787415 219.02753 119.787415l-39.92914 0l0 0c-103.15167 0 -193.23962 -49.269592 -219.02753 -119.787415l-19.964539 0z" fill-rule="evenodd"/><path fill="#a5b4c2" d="m909.56494 682.52637l0 0c116.73816 -7.3029175 206.2461 -76.34723 206.2461 -159.09332l39.929077 0l0 0c0 44.810425 -26.661255 87.559814 -73.47705 117.815c-46.815796 30.255249 -109.479614 45.233093 -172.69812 41.27832z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m909.56494 682.52637l0 0c116.73816 -7.3029175 206.2461 -76.34723 206.2461 -159.09332l39.929077 0l0 0c0 88.209045 -101.277954 159.71655 -226.21057 159.71655l-39.92914 0l0 0c-103.15167 0 -193.23962 -49.269592 -219.02753 -119.787415l-19.964539 0l32.74597 -39.92914l47.112305 39.92914l-19.9646 0c25.787903 70.51782 115.875854 119.787415 219.02753 119.787415" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m909.56494 682.52637l0 0c116.73816 -7.3029175 206.2461 -76.34723 206.2461 -159.09332l39.929077 0l0 0c0 88.209045 -101.277954 159.71655 -226.21057 159.71655l-39.92914 0l0 0c-103.15167 0 -193.23962 -49.269592 -219.02753 -119.787415l-19.964539 0l32.74597 -39.92914l47.112305 39.92914l-19.9646 0c25.787903 70.51782 115.875854 119.787415 219.02753 119.787415" fill-rule="evenodd"/><path fill="#000000" class="text" d="m693.13855 139.93547l3.03125 0.765625q-0.953125 3.734375 -3.4375 5.703125q-2.46875 1.953125 -6.046875 1.953125q-3.703125 0 -6.03125 -1.5q-2.3125 -1.515625 -3.53125 -4.375q-1.203125 -2.859375 -1.203125 -6.140625q0 -3.578125 1.359375 -6.234375q1.375 -2.671875 3.890625 -4.046875q2.53125 -1.390625 5.5625 -1.390625q3.4375 0 5.78125 1.75q2.34375 1.75 3.265625 4.921875l-2.984375 0.703125q-0.796875 -2.5 -2.3125 -3.640625q-1.515625 -1.140625 -3.8125 -1.140625q-2.640625 0 -4.421875 1.265625q-1.765625 1.265625 -2.484375 3.40625q-0.71875 2.125 -0.71875 4.390625q0 2.921875 0.84375 5.109375q0.859375 2.171875 2.65625 3.25q1.796875 1.078125 3.890625 1.078125q2.546875 0 4.3125 -1.46875q1.765625 -1.46875 2.390625 -4.359375zm5.359375 -0.265625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm22.40625 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm22.75 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm15.640625 9.890625l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm16.828125 -2.515625l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796875 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm3.265625 2.515625l0 -22.90625l15.453125 0l0 2.703125l-12.421875 0l0 7.09375l10.75 0l0 2.703125l-10.75 0l0 10.40625l-3.03125 0zm19.0 0l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm9.640625 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.515625 0l0 2.328125q0.78125 -1.21875 2.078125 -1.953125q1.296875 -0.75 2.953125 -0.75q1.84375 0 3.015625 0.765625q1.1875 0.765625 1.671875 2.140625q1.96875 -2.90625 5.125 -2.90625q2.46875 0 3.796875 1.375q1.328125 1.359375 1.328125 4.203125l0 11.390625l-2.796875 0l0 -10.453125q0 -1.6875 -0.28125 -2.421875q-0.265625 -0.75 -0.984375 -1.203125q-0.71875 -0.453125 -1.6875 -0.453125q-1.75 0 -2.90625 1.171875q-1.15625 1.15625 -1.15625 3.71875l0 9.640625l-2.8125 0l0 -10.78125q0 -1.875 -0.6875 -2.8125q-0.6875 -0.9375 -2.25 -0.9375q-1.1875 0 -2.203125 0.625q-1.0 0.625 -1.453125 1.828125q-0.453125 1.203125 -0.453125 3.46875l0 8.609375l-2.8125 0zm32.03125 6.734375q-2.328125 -2.9375 -3.9375 -6.875q-1.609375 -3.9375 -1.609375 -8.15625q0 -3.71875 1.203125 -7.125q1.40625 -3.953125 4.34375 -7.875l2.015625 0q-1.890625 3.25 -2.5 4.640625q-0.953125 2.15625 -1.5 4.5q-0.671875 2.921875 -0.671875 5.875q0 7.515625 4.671875 15.015625l-2.015625 0zm7.125 0l-2.015625 0q4.671875 -7.5 4.671875 -15.015625q0 -2.9375 -0.671875 -5.828125q-0.53125 -2.34375 -1.484375 -4.5q-0.609375 -1.40625 -2.515625 -4.6875l2.015625 0q2.9375 3.921875 4.34375 7.875q1.203125 3.40625 1.203125 7.125q0 4.21875 -1.625 8.15625q-1.609375 3.9375 -3.921875 6.875zm17.703125 -6.734375l0 -16.59375l2.515625 0l0 2.328125q0.78125 -1.21875 2.078125 -1.953125q1.296875 -0.75 2.953125 -0.75q1.84375 0 3.015625 0.765625q1.1875 0.765625 1.671875 2.140625q1.96875 -2.90625 5.125 -2.90625q2.46875 0 3.796875 1.375q1.328125 1.359375 1.328125 4.203125l0 11.390625l-2.796875 0l0 -10.453125q0 -1.6875 -0.28125 -2.421875q-0.265625 -0.75 -0.984375 -1.203125q-0.71875 -0.453125 -1.6875 -0.453125q-1.75 0 -2.90625 1.171875q-1.15625 1.15625 -1.15625 3.71875l0 9.640625l-2.8125 0l0 -10.78125q0 -1.875 -0.6875 -2.8125q-0.6875 -0.9375 -2.25 -0.9375q-1.1875 0 -2.203125 0.625q-1.0 0.625 -1.453125 1.828125q-0.453125 1.203125 -0.453125 3.46875l0 8.609375l-2.8125 0zm38.015625 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm21.8125 7.375l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796875 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm2.75 2.515625l0 -22.90625l2.8125 0l0 8.21875q1.96875 -2.28125 4.96875 -2.28125q1.84375 0 3.203125 0.734375q1.359375 0.71875 1.9375 2.0q0.59375 1.28125 0.59375 3.71875l0 10.515625l-2.8125 0l0 -10.515625q0 -2.109375 -0.921875 -3.0625q-0.90625 -0.96875 -2.578125 -0.96875q-1.25 0 -2.359375 0.65625q-1.09375 0.640625 -1.5625 1.75q-0.46875 1.109375 -0.46875 3.0625l0 9.078125l-2.8125 0zm16.75 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm26.71875 8.296875l0 -2.09375q-1.578125 2.46875 -4.640625 2.46875q-1.984375 0 -3.65625 -1.09375q-1.65625 -1.09375 -2.578125 -3.046875q-0.90625 -1.96875 -0.90625 -4.515625q0 -2.484375 0.828125 -4.5q0.828125 -2.03125 2.484375 -3.109375q1.65625 -1.078125 3.703125 -1.078125q1.5 0 2.671875 0.640625q1.171875 0.625 1.90625 1.640625l0 -8.21875l2.796875 0l0 22.90625l-2.609375 0zm-8.890625 -8.28125q0 3.1875 1.34375 4.765625q1.34375 1.578125 3.171875 1.578125q1.84375 0 3.125 -1.5q1.296875 -1.515625 1.296875 -4.609375q0 -3.40625 -1.3125 -5.0q-1.3125 -1.59375 -3.234375 -1.59375q-1.875 0 -3.140625 1.53125q-1.25 1.53125 -1.25 4.828125zm23.765625 -0.015625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm31.296875 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm10.625 -6.046875l2.8125 -0.375q0.484375 2.390625 1.640625 3.453125q1.171875 1.046875 2.84375 1.046875q1.984375 0 3.34375 -1.375q1.375 -1.375 1.375 -3.40625q0 -1.9375 -1.265625 -3.1875q-1.265625 -1.265625 -3.21875 -1.265625q-0.796875 0 -1.984375 0.3125l0.3125 -2.46875q0.28125 0.03125 0.453125 0.03125q1.796875 0 3.234375 -0.9375q1.4375 -0.9375 1.4375 -2.890625q0 -1.546875 -1.046875 -2.5625q-1.046875 -1.015625 -2.703125 -1.015625q-1.640625 0 -2.734375 1.03125q-1.09375 1.03125 -1.40625 3.09375l-2.8125 -0.5q0.515625 -2.828125 2.34375 -4.375q1.828125 -1.5625 4.546875 -1.5625q1.875 0 3.453125 0.8125q1.578125 0.796875 2.40625 2.1875q0.84375 1.390625 0.84375 2.953125q0 1.484375 -0.796875 2.703125q-0.796875 1.21875 -2.359375 1.9375q2.03125 0.46875 3.15625 1.953125q1.125 1.46875 1.125 3.6875q0 3.0 -2.1875 5.09375q-2.1875 2.078125 -5.53125 2.078125q-3.015625 0 -5.015625 -1.796875q-1.984375 -1.796875 -2.265625 -4.65625z" fill-rule="nonzero"/><path fill="#000000" class="text" d="m734.1666 732.1113l3.03125 0.765625q-0.953125 3.734375 -3.4375 5.703125q-2.46875 1.953125 -6.046875 1.953125q-3.703125 0 -6.03125 -1.5q-2.3125 -1.515625 -3.53125 -4.375q-1.203125 -2.859375 -1.203125 -6.140625q0 -3.578125 1.359375 -6.234375q1.375 -2.671875 3.890625 -4.046875q2.53125 -1.390625 5.5625 -1.390625q3.4375 0 5.78125 1.75q2.34375 1.75 3.265625 4.921875l-2.984375 0.703125q-0.796875 -2.5 -2.3125 -3.640625q-1.515625 -1.140625 -3.8125 -1.140625q-2.640625 0 -4.421875 1.265625q-1.765625 1.265625 -2.484375 3.40625q-0.71875 2.125 -0.71875 4.390625q0 2.921875 0.84375 5.109375q0.859375 2.171875 2.65625 3.25q1.796875 1.078125 3.890625 1.078125q2.546875 0 4.3125 -1.46875q1.765625 -1.46875 2.390625 -4.359375zm5.359375 -0.265625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm22.40625 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm22.75 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm15.640625 9.890625l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm16.828125 -2.515625l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796875 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm8.9375 2.515625l0 -20.203125l-7.546875 0l0 -2.703125l18.15625 0l0 2.703125l-7.578125 0l0 20.203125l-3.03125 0zm8.765625 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm21.328125 15.03125q-2.328125 -2.9375 -3.9375 -6.875q-1.609375 -3.9375 -1.609375 -8.15625q0 -3.71875 1.203125 -7.125q1.40625 -3.953125 4.34375 -7.875l2.015625 0q-1.890625 3.25 -2.5 4.640625q-0.953125 2.15625 -1.5 4.5q-0.671875 2.921875 -0.671875 5.875q0 7.515625 4.671875 15.015625l-2.015625 0zm7.125 0l-2.015625 0q4.671875 -7.5 4.671875 -15.015625q0 -2.9375 -0.671875 -5.828125q-0.53125 -2.34375 -1.484375 -4.5q-0.609375 -1.40625 -2.515625 -4.6875l2.015625 0q2.9375 3.921875 4.34375 7.875q1.203125 3.40625 1.203125 7.125q0 4.21875 -1.625 8.15625q-1.609375 3.9375 -3.921875 6.875zm17.703125 -6.734375l0 -16.59375l2.515625 0l0 2.328125q0.78125 -1.21875 2.078125 -1.953125q1.296875 -0.75 2.953125 -0.75q1.84375 0 3.015625 0.765625q1.1875 0.765625 1.671875 2.140625q1.96875 -2.90625 5.125 -2.90625q2.46875 0 3.796875 1.375q1.328125 1.359375 1.328125 4.203125l0 11.390625l-2.796875 0l0 -10.453125q0 -1.6875 -0.28125 -2.421875q-0.265625 -0.75 -0.984375 -1.203125q-0.71875 -0.453125 -1.6875 -0.453125q-1.75 0 -2.90625 1.171875q-1.15625 1.15625 -1.15625 3.71875l0 9.640625l-2.8125 0l0 -10.78125q0 -1.875 -0.6875 -2.8125q-0.6875 -0.9375 -2.25 -0.9375q-1.1875 0 -2.203125 0.625q-1.0 0.625 -1.453125 1.828125q-0.453125 1.203125 -0.453125 3.46875l0 8.609375l-2.8125 0zm38.015625 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm21.812561 7.375l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375061 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796936 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm2.75 2.515625l0 -22.90625l2.8125 0l0 8.21875q1.96875 -2.28125 4.96875 -2.28125q1.84375 0 3.203125 0.734375q1.359375 0.71875 1.9375 2.0q0.59375 1.28125 0.59375 3.71875l0 10.515625l-2.8125 0l0 -10.515625q0 -2.109375 -0.921875 -3.0625q-0.90625 -0.96875 -2.578125 -0.96875q-1.25 0 -2.359375 0.65625q-1.09375 0.640625 -1.5625 1.75q-0.46875 1.109375 -0.46875 3.0625l0 9.078125l-2.8125 0zm16.75 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm26.71875 8.296875l0 -2.09375q-1.578125 2.46875 -4.640625 2.46875q-1.984375 0 -3.65625 -1.09375q-1.65625 -1.09375 -2.578125 -3.046875q-0.90625 -1.96875 -0.90625 -4.515625q0 -2.484375 0.828125 -4.5q0.828125 -2.03125 2.484375 -3.109375q1.65625 -1.078125 3.703125 -1.078125q1.5 0 2.671875 0.640625q1.171875 0.625 1.90625 1.640625l0 -8.21875l2.796875 0l0 22.90625l-2.609375 0zm-8.890625 -8.28125q0 3.1875 1.34375 4.765625q1.34375 1.578125 3.171875 1.578125q1.84375 0 3.125 -1.5q1.296875 -1.515625 1.296875 -4.609375q0 -3.40625 -1.3125 -5.0q-1.3125 -1.59375 -3.234375 -1.59375q-1.875 0 -3.140625 1.53125q-1.25 1.53125 -1.25 4.828125zm23.765625 -0.015625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953064 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm31.296875 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm10.625 -6.046875l2.8125 -0.375q0.484375 2.390625 1.640625 3.453125q1.171875 1.046875 2.84375 1.046875q1.984375 0 3.34375 -1.375q1.375 -1.375 1.375 -3.40625q0 -1.9375 -1.265625 -3.1875q-1.265625 -1.265625 -3.21875 -1.265625q-0.796875 0 -1.984375 0.3125l0.3125 -2.46875q0.28125 0.03125 0.453125 0.03125q1.796875 0 3.234375 -0.9375q1.4375 -0.9375 1.4375 -2.890625q0 -1.546875 -1.046875 -2.5625q-1.046875 -1.015625 -2.703125 -1.015625q-1.640625 0 -2.734375 1.03125q-1.09375 1.03125 -1.40625 3.09375l-2.8125 -0.5q0.515625 -2.828125 2.34375 -4.375q1.828125 -1.5625 4.546875 -1.5625q1.875 0 3.453125 0.8125q1.578125 0.796875 2.40625 2.1875q0.84375 1.390625 0.84375 2.953125q0 1.484375 -0.796875 2.703125q-0.796875 1.21875 -2.359375 1.9375q2.03125 0.46875 3.15625 1.953125q1.125 1.46875 1.125 3.6875q0 3.0 -2.1875 5.09375q-2.1875 2.078125 -5.53125 2.078125q-3.015625 0 -5.015625 -1.796875q-1.984375 -1.796875 -2.265625 -4.65625z" fill-rule="nonzero"/><path fill="#cfe2f3" d="m1123.5197 332.4672l-46.907715 -39.92914l19.9646 0l0 0c-25.05371 -70.51779 -112.57648 -119.7874 -212.79108 -119.7874l39.929077 0l0 0c100.2146 0 187.73749 49.269608 212.79108 119.7874l19.9646 0z" fill-rule="evenodd"/><path fill="#a5b4c2" d="m903.75 173.41106l0 0c-113.16968 7.5024567 -199.80511 76.46913 -199.80511 159.05614l-39.92914 0l0 0c0 -44.88263 25.985413 -87.69397 71.59564 -117.95491c45.61023 -30.260956 106.63556 -45.178513 168.13861 -41.101227z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m903.75 173.41106l0 0c-113.16968 7.5024567 -199.80511 76.46913 -199.80511 159.05614l-39.92914 0l0 0c0 -88.209015 98.394226 -159.71654 219.76971 -159.71654l39.929077 0l0 0c100.2146 0 187.73749 49.269608 212.79108 119.7874l19.9646 0l-32.95056 39.92914l-46.907715 -39.92914l19.9646 0l0 0c-25.05371 -70.51779 -112.57648 -119.7874 -212.79108 -119.7874" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m903.75 173.41106l0 0c-113.16968 7.5024567 -199.80511 76.46913 -199.80511 159.05614l-39.92914 0l0 0c0 -88.209015 98.394226 -159.71654 219.76971 -159.71654l39.929077 0l0 0c100.2146 0 187.73749 49.269608 212.79108 119.7874l19.9646 0l-32.95056 39.92914l-46.907715 -39.92914l19.9646 0l0 0c-25.05371 -70.51779 -112.57648 -119.7874 -212.79108 -119.7874" fill-rule="evenodd"/><path fill="#cfe2f3" d="m187.46457 523.7139l46.742706 39.92914l-19.964554 0l0 0c24.461197 70.51776 109.91441 119.78735 207.75926 119.78735l-39.92914 0l0 0c-97.84485 0 -183.29805 -49.269592 -207.75926 -119.78735l-19.96457 0z" fill-rule="evenodd"/><path fill="#a5b4c2" d="m402.0374 682.7376l0 0c110.29004 -7.67157 194.60828 -76.57202 194.60828 -159.02368l39.92914 0l0 0c0 44.94403 -25.440186 87.808105 -70.07782 118.07379c-44.637573 30.265686 -104.34097 45.131653 -164.4596 40.94989z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m402.0374 682.7376l0 0c110.29004 -7.67157 194.60828 -76.57202 194.60828 -159.02368l39.92914 0l0 0c0 88.208984 -96.067566 159.71649 -214.57285 159.71649l-39.92914 0l0 0c-97.84485 0 -183.29805 -49.269592 -207.75926 -119.78735l-19.96457 0l33.115555 -39.92914l46.742706 39.92914l-19.964554 0l0 0c24.461197 70.51776 109.91441 119.78735 207.75926 119.78735" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m402.0374 682.7376l0 0c110.29004 -7.67157 194.60828 -76.57202 194.60828 -159.02368l39.92914 0l0 0c0 88.208984 -96.067566 159.71649 -214.57285 159.71649l-39.92914 0l0 0c-97.84485 0 -183.29805 -49.269592 -207.75926 -119.78735l-19.96457 0l33.115555 -39.92914l46.742706 39.92914l-19.964554 0l0 0c24.461197 70.51776 109.91441 119.78735 207.75926 119.78735" fill-rule="evenodd"/><path fill="#000000" class="text" d="m193.07555 732.1113l3.03125 0.765625q-0.953125 3.734375 -3.4375 5.703125q-2.46875 1.953125 -6.046875 1.953125q-3.703125 0 -6.03125 -1.5q-2.3125 -1.515625 -3.53125 -4.375q-1.203125 -2.859375 -1.203125 -6.140625q0 -3.578125 1.359375 -6.234375q1.375 -2.671875 3.890625 -4.046875q2.53125 -1.390625 5.5625 -1.390625q3.4375 0 5.78125 1.75q2.34375 1.75 3.265625 4.921875l-2.984375 0.703125q-0.796875 -2.5 -2.3125 -3.640625q-1.515625 -1.140625 -3.8125 -1.140625q-2.640625 0 -4.421875 1.265625q-1.765625 1.265625 -2.484375 3.40625q-0.71875 2.125 -0.71875 4.390625q0 2.921875 0.84375 5.109375q0.859375 2.171875 2.65625 3.25q1.796875 1.078125 3.890625 1.078125q2.546875 0 4.3125 -1.46875q1.765625 -1.46875 2.390625 -4.359375zm5.359375 -0.265625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm22.40625 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm22.749985 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.6406097 0 -5.7812347 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.5937347 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.374985 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.4687347 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.23436 -4.546875l9.26561 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9374847 0 -3.2656097 1.296875q-1.3125 1.296875 -1.453125 3.46875zm15.64061 9.890625l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm16.828125 -2.515625l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796875 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm3.265625 2.515625l0 -22.90625l15.453125 0l0 2.703125l-12.421875 0l0 7.09375l10.75 0l0 2.703125l-10.75 0l0 10.40625l-3.03125 0zm19.0 0l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm9.640625 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.515625 0l0 2.328125q0.78125 -1.21875 2.078125 -1.953125q1.296875 -0.75 2.953125 -0.75q1.84375 0 3.015625 0.765625q1.1875 0.765625 1.671875 2.140625q1.96875 -2.90625 5.125 -2.90625q2.46875 0 3.796875 1.375q1.328125 1.359375 1.328125 4.203125l0 11.390625l-2.796875 0l0 -10.453125q0 -1.6875 -0.28125 -2.421875q-0.265625 -0.75 -0.984375 -1.203125q-0.71875 -0.453125 -1.6875 -0.453125q-1.75 0 -2.90625 1.171875q-1.15625 1.15625 -1.15625 3.71875l0 9.640625l-2.8125 0l0 -10.78125q0 -1.875 -0.6875 -2.8125q-0.6875 -0.9375 -2.25 -0.9375q-1.1875 0 -2.203125 0.625q-1.0 0.625 -1.453125 1.828125q-0.453125 1.203125 -0.453125 3.46875l0 8.609375l-2.8125 0zm32.03125 6.734375q-2.328125 -2.9375 -3.9375 -6.875q-1.609375 -3.9375 -1.609375 -8.15625q0 -3.71875 1.203125 -7.125q1.40625 -3.953125 4.34375 -7.875l2.015625 0q-1.890625 3.25 -2.5 4.640625q-0.953125 2.15625 -1.5 4.5q-0.671875 2.921875 -0.671875 5.875q0 7.515625 4.671875 15.015625l-2.015625 0zm7.125 0l-2.015625 0q4.671875 -7.5 4.671875 -15.015625q0 -2.9375 -0.671875 -5.828125q-0.53125 -2.34375 -1.484375 -4.5q-0.609375 -1.40625 -2.515625 -4.6875l2.015625 0q2.9375 3.921875 4.34375 7.875q1.203125 3.40625 1.203125 7.125q0 4.21875 -1.625 8.15625q-1.609375 3.9375 -3.921875 6.875zm17.703125 -6.734375l0 -16.59375l2.515625 0l0 2.328125q0.78125 -1.21875 2.078125 -1.953125q1.296875 -0.75 2.953125 -0.75q1.84375 0 3.015625 0.765625q1.1875 0.765625 1.671875 2.140625q1.96875 -2.90625 5.125 -2.90625q2.46875 0 3.796875 1.375q1.328125 1.359375 1.328125 4.203125l0 11.390625l-2.796875 0l0 -10.453125q0 -1.6875 -0.28125 -2.421875q-0.265625 -0.75 -0.984375 -1.203125q-0.71875 -0.453125 -1.6875 -0.453125q-1.75 0 -2.90625 1.171875q-1.15625 1.15625 -1.15625 3.71875l0 9.640625l-2.8125 0l0 -10.78125q0 -1.875 -0.6875 -2.8125q-0.6875 -0.9375 -2.25 -0.9375q-1.1875 0 -2.203125 0.625q-1.0 0.625 -1.453125 1.828125q-0.453125 1.203125 -0.453125 3.46875l0 8.609375l-2.8125 0zm38.015656 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.1250305 -2.25 -2.1250305 -6.296875q0 -4.1875 2.1562805 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm21.8125 7.375l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.109375l2.796875 -1.6875l0 5.796875l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm2.75 2.515625l0 -22.90625l2.8125 0l0 8.21875q1.96875 -2.28125 4.96875 -2.28125q1.84375 0 3.203125 0.734375q1.359375 0.71875 1.9375 2.0q0.59375 1.28125 0.59375 3.71875l0 10.515625l-2.8125 0l0 -10.515625q0 -2.109375 -0.921875 -3.0625q-0.90625 -0.96875 -2.578125 -0.96875q-1.25 0 -2.359375 0.65625q-1.09375 0.640625 -1.5625 1.75q-0.46875 1.109375 -0.46875 3.0625l0 9.078125l-2.8125 0zm16.75 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm26.71875 8.296875l0 -2.09375q-1.578125 2.46875 -4.640625 2.46875q-1.984375 0 -3.65625 -1.09375q-1.65625 -1.09375 -2.578125 -3.046875q-0.90625 -1.96875 -0.90625 -4.515625q0 -2.484375 0.828125 -4.5q0.828125 -2.03125 2.484375 -3.109375q1.65625 -1.078125 3.703125 -1.078125q1.5 0 2.671875 0.640625q1.171875 0.625 1.90625 1.640625l0 -8.21875l2.796875 0l0 22.90625l-2.609375 0zm-8.890625 -8.28125q0 3.1875 1.34375 4.765625q1.34375 1.578125 3.171875 1.578125q1.84375 0 3.125 -1.5q1.296875 -1.515625 1.296875 -4.609375q0 -3.40625 -1.3125 -5.0q-1.3125 -1.59375 -3.234375 -1.59375q-1.875 0 -3.140625 1.53125q-1.25 1.53125 -1.25 4.828125zm23.765625 -0.015625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm31.296875 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm25.390625 -2.703125l0 2.703125l-15.140625 0q-0.03125 -1.015625 0.328125 -1.953125q0.578125 -1.546875 1.84375 -3.046875q1.28125 -1.5 3.6875 -3.46875q3.734375 -3.0625 5.046875 -4.84375q1.3125 -1.796875 1.3125 -3.390625q0 -1.671875 -1.203125 -2.8125q-1.1875 -1.15625 -3.109375 -1.15625q-2.03125 0 -3.25 1.21875q-1.21875 1.21875 -1.234375 3.375l-2.890625 -0.296875q0.296875 -3.234375 2.234375 -4.921875q1.9375 -1.703125 5.203125 -1.703125q3.296875 0 5.21875 1.828125q1.921875 1.828125 1.921875 4.53125q0 1.375 -0.5625 2.703125q-0.5625 1.328125 -1.875 2.796875q-1.296875 1.46875 -4.328125 4.03125q-2.53125 2.125 -3.25 2.890625q-0.71875 0.75 -1.1875 1.515625l11.234375 0z" fill-rule="nonzero"/><path fill="#000000" class="text" d="m230.13515 138.32655l3.03125 0.765625q-0.953125 3.734375 -3.4375 5.703125q-2.46875 1.953125 -6.046875 1.953125q-3.703125 0 -6.03125 -1.5q-2.3125 -1.515625 -3.53125 -4.375q-1.203125 -2.859375 -1.203125 -6.140625q0 -3.578125 1.359375 -6.234375q1.375 -2.6718826 3.890625 -4.0468826q2.53125 -1.390625 5.5625 -1.390625q3.4375 0 5.78125 1.75q2.34375 1.75 3.265625 4.9218826l-2.984375 0.703125q-0.796875 -2.5000076 -2.3125 -3.6406326q-1.515625 -1.140625 -3.8125 -1.140625q-2.640625 0 -4.421875 1.265625q-1.765625 1.2656326 -2.484375 3.4062576q-0.71875 2.125 -0.71875 4.390625q0 2.921875 0.84375 5.109375q0.859375 2.171875 2.65625 3.25q1.796875 1.078125 3.890625 1.078125q2.546875 0 4.3125 -1.46875q1.765625 -1.46875 2.390625 -4.359375zm5.359375 -0.265625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.953125 8.296875l0 -16.59375l2.5312653 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125153 0zm22.406265 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm22.75 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm15.640625 9.890625l0 -16.59375l2.53125 0l0 2.515625q0.96875 -1.765625 1.78125 -2.328125q0.828125 -0.5625 1.8125 -0.5625q1.421875 0 2.890625 0.90625l-0.96875 2.609375q-1.03125 -0.609375 -2.0625 -0.609375q-0.921875 0 -1.65625 0.5625q-0.734375 0.546875 -1.046875 1.53125q-0.46875 1.5 -0.46875 3.28125l0 8.6875l-2.8125 0zm16.828125 -2.515625l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.1093826l2.796875 -1.6875l0 5.7968826l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm8.9375 2.515625l0 -20.203133l-7.546875 0l0 -2.703125l18.15625 0l0 2.703125l-7.578125 0l0 20.203133l-3.03125 0zm8.765625 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm21.328125 15.03125q-2.328125 -2.9375 -3.9375 -6.875q-1.609375 -3.9375 -1.609375 -8.15625q0 -3.71875 1.203125 -7.125q1.40625 -3.9531326 4.34375 -7.8750076l2.015625 0q-1.890625 3.25 -2.5 4.640625q-0.953125 2.1562576 -1.5 4.5000076q-0.671875 2.921875 -0.671875 5.875q0 7.515625 4.671875 15.015625l-2.015625 0zm7.125 0l-2.015625 0q4.671875 -7.5 4.671875 -15.015625q0 -2.9375 -0.671875 -5.828125q-0.53125 -2.34375 -1.484375 -4.5000076q-0.609375 -1.40625 -2.515625 -4.6875l2.015625 0q2.9375 3.921875 4.34375 7.8750076q1.203125 3.40625 1.203125 7.125q0 4.21875 -1.625 8.15625q-1.609375 3.9375 -3.921875 6.875zm17.703125 -6.734375l0 -16.59375l2.515625 0l0 2.328125q0.78125 -1.21875 2.078125 -1.953125q1.296875 -0.75 2.953125 -0.75q1.84375 0 3.015625 0.765625q1.1875 0.765625 1.671875 2.140625q1.96875 -2.90625 5.125 -2.90625q2.46875 0 3.796875 1.375q1.328125 1.359375 1.328125 4.203125l0 11.390625l-2.796875 0l0 -10.453125q0 -1.6875 -0.28125 -2.421875q-0.265625 -0.75 -0.984375 -1.203125q-0.71875 -0.453125 -1.6875 -0.453125q-1.75 0 -2.90625 1.171875q-1.15625 1.15625 -1.15625 3.71875l0 9.640625l-2.8125 0l0 -10.78125q0 -1.875 -0.6875 -2.8125q-0.6875 -0.9375 -2.25 -0.9375q-1.1875 0 -2.203125 0.625q-1.0 0.625 -1.453125 1.828125q-0.453125 1.203125 -0.453125 3.46875l0 8.609375l-2.8125 0zm38.015625 -5.34375l2.90625 0.359375q-0.6875 2.546875 -2.546875 3.953125q-1.859375 1.40625 -4.75 1.40625q-3.640625 0 -5.78125 -2.234375q-2.125 -2.25 -2.125 -6.296875q0 -4.1875 2.15625 -6.5q2.15625 -2.3125 5.59375 -2.3125q3.328125 0 5.4375 2.265625q2.109375 2.265625 2.109375 6.375q0 0.25 -0.015625 0.75l-12.375 0q0.15625 2.734375 1.546875 4.1875q1.390625 1.453125 3.46875 1.453125q1.546875 0 2.640625 -0.8125q1.09375 -0.8125 1.734375 -2.59375zm-9.234375 -4.546875l9.265625 0q-0.1875 -2.09375 -1.0625 -3.140625q-1.34375 -1.625 -3.484375 -1.625q-1.9375 0 -3.265625 1.296875q-1.3125 1.296875 -1.453125 3.46875zm21.8125 7.375l0.40625 2.484375q-1.1875 0.25 -2.125 0.25q-1.53125 0 -2.375 -0.484375q-0.84375 -0.484375 -1.1875 -1.265625q-0.34375 -0.796875 -0.34375 -3.328125l0 -9.546875l-2.0625 0l0 -2.1875l2.0625 0l0 -4.1093826l2.796875 -1.6875l0 5.7968826l2.828125 0l0 2.1875l-2.828125 0l0 9.703125q0 1.203125 0.140625 1.546875q0.15625 0.34375 0.484375 0.546875q0.34375 0.203125 0.96875 0.203125q0.46875 0 1.234375 -0.109375zm2.75 2.515625l0 -22.906258l2.8125 0l0 8.218758q1.96875 -2.28125 4.96875 -2.28125q1.84375 0 3.203125 0.734375q1.359375 0.71875 1.9375 2.0q0.59375 1.28125 0.59375 3.71875l0 10.515625l-2.8125 0l0 -10.515625q0 -2.109375 -0.921875 -3.0625q-0.90625 -0.96875 -2.578125 -0.96875q-1.25 0 -2.359375 0.65625q-1.09375 0.640625 -1.5625 1.75q-0.46875 1.109375 -0.46875 3.0625l0 9.078125l-2.8125 0zm16.75 -8.296875q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.421875 0 5.59375 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.09375 0 3.484375 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.46875 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm26.71875 8.296875l0 -2.09375q-1.578125 2.46875 -4.640625 2.46875q-1.984375 0 -3.65625 -1.09375q-1.65625 -1.09375 -2.578125 -3.046875q-0.90625 -1.96875 -0.90625 -4.515625q0 -2.484375 0.828125 -4.5q0.828125 -2.03125 2.484375 -3.109375q1.65625 -1.078125 3.703125 -1.078125q1.5 0 2.671875 0.640625q1.171875 0.625 1.90625 1.640625l0 -8.218758l2.796875 0l0 22.906258l-2.609375 0zm-8.890625 -8.28125q0 3.1875 1.34375 4.765625q1.34375 1.578125 3.171875 1.578125q1.84375 0 3.125 -1.5q1.296875 -1.515625 1.296875 -4.609375q0 -3.40625 -1.3125 -5.0q-1.3125 -1.59375 -3.234375 -1.59375q-1.875 0 -3.140625 1.53125q-1.25 1.53125 -1.25 4.828125zm23.765625 -0.015625q0 -4.609375 2.5625 -6.828125q2.140625 -1.84375 5.21875 -1.84375q3.4219055 0 5.5937805 2.25q2.171875 2.234375 2.171875 6.1875q0 3.203125 -0.96875 5.046875q-0.953125 1.828125 -2.796875 2.84375q-1.828125 1.015625 -4.0000305 1.015625q-3.484375 0 -5.640625 -2.234375q-2.140625 -2.234375 -2.140625 -6.4375zm2.890625 0q0 3.1875 1.390625 4.78125q1.390625 1.578125 3.5 1.578125q2.0937805 0 3.4844055 -1.59375q1.390625 -1.59375 1.390625 -4.859375q0 -3.078125 -1.40625 -4.65625q-1.390625 -1.59375 -3.4687805 -1.59375q-2.109375 0 -3.5 1.578125q-1.390625 1.578125 -1.390625 4.765625zm15.9531555 8.296875l0 -16.59375l2.53125 0l0 2.359375q1.828125 -2.734375 5.28125 -2.734375q1.5 0 2.75 0.546875q1.265625 0.53125 1.890625 1.40625q0.625 0.875 0.875 2.078125q0.15625 0.78125 0.15625 2.734375l0 10.203125l-2.8125 0l0 -10.09375q0 -1.71875 -0.328125 -2.5625q-0.328125 -0.859375 -1.171875 -1.359375q-0.828125 -0.515625 -1.953125 -0.515625q-1.796875 0 -3.109375 1.140625q-1.296875 1.140625 -1.296875 4.328125l0 9.0625l-2.8125 0zm31.296875 0l-6.3125 -16.59375l2.96875 0l3.5625 9.9375q0.578125 1.609375 1.0625 3.34375q0.375 -1.3125 1.046875 -3.15625l3.6875 -10.125l2.890625 0l-6.28125 16.59375l-2.625 0zm25.390625 -2.703125l0 2.703125l-15.140625 0q-0.03125 -1.015625 0.328125 -1.953125q0.578125 -1.546875 1.84375 -3.046875q1.28125 -1.5 3.6875 -3.46875q3.734375 -3.0625 5.046875 -4.84375q1.3125 -1.796875 1.3125 -3.390625q0 -1.6718826 -1.203125 -2.8125076q-1.1875 -1.15625 -3.109375 -1.15625q-2.03125 0 -3.25 1.21875q-1.21875 1.2187576 -1.234375 3.3750076l-2.890625 -0.296875q0.296875 -3.2343826 2.234375 -4.9218826q1.9375 -1.703125 5.203125 -1.703125q3.296875 0 5.21875 1.828125q1.921875 1.828125 1.921875 4.5312576q0 1.375 -0.5625 2.703125q-0.5625 1.328125 -1.875 2.796875q-1.296875 1.46875 -4.328125 4.03125q-2.53125 2.125 -3.25 2.890625q-0.71875 0.75 -1.1875 1.515625l11.234375 0z" fill-rule="nonzero"/></g></svg>
</div>
<p>This cuts down on the number of conversion functions that we have to
define, and is modeled off of what Kubernetes does internally.</p>
<h2><a class="header" href="#what-does-that-have-to-do-with-webhooks" id="what-does-that-have-to-do-with-webhooks">What does that have to do with Webhooks?</a></h2>
<p>When API clients, like kubectl or your controller, request a particular
version of your resource, the Kubernetes API server needs to return
a result that’s of that version.  However, that version might not match
the version stored by the API server.</p>
<p>In that case, the API server needs to know how to convert between the
desired version and the stored version.  Since the conversions aren’t
built in for CRDs, the Kubernetes API server calls out to a webhook to do
the conversion instead.  For KubeBuilder, this webhook is implemented by
controller-runtime, and performs the hub-and-spoke conversions that we
discussed above.</p>
<p>Now that we have the model for conversion down pat, we can actually
implement our conversions.</p>
<h1><a class="header" href="#implementing-conversion" id="implementing-conversion">Implementing conversion</a></h1>
<p>With our model for conversion in place, it’s time to actually implement
the conversion functions.  We’ll put them in a file called
<code>cronjob_conversion.go</code> next to our <code>cronjob_types.go</code> file, to avoid
cluttering up our main types file with extra functions.</p>
<h2><a class="header" href="#hub" id="hub">Hub...</a></h2>
<p>First, we’ll implement the hub.  We’ll choose the v1 version as the hub:</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/multiversion-tutorial/testdata/project/api/v1/cronjob_conversion.go">project/api/v1/cronjob_conversion.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<pre><code class="language-go">package v1
</code></pre>
<p>Implementing the hub method is pretty easy -- we just have to add an empty
method called <code>Hub()</code> to serve as a
<a href="https://godoc.org/sigs.k8s.io/controller-runtime/pkg/conversion#Hub">marker</a>.
We could also just put this inline in our <code>cronjob_types.go</code> file.</p>
<pre><code class="language-go">// Hub marks this type as a conversion hub.
func (*CronJob) Hub() {}
</code></pre>
</div>
<h2><a class="header" href="#-and-spokes" id="-and-spokes">... and Spokes</a></h2>
<p>Then, we’ll implement our spoke, the v2 version:</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/multiversion-tutorial/testdata/project/api/v2/cronjob_conversion.go">project/api/v2/cronjob_conversion.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details>
<pre><code class="language-go">package v2
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<p>For imports, we’ll need the controller-runtime
<a href="https://godoc.org/sigs.k8s.io/controller-runtime/pkg/conversion"><code>conversion</code></a>
package, plus the API version for our hub type (v1), and finally some of the
standard packages.</p>
<pre><code class="language-go">import (
	&quot;fmt&quot;
	&quot;strings&quot;

	&quot;sigs.k8s.io/controller-runtime/pkg/conversion&quot;

	&quot;tutorial.kubebuilder.io/project/api/v1&quot;
)
</code></pre>
</details>
<p>Our “spoke” versions need to implement the
<a href="https://godoc.org/sigs.k8s.io/controller-runtime/pkg/conversion#Convertible"><code>Convertible</code></a>
interface.  Namely, they’ll need <code>ConvertTo</code> and <code>ConvertFrom</code> methods to convert to/from
the hub version.</p>
<p>ConvertTo is expected to modify its argument to contain the converted object.
Most of the conversion is straightforward copying, except for converting our changed field.</p>
<pre><code class="language-go">// ConvertTo converts this CronJob to the Hub version (v1).
func (src *CronJob) ConvertTo(dstRaw conversion.Hub) error {
	dst := dstRaw.(*v1.CronJob)

	sched := src.Spec.Schedule
	scheduleParts := []string{&quot;*&quot;, &quot;*&quot;, &quot;*&quot;, &quot;*&quot;, &quot;*&quot;}
	if sched.Minute != nil {
		scheduleParts[0] = string(*sched.Minute)
	}
	if sched.Hour != nil {
		scheduleParts[1] = string(*sched.Hour)
	}
	if sched.DayOfMonth != nil {
		scheduleParts[2] = string(*sched.DayOfMonth)
	}
	if sched.Month != nil {
		scheduleParts[3] = string(*sched.Month)
	}
	if sched.DayOfWeek != nil {
		scheduleParts[4] = string(*sched.DayOfWeek)
	}
	dst.Spec.Schedule = strings.Join(scheduleParts, &quot; &quot;)
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">rote conversion</span></pre></summary>
<p>The rest of the conversion is pretty rote.</p>
<pre><code class="language-go">	// ObjectMeta
	dst.ObjectMeta = src.ObjectMeta

	// Spec
	dst.Spec.StartingDeadlineSeconds = src.Spec.StartingDeadlineSeconds
	dst.Spec.ConcurrencyPolicy = v1.ConcurrencyPolicy(src.Spec.ConcurrencyPolicy)
	dst.Spec.Suspend = src.Spec.Suspend
	dst.Spec.JobTemplate = src.Spec.JobTemplate
	dst.Spec.SuccessfulJobsHistoryLimit = src.Spec.SuccessfulJobsHistoryLimit
	dst.Spec.FailedJobsHistoryLimit = src.Spec.FailedJobsHistoryLimit

	// Status
	dst.Status.Active = src.Status.Active
	dst.Status.LastScheduleTime = src.Status.LastScheduleTime
</code></pre>
</details>
<pre><code class="language-go">	return nil
}
</code></pre>
<p>ConvertFrom is expected to modify its receiver to contain the converted object.
Most of the conversion is straightforward copying, except for converting our changed field.</p>
<pre><code class="language-go">// ConvertFrom converts from the Hub version (v1) to this version.
func (dst *CronJob) ConvertFrom(srcRaw conversion.Hub) error {
	src := srcRaw.(*v1.CronJob)

	schedParts := strings.Split(src.Spec.Schedule, &quot; &quot;)
	if len(schedParts) != 5 {
		return fmt.Errorf(&quot;invalid schedule: not a standard 5-field schedule&quot;)
	}
	partIfNeeded := func(raw string) *CronField {
		if raw == &quot;*&quot; {
			return nil
		}
		part := CronField(raw)
		return &amp;part
	}
	dst.Spec.Schedule.Minute = partIfNeeded(schedParts[0])
	dst.Spec.Schedule.Hour = partIfNeeded(schedParts[1])
	dst.Spec.Schedule.DayOfMonth = partIfNeeded(schedParts[2])
	dst.Spec.Schedule.Month = partIfNeeded(schedParts[3])
	dst.Spec.Schedule.DayOfWeek = partIfNeeded(schedParts[4])
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">rote conversion</span></pre></summary>
<p>The rest of the conversion is pretty rote.</p>
<pre><code class="language-go">	// ObjectMeta
	dst.ObjectMeta = src.ObjectMeta

	// Spec
	dst.Spec.StartingDeadlineSeconds = src.Spec.StartingDeadlineSeconds
	dst.Spec.ConcurrencyPolicy = ConcurrencyPolicy(src.Spec.ConcurrencyPolicy)
	dst.Spec.Suspend = src.Spec.Suspend
	dst.Spec.JobTemplate = src.Spec.JobTemplate
	dst.Spec.SuccessfulJobsHistoryLimit = src.Spec.SuccessfulJobsHistoryLimit
	dst.Spec.FailedJobsHistoryLimit = src.Spec.FailedJobsHistoryLimit

	// Status
	dst.Status.Active = src.Status.Active
	dst.Status.LastScheduleTime = src.Status.LastScheduleTime
</code></pre>
</details>
<pre><code class="language-go">	return nil
}
</code></pre>
</div>
<p>Now that we’ve got our conversions in place, all that we need to do is
wire up our main to serve the webhook!</p>
<h1><a class="header" href="#setting-up-the-webhooks" id="setting-up-the-webhooks">Setting up the webhooks</a></h1>
<p>Our conversion is in place, so all that’s left is to tell
controller-runtime about our conversion.</p>
<p>Normally, we’d run</p>
<pre><code class="language-shell">kubebuilder create webhook --group batch --version v1 --kind CronJob --conversion
</code></pre>
<p>to scaffold out the webhook setup.  However, we’ve already got webhook
setup, from when we built our defaulting and validating webhooks!</p>
<h2><a class="header" href="#webhook-setup" id="webhook-setup">Webhook setup...</a></h2>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/multiversion-tutorial/testdata/project/api/v1/cronjob_webhook.go">project/api/v1/cronjob_webhook.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Go imports</span></pre></summary>
<pre><code class="language-go">package v1

import (
	&quot;github.com/robfig/cron&quot;
	apierrors &quot;k8s.io/apimachinery/pkg/api/errors&quot;
	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;
	validationutils &quot;k8s.io/apimachinery/pkg/util/validation&quot;
	&quot;k8s.io/apimachinery/pkg/util/validation/field&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	logf &quot;sigs.k8s.io/controller-runtime/pkg/runtime/log&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/webhook&quot;
)
</code></pre>
</details>
<pre><code class="language-go">var cronjoblog = logf.Log.WithName(&quot;cronjob-resource&quot;)
</code></pre>
<p>This setup is doubles as setup for our conversion webhooks: as long as our
types implement the
<a href="https://godoc.org/sigs.k8s.io/controller-runtime/pkg/conversion#Hub">Hub</a> and
<a href="https://godoc.org/sigs.k8s.io/controller-runtime/pkg/conversion#Convertible">Convertible</a>
interfaces, a conversion webhook will be registered.</p>
<pre><code class="language-go">func (r *CronJob) SetupWebhookWithManager(mgr ctrl.Manager) error {
	return ctrl.NewWebhookManagedBy(mgr).
		For(r).
		Complete()
}
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Existing Defaulting and Validation</span></pre></summary>
<pre><code class="language-go">var _ webhook.Defaulter = &amp;CronJob{}

// Default implements webhook.Defaulter so a webhook will be registered for the type
func (r *CronJob) Default() {
	cronjoblog.Info(&quot;default&quot;, &quot;name&quot;, r.Name)

	if r.Spec.ConcurrencyPolicy == &quot;&quot; {
		r.Spec.ConcurrencyPolicy = AllowConcurrent
	}
	if r.Spec.Suspend == nil {
		r.Spec.Suspend = new(bool)
	}
	if r.Spec.SuccessfulJobsHistoryLimit == nil {
		r.Spec.SuccessfulJobsHistoryLimit = new(int32)
		*r.Spec.SuccessfulJobsHistoryLimit = 3
	}
	if r.Spec.FailedJobsHistoryLimit == nil {
		r.Spec.FailedJobsHistoryLimit = new(int32)
		*r.Spec.FailedJobsHistoryLimit = 1
	}
}

// TODO(user): change verbs to &quot;verbs=create;update;delete&quot; if you want to enable deletion validation.
// +kubebuilder:webhook:verbs=create;update,path=/validate-batch-tutorial-kubebuilder-io-v1-cronjob,mutating=false,failurePolicy=fail,groups=batch.tutorial.kubebuilder.io,resources=cronjobs,versions=v1,name=vcronjob.kb.io

var _ webhook.Validator = &amp;CronJob{}

// ValidateCreate implements webhook.Validator so a webhook will be registered for the type
func (r *CronJob) ValidateCreate() error {
	cronjoblog.Info(&quot;validate create&quot;, &quot;name&quot;, r.Name)

	return r.validateCronJob()
}

// ValidateUpdate implements webhook.Validator so a webhook will be registered for the type
func (r *CronJob) ValidateUpdate(old runtime.Object) error {
	cronjoblog.Info(&quot;validate update&quot;, &quot;name&quot;, r.Name)

	return r.validateCronJob()
}

// ValidateDelete implements webhook.Validator so a webhook will be registered for the type
func (r *CronJob) ValidateDelete() error {
	cronjoblog.Info(&quot;validate delete&quot;, &quot;name&quot;, r.Name)

	// TODO(user): fill in your validation logic upon object deletion.
	return nil
}

func (r *CronJob) validateCronJob() error {
	var allErrs field.ErrorList
	if err := r.validateCronJobName(); err != nil {
		allErrs = append(allErrs, err)
	}
	if err := r.validateCronJobSpec(); err != nil {
		allErrs = append(allErrs, err)
	}
	if len(allErrs) == 0 {
		return nil
	}

	return apierrors.NewInvalid(
		schema.GroupKind{Group: &quot;batch.tutorial.kubebuilder.io&quot;, Kind: &quot;CronJob&quot;},
		r.Name, allErrs)
}

func (r *CronJob) validateCronJobSpec() *field.Error {
	// The field helpers from the kubernetes API machinery help us return nicely
	// structured validation errors.
	return validateScheduleFormat(
		r.Spec.Schedule,
		field.NewPath(&quot;spec&quot;).Child(&quot;schedule&quot;))
}

func validateScheduleFormat(schedule string, fldPath *field.Path) *field.Error {
	if _, err := cron.ParseStandard(schedule); err != nil {
		return field.Invalid(fldPath, schedule, err.Error())
	}
	return nil
}

func (r *CronJob) validateCronJobName() *field.Error {
	if len(r.ObjectMeta.Name) &gt; validationutils.DNS1035LabelMaxLength-11 {
		// The job name length is 63 character like all Kubernetes objects
		// (which must fit in a DNS subdomain). The cronjob controller appends
		// a 11-character suffix to the cronjob (`-$TIMESTAMP`) when creating
		// a job. The job name length limit is 63 characters. Therefore cronjob
		// names must have length &lt;= 63-11=52. If we don't validate this here,
		// then job creation will fail later.
		return field.Invalid(field.NewPath(&quot;metadata&quot;).Child(&quot;name&quot;), r.Name, &quot;must be no more than 52 characters&quot;)
	}
	return nil
}
</code></pre>
</details></div>
<h2><a class="header" href="#and-maingo" id="and-maingo">...and <code>main.go</code></a></h2>
<p>Similarly, our existing main file is sufficient:</p>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/multiversion-tutorial/testdata/project/main.go">project/main.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<pre><code class="language-go">package main

import (
	&quot;flag&quot;
	&quot;os&quot;

	kbatchv1 &quot;k8s.io/api/batch/v1&quot;
	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	clientgoscheme &quot;k8s.io/client-go/kubernetes/scheme&quot;
	_ &quot;k8s.io/client-go/plugin/pkg/client/auth/gcp&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/log/zap&quot;

	batchv1 &quot;tutorial.kubebuilder.io/project/api/v1&quot;
	batchv2 &quot;tutorial.kubebuilder.io/project/api/v2&quot;
	&quot;tutorial.kubebuilder.io/project/controllers&quot;
	// +kubebuilder:scaffold:imports
)
</code></pre>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">existing setup</span></pre></summary>
<pre><code class="language-go">var (
	scheme   = runtime.NewScheme()
	setupLog = ctrl.Log.WithName(&quot;setup&quot;)
)

func init() {
	_ = clientgoscheme.AddToScheme(scheme)

	_ = kbatchv1.AddToScheme(scheme) // we've added this ourselves
	_ = batchv1.AddToScheme(scheme)
	_ = batchv2.AddToScheme(scheme)
	// +kubebuilder:scaffold:scheme
}
</code></pre>
</details>
<pre><code class="language-go">func main() {
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">existing setup</span></pre></summary>
<pre><code class="language-go">	var metricsAddr string
	var enableLeaderElection bool
	flag.StringVar(&amp;metricsAddr, &quot;metrics-addr&quot;, &quot;:8080&quot;, &quot;The address the metric endpoint binds to.&quot;)
	flag.BoolVar(&amp;enableLeaderElection, &quot;enable-leader-election&quot;, false,
		&quot;Enable leader election for controller manager. Enabling this will ensure there is only one active controller manager.&quot;)
	flag.Parse()

	ctrl.SetLogger(zap.New(zap.UseDevMode(true)))

	mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{
		Scheme:             scheme,
		MetricsBindAddress: metricsAddr,
		LeaderElection:     enableLeaderElection,
	})
	if err != nil {
		setupLog.Error(err, &quot;unable to start manager&quot;)
		os.Exit(1)
	}

	if err = (&amp;controllers.CronJobReconciler{
		Client: mgr.GetClient(),
		Log:    ctrl.Log.WithName(&quot;controllers&quot;).WithName(&quot;Captain&quot;),
		Scheme: mgr.GetScheme(), // we've added this ourselves
	}).SetupWithManager(mgr); err != nil {
		setupLog.Error(err, &quot;unable to create controller&quot;, &quot;controller&quot;, &quot;Captain&quot;)
		os.Exit(1)
	}
</code></pre>
</details>
<p>Our existing call to SetupWebhookWithManager registers our conversion webhooks with the manager, too.</p>
<pre><code class="language-go">	if err = (&amp;batchv1.CronJob{}).SetupWebhookWithManager(mgr); err != nil {
		setupLog.Error(err, &quot;unable to create webhook&quot;, &quot;webhook&quot;, &quot;Captain&quot;)
		os.Exit(1)
	}
	// +kubebuilder:scaffold:builder
</code></pre>
<details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">existing setup</span></pre></summary>
<pre><code class="language-go">	setupLog.Info(&quot;starting manager&quot;)
	if err := mgr.Start(ctrl.SetupSignalHandler()); err != nil {
		setupLog.Error(err, &quot;problem running manager&quot;)
		os.Exit(1)
	}
</code></pre>
</details>
<pre><code class="language-go">}
</code></pre>
</div>
<p>Everything’s set up and ready to go!  All that’s left now is to test out
our webhooks.</p>
<h1><a class="header" href="#deployment-and-testing" id="deployment-and-testing">Deployment and Testing</a></h1>
<p>Before we can test out our conversion, we’ll need to enable them conversion in our CRD:</p>
<p>Kubebuilder generates Kubernetes manifests under the <code>config</code> directory with webhook
bits disabled.  To enable them, we need to:</p>
<ul>
<li>
<p>Enable <code>patches/webhook_in_&lt;kind&gt;.yaml</code> and
<code>patches/cainjection_in_&lt;kind&gt;.yaml</code> in
<code>config/crd/kustomization.yaml</code> file.</p>
</li>
<li>
<p>Enable <code>../certmanager</code> and <code>../webhook</code> directories under the
<code>bases</code> section in <code>config/default/kustomization.yaml</code> file.</p>
</li>
<li>
<p>Enable <code>manager_webhook_patch.yaml</code> under the <code>patches</code> section
in <code>config/default/kustomization.yaml</code> file.</p>
</li>
<li>
<p>Enable all the vars under the <code>CERTMANAGER</code> section in
<code>config/default/kustomization.yaml</code> file.</p>
</li>
</ul>
<p>Additionally, we’ll need to set the <code>CRD_OPTIONS</code> variable to just
<code>&quot;crd&quot;</code>, removing the <code>trivialVersions</code> option (this ensures that we
actually <a href="multiversion-tutorial//reference/generating-crd.html#multiple-versions" title="Generating CRDs: Multiple Versions">generate validation for each version</a>, instead of
telling Kubernetes that they’re the same):</p>
<pre><code class="language-makefile">CRD_OPTIONS ?= &quot;crd&quot;
</code></pre>
<p>Now we have all our code changes and manifests in place, so let’s deploy it to
the cluster and test it out.</p>
<p>You’ll need <a href="multiversion-tutorial/../cronjob-tutorial/cert-manager.html">cert-manager</a> installed
(version <code>0.9.0+</code>) unless you’ve got some other certificate management
solution.  The Kubebuilder team has tested the instructions in this tutorial
with
<a href="https://github.com/jetstack/cert-manager/releases/tag/v0.9.0-alpha.0">0.9.0-alpha.0</a>
release.</p>
<p>Once all our ducks are in a row with certificates, we can run <code>make install deploy</code> (as normal) to deploy all the bits (CRD,
controller-manager deployment) onto the cluster.</p>
<h2><a class="header" href="#testing" id="testing">Testing</a></h2>
<p>Once all of the bits are up an running on the cluster with conversion enabled, we can test out our
conversion by requesting different versions.</p>
<p>We’ll make a v2 version based on our v1 version (put it under <code>config/samples</code>)</p>
<pre><code class="language-yaml">apiVersion: batch.tutorial.kubebuilder.io/v2
kind: CronJob
metadata:
  name: cronjob-sample
spec:
  schedule:
    minute: &quot;*/1&quot;
  startingDeadlineSeconds: 60
  concurrencyPolicy: Allow # explicitly specify, but Allow is also default.
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            args:
            - /bin/sh
            - -c
            - date; echo Hello from the Kubernetes cluster
          restartPolicy: OnFailure
</code></pre>
<p>Then, we can create it on the cluster: </p>
<pre><code class="language-shell">kubectl apply -f config/samples/batch_v2_cronjob.yaml
</code></pre>
<p>If we’ve done everything correctly, it should create successfully,
and we should be able to fetch it using both the v2 resource</p>
<pre><code class="language-shell">kubectl get cronjobs.v2.batch.tutorial.kubebuilder.io -o yaml
</code></pre>
<pre><code class="language-yaml">apiVersion: batch.tutorial.kubebuilder.io/v2
kind: CronJob
metadata:
  name: cronjob-sample
spec:
  schedule:
    minute: &quot;*/1&quot;
  startingDeadlineSeconds: 60
  concurrencyPolicy: Allow # explicitly specify, but Allow is also default.
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            args:
            - /bin/sh
            - -c
            - date; echo Hello from the Kubernetes cluster
          restartPolicy: OnFailure
</code></pre>
<p>and the v1 resource</p>
<pre><code class="language-shell">kubectl get cronjobs.v1.batch.tutorial.kubebuilder.io -o yaml
</code></pre>
<pre><code class="language-yaml">apiVersion: batch.tutorial.kubebuilder.io/v1
kind: CronJob
metadata:
  name: cronjob-sample
spec:
  schedule: &quot;*/1 * * * *&quot;
  startingDeadlineSeconds: 60
  concurrencyPolicy: Allow # explicitly specify, but Allow is also default.
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            args:
            - /bin/sh
            - -c
            - date; echo Hello from the Kubernetes cluster
          restartPolicy: OnFailure
</code></pre>
<p>Both should be filled out, and look equivalent to our v2 and v1 samples,
respectively.  Notice that each has a different API version.</p>
<p>Finally, if we wait a bit, we should notice that our CronJob continues to
reconcile, even though our controller is written against our v1 API version.</p>
<h2><a class="header" href="#troubleshooting" id="troubleshooting">Troubleshooting</a></h2>
<p><a href="multiversion-tutorial//TODO.html">steps for troubleshooting</a></p>
<h1><a class="header" href="#migrations" id="migrations">Migrations</a></h1>
<p>Migrating between project structures in KubeBuilder generally involves
a bit of manual work.</p>
<h2>This section details what’s required to migrate, between different
versions of KubeBuilder scaffolding, as well as to more complex project
layout structures.</h2>
<ul>
<li></li>
</ul>
<h1><a class="header" href="#kubebuilder-v1-vs-v2" id="kubebuilder-v1-vs-v2">Kubebuilder v1 vs v2</a></h1>
<p>This document cover all breaking changes when migrating from v1 to v2.</p>
<p>The details of all changes (breaking or otherwise) can be found in
<a href="https://github.com/kubernetes-sigs/controller-runtime/releases">controller-runtime</a>,
<a href="https://github.com/kubernetes-sigs/controller-tools/releases">controller-tools</a>
and <a href="https://github.com/kubernetes-sigs/kubebuilder/releases">kubebuilder</a>
release notes.</p>
<h2><a class="header" href="#common-changes" id="common-changes">Common changes</a></h2>
<p>V2 project uses go modules. But kubebuilder will continue to support <code>dep</code> until
go 1.13 is out.</p>
<h2><a class="header" href="#controller-runtime" id="controller-runtime">controller-runtime</a></h2>
<ul>
<li>
<p><code>Client.List</code> now uses functional options (<code>List(ctx, list, ...option)</code>) instead
of <code>List(ctx, ListOptions, list)</code>.</p>
</li>
<li>
<p><code>Client.DeleteAllOf</code> was added to the <code>Client</code> interface.</p>
</li>
<li>
<p>Metrics are on by default now.</p>
</li>
<li>
<p>A number of packages under <code>pkg/runtime</code> have been moved, with their old
locations deprecated. The old locations will be removed before
controller-runtime v1.0.0. See the <a href="https://godoc.org/sigs.k8s.io/controller-runtime/pkg/runtime">godocs</a> for more
information.</p>
</li>
</ul>
<h4><a class="header" href="#webhook-related" id="webhook-related">Webhook-related</a></h4>
<ul>
<li>
<p>Automatic certificate generation for webhooks has been removed, and webhooks
will no longer self-register. Use controller-tools to generate a webhook
configuration. If you need certificate generation, we recommend using
<a href="https://github.com/jetstack/cert-manager">cert-manager</a>. Kubebuilder v2 will
scaffold out cert manager configs for you to use -- see the
<a href="migration//cronjob-tutorial/webhook-implementation.html">Webhook Tutorial</a> for more details.</p>
</li>
<li>
<p>The <code>builder</code> package now has separate builders for controllers and webhooks,
which facilitates choosing which to run.</p>
</li>
</ul>
<h2><a class="header" href="#controller-tools" id="controller-tools">controller-tools</a></h2>
<p>The generator framework has been rewritten in v2. It still works the same as
before in many cases, but be aware that there are some breaking changes.
Please check <a href="migration//reference/markers.html">marker documentation</a> for more details.</p>
<h2><a class="header" href="#kubebuilder" id="kubebuilder">Kubebuilder</a></h2>
<ul>
<li>
<p>Kubebuilder v2 introduces a simplified project layout. You can find the design
doc <a href="https://github.com/kubernetes-sigs/kubebuilder/blob/master/designs/simplified-scaffolding.md">here</a>.</p>
</li>
<li>
<p>In v1, the manager is deployed as a <code>StatefulSet</code>, while it’s deployed as a
<code>Deployment</code> in v2.</p>
</li>
<li>
<p>The <code>kubebuilder create webhook</code> command was added to scaffold
mutating/validating/conversion webhooks. It replaces the
<code>kubebuilder alpha webhook</code> command.</p>
</li>
<li>
<p>v2 uses <code>distroless/static</code> instead of Ubuntu as base image. This reduces
image size and attack surface.</p>
</li>
<li>
<p>v2 requires kustomize v3.1.0+.</p>
</li>
</ul>
<h1><a class="header" href="#migration-from-v1-to-v2" id="migration-from-v1-to-v2">Migration from v1 to v2</a></h1>
<p>Make sure you understand the <a href="migration/./v1vsv2.html">differences between Kubebuilder v1 and v2</a>
before continuing</p>
<p>Please ensure you have followed the <a href="migration//quick-start.html#installation">installation guide</a>
to install the required components.</p>
<p>The recommended way to migrate a v1 project is to create a new v2 project and
copy over the API and the reconciliation code. The conversion will end up with a
project that looks like a native v2 project. However, in some cases, it’s
possible to do an in-place upgrade (i.e. reuse the v1 project layout, upgrading
controller-runtime and controller-tools.</p>
<p>Let’s take the <a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/migration/testdata/gopath/project-v1">example v1 project</a> and migrate it to Kubebuilder
v2. At the end, we should have something that looks like the
<a href="https://github.com/kubernetes-sigs/kubebuilder/tree/master/docs/book/src/cronjob-tutorial/testdata/project">example v2 project</a>.</p>
<h2><a class="header" href="#preparation" id="preparation">Preparation</a></h2>
<p>We’ll need to figure out what the group, version, kind and domain are.</p>
<p>Let’s take a look at our current v1 project structure:</p>
<pre><code>pkg/
├── apis
│   ├── addtoscheme_batch_v1.go
│   ├── apis.go
│   └── batch
│       ├── group.go
│       └── v1
│           ├── cronjob_types.go
│           ├── cronjob_types_test.go
│           ├── doc.go
│           ├── register.go
│           ├── v1_suite_test.go
│           └── zz_generated.deepcopy.go
├── controller
└── webhook
</code></pre>
<p>All of our API information is stored in <code>pkg/apis/batch</code>, so we can look
there to find what we need to know.</p>
<p>In <code>cronjob_types.go</code>, we can find</p>
<pre><code class="language-go">type CronJob struct {...}
</code></pre>
<p>In <code>register.go</code>, we can find</p>
<pre><code class="language-go">SchemeGroupVersion = schema.GroupVersion{Group: &quot;batch.tutorial.kubebuilder.io&quot;, Version: &quot;v1&quot;}
</code></pre>
<p>Putting that together, we get <code>CronJob</code> as the kind, and <code>batch.tutorial.kubebuilder.io/v1</code> as the group-version</p>
<h2><a class="header" href="#initialize-a-v2-project" id="initialize-a-v2-project">Initialize a v2 Project</a></h2>
<p>Now, we need to initialize a v2 project.  Before we do that, though, we’ll need
to initialize a new go module if we’re not on the <code>gopath</code>:</p>
<pre><code class="language-bash">go mod init tutorial.kubebuilder.io/project
</code></pre>
<p>Then, we can finish initializing the project with kubebuilder:</p>
<pre><code class="language-bash">kubebuilder init --domain tutorial.kubebuilder.io
</code></pre>
<h2><a class="header" href="#migrate-apis-and-controllers" id="migrate-apis-and-controllers">Migrate APIs and Controllers</a></h2>
<p>Next, we’ll re-scaffold out the API types and controllers. Since we want both,
we’ll say yes to both the API and controller prompts when asked what parts we
want to scaffold:</p>
<pre><code class="language-bash">kubebuilder create api --group batch --version v1 --kind CronJob
</code></pre>
<p>If you’re using multiple groups, some manual work is required to migrate.
Please follow <a href="migration//migration/multi-group.html">this</a> for more details.</p>
<h3><a class="header" href="#migrate-the-apis" id="migrate-the-apis">Migrate the APIs</a></h3>
<p>Now, let’s copy the API definition from <code>pkg/apis/batch/v1/cronjob_types.go</code> to
<code>api/v1/cronjob_types.go</code>. We only need to copy the implementation of the <code>Spec</code>
and <code>Status</code> fields.</p>
<p>We can replace the <code>+k8s:deepcopy-gen:interfaces=...</code> marker (which is
<a href="migration//reference/markers/object.html">deprecated in kubebuilder</a>) with
<code>+kubebuilder:object:root=true</code>.</p>
<p>We don’t need the following markers any more (they’re not used anymore, and are
relics from much older versions of KubeBuilder):</p>
<pre><code class="language-go">// +genclient
// +k8s:openapi-gen=true
</code></pre>
<p>Our API types should look like the following:</p>
<pre><code class="language-go">// +kubebuilder:object:root=true

// CronJob is the Schema for the cronjobs API
type CronJob struct {...}

// +kubebuilder:object:root=true

// CronJobList contains a list of CronJob
type CronJobList struct {...}
</code></pre>
<h3><a class="header" href="#migrate-the-controllers" id="migrate-the-controllers">Migrate the Controllers</a></h3>
<p>Now, let’s migrate the controller reconciler code from
<code>pkg/controller/cronjob/cronjob_controller.go</code> to
<code>controllers/cronjob_controller.go</code>.</p>
<p>We’ll need to copy</p>
<ul>
<li>the fields from the <code>ReconcileCronJob</code> struct to <code>CronJobReconciler</code></li>
<li>the contents of the <code>Reconcile</code> function</li>
<li>the <a href="migration//reference/markers/rbac.html">rbac related markers</a> to the new file.</li>
<li>the code under <code>func add(mgr manager.Manager, r reconcile.Reconciler) error</code>
to <code>func SetupWithManager</code></li>
</ul>
<h2><a class="header" href="#migrate-the-webhooks" id="migrate-the-webhooks">Migrate the Webhooks</a></h2>
<p>If you don’t have a webhook, you can skip this section.</p>
<h3><a class="header" href="#webhooks-for-core-types-and-external-crds" id="webhooks-for-core-types-and-external-crds">Webhooks for Core Types and External CRDs</a></h3>
<p>If you are using webhooks for Kubernetes core types (e.g. Pods), or for an
external CRD that is not owned by you, you can refer the
<a href="https://sigs.k8s.io/controller-runtime/examples/builtins">controller-runtime example for builtin types</a>
and do something similar. Kubebuilder doesn’t scaffold much for these cases, but
you can use the library in controller-runtime.</p>
<h3><a class="header" href="#scaffold-webhooks-for-our-crds" id="scaffold-webhooks-for-our-crds">Scaffold Webhooks for our CRDs</a></h3>
<p>Now let’s scaffold the webhooks for our CRD (CronJob). We’ll need to run the
following command with the <code>--defaulting</code> and <code>--programmatic-validation</code> flags
(since our test project uses defaulting and validating webhooks):</p>
<pre><code class="language-bash">kubebuilder create webhook --group batch --version v1 --kind CronJob --defaulting --programmatic-validation
</code></pre>
<p>Depending on how many CRDs need webhooks, we may need to run the above command
multiple times with different Group-Version-Kinds.</p>
<p>Now, we’ll need to copy the logic for each webhook. For validating webhooks, we
can copy the contents from
<code>func validatingCronJobFn</code> in <code>pkg/default_server/cronjob/validating/cronjob_create_handler.go</code>
to <code>func ValidateCreate</code> in <code>api/v1/cronjob_webhook.go</code> and then the same for <code>update</code>.</p>
<p>Similarly, we’ll copy from <code>func mutatingCronJobFn</code> to <code>func Default</code>.</p>
<h3><a class="header" href="#webhook-markers" id="webhook-markers">Webhook Markers</a></h3>
<p>When scaffolding webhooks, Kubebuilder v2 adds the following markers:</p>
<pre><code>// These are v2 markers

// This is for the mutating webhook
// +kubebuilder:webhook:path=/mutate-batch-tutorial-kubebuilder-io-v1-cronjob,mutating=true,failurePolicy=fail,groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=create;update,versions=v1,name=mcronjob.kb.io

...

// This is for the validating webhook
// +kubebuilder:webhook:path=/validate-batch-tutorial-kubebuilder-io-v1-cronjob,mutating=false,failurePolicy=fail,groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=create;update,versions=v1,name=vcronjob.kb.io
</code></pre>
<p>The default verbs are <code>verbs=create;update</code>. We need to ensure <code>verbs</code> matches
what we need. For example, if we only want to validate creation, then we would
change it to <code>verbs=create</code>.</p>
<p>We also need to ensure <code>failure-policy</code> is still the same.</p>
<p>Markers like the following are no longer needed (since they deal with
self-deploying certificate configuration, which was removed in v2):</p>
<pre><code class="language-go">// v1 markers
// +kubebuilder:webhook:port=9876,cert-dir=/tmp/cert
// +kubebuilder:webhook:service=test-system:webhook-service,selector=app:webhook-server
// +kubebuilder:webhook:secret=test-system:webhook-server-secret
// +kubebuilder:webhook:mutating-webhook-config-name=test-mutating-webhook-cfg
// +kubebuilder:webhook:validating-webhook-config-name=test-validating-webhook-cfg
</code></pre>
<p>In v1, a single webhook marker may be split into multiple ones in the same
paragraph. In v2, each webhook must be represented by a single marker.</p>
<h2><a class="header" href="#others" id="others">Others</a></h2>
<p>If there are any manual updates in <code>main.go</code> in v1, we need to port the changes
to the new <code>main.go</code>. We’ll also need to ensure all of the needed schemes have
been registered.</p>
<p>If there are additional manifests added under <code>config</code> directory, port them as
well.</p>
<p>Change the image name in the Makefile if needed.</p>
<h2><a class="header" href="#verification" id="verification">Verification</a></h2>
<p>Finally, we can run <code>make</code> and <code>make docker-build</code> to ensure things are working
fine.</p>
<h1><a class="header" href="#single-group-to-multi-group" id="single-group-to-multi-group">Single Group to Multi-Group</a></h1>
<aside class="note warning">
<h1><a class="header" href="#note" id="note">Note</a></h1>
<p>Multi-group scaffolding support was not present in the initial version of
the KubeBuilder v2 scaffolding (as of KubeBuilder v2.0.0).</p>
<p>To change the layout of your project to support Multi-Group run the command
<code>kubebuilder edit --multigroup=true</code>. Once you switch to a multi-group layout, the new Kinds
will be generated in the new layout but additional manual work is needed 
to move the old API groups to the new layout.</p>
</aside>
<p>While KubeBuilder v2 will not scaffold out a project structure compatible
with multiple API groups in the same repository by default, it’s possible
to modify the default project structure to support it.</p>
<p>Let’s migrate the <a href="migration//cronjob-tutorial/cronjob-tutorial.html" title="Tutorial: Building CronJob">CronJob example</a>.</p>
<p>Generally, we use the prefix for the API group as the directory name. We
can check <code>api/v1/groupversion_info.go</code> to find that out:</p>
<pre><code class="language-go">// +groupName=batch.tutorial.kubebuilder.io
package v1
</code></pre>
<p>Then, we’ll rename <code>api</code> to <code>apis</code> to be more clear, and we’ll move our
existing APIs into a new subdirectory, “batch”:</p>
<pre><code class="language-bash">mkdir apis/batch
mv api/* apis/batch
# After ensuring that all was moved successfully remove the old directory `api/`
rm -rf api/ 
</code></pre>
<p>After moving the APIs to a new directory, the same needs to be applied to the controllers:</p>
<pre><code class="language-bash">mkdir controllers/batch
mv controllers/* controllers/batch/
</code></pre>
<p>Next, we’ll need to update all the references to the old package name. 
For CronJob, that’ll be <code>main.go</code> and <code>controllers/batch/cronjob_controller.go</code>. </p>
<p>If you’ve added additional files to your project, you’ll need to track down
imports there as well.</p>
<p>Finally, we’ll run the command which enable the multi-group layout in the project:</p>
<pre><code>kubebuilder edit --multigroup=true
</code></pre>
<p>When the command <code>kubebuilder edit --multigroup=true</code> is executed it will add a new line 
to <code>PROJECT</code> that marks this a multi-group project:</p>
<pre><code class="language-yaml">version: &quot;2&quot;
domain: tutorial.kubebuilder.io
repo: tutorial.kubebuilder.io/project
multigroup: true
</code></pre>
<p>Note that this option indicates to KubeBuilder that this is a multi-group project. </p>
<p>In this way, if the project is not new and has previous APIs already implemented will be in the previous structure. 
Notice that with the <code>multi-group</code> project the Kind API’s files are
created under <code>apis/&lt;group&gt;/&lt;version&gt;</code> instead of <code>api/&lt;version&gt;</code>. 
Also, note that the controllers will be created under <code>controllers/&lt;group&gt;</code> instead of <code>controllers</code>. 
That is the reason why we moved the previously generated APIs with the provided scripts in the previous steps. 
Remember to update the references afterwards.</p>
<p>The <a href="migration//cronjob-tutorial/cronjob-tutorial.html" title="Tutorial: Building CronJob">CronJob tutorial</a> explains each of these changes in
more detail (in the context of how they’re generated by KubeBuilder for
single-group projects).</p>
<h1><a class="header" href="#reference" id="reference">Reference</a></h1>
<ul>
<li>
<p><a href="reference/generating-crd.html">Generating CRDs</a></p>
</li>
<li>
<p><a href="reference/using-finalizers.html">Using Finalizers</a>
Finalizers are a mechanism to
execute any custom logic related to a resource before it gets deleted from
Kubernetes cluster.</p>
</li>
<li>
<p><a href="reference/kind.html">Kind cluster</a></p>
</li>
<li>
<p><a href="reference/webhook-overview.html">What’s a webhook?</a>
Webhooks are HTTP callbacks, there are 3
types of webhooks in k8s: 1) admission webhook 2) CRD conversion webhook 3)
authorization webhook</p>
<ul>
<li><a href="reference/admission-webhook.html">Admission webhook</a>
Admission webhooks are HTTP
callbacks for mutating or validating resources before the API server admit
them.</li>
</ul>
</li>
<li>
<p><a href="reference/markers.html">Markers for Config/Code Generation</a></p>
<ul>
<li><a href="reference/markers/crd.html">CRD Generation</a></li>
<li><a href="reference/markers/crd-validation.html">CRD Validation</a></li>
<li><a href="reference/markers/webhook.html">Webhook</a></li>
<li><a href="reference/markers/object.html">Object/DeepCopy</a></li>
<li><a href="reference/markers/rbac.html">RBAC</a></li>
</ul>
</li>
<li>
<p><a href="reference/controller-gen.html">controller-gen CLI</a></p>
</li>
<li>
<p><a href="reference/artifacts.html">Artifacts</a></p>
</li>
<li>
<p><a href="reference/writing-tests.html">Writing controller tests</a></p>
</li>
<li>
<p><a href="reference/metrics.html">Metrics</a></p>
</li>
</ul>
<h1><a class="header" href="#generating-crds" id="generating-crds">Generating CRDs</a></h1>
<p>KubeBuilder uses a tool called <a href="https://sigs.k8s.io/controller-tools" title="Controller Tools"><code>controller-gen</code></a> to
generate utility code and Kubernetes object YAML, like
CustomResourceDefinitions.</p>
<p>To do this, it makes use of special “marker comments” (comments that start
with <code>// +</code>) to indicate additional information about fields, types, and
packages.  In the case of CRDs, these are generally pulled from your
<code>_types.go</code> files.  For more information on markers, see the <a href="reference/./markers.html" title="Markers for Config/Code Generation">marker
reference docs</a>.</p>
<p>KubeBuilder provides a <code>make</code> target to run controller-gen and generate
CRDs: <code>make manifests</code>.</p>
<p>When you run <code>make manifests</code>, you should see CRDs generated under the
<code>config/crd/bases</code> directory.  <code>make manifests</code> can generate a number of
other artifacts as well -- see the <a href="reference/./markers.html" title="Markers for Config/Code Generation">marker reference docs</a> for
more details.</p>
<h2><a class="header" href="#validation" id="validation">Validation</a></h2>
<p>CRDs support <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#validation" title="Custom Resource Definitions: Validation">declarative validation</a> using an <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#schemaObject" title="OpenAPI v3">OpenAPI
v3 schema</a> in the <code>validation</code> section.</p>
<p>In general, <a href="reference/./markers/crd-validation.html">validation markers</a> may be
attached to fields or to types. If you’re defining complex validation, if
you need to re-use validation, or if you need to validate slice elements,
it’s often best to define a new type to describe your validation.</p>
<p>For example:</p>
<pre><code class="language-go">type ToySpec struct {
	// +kubebuilder:validation:MaxLength=15
	// +kubebuilder:validation:MinLength=1
	Name string `json:&quot;name,omitempty&quot;`

	// +kubebuilder:validation:MaxItems=500
	// +kubebuilder:validation:MinItems=1
	// +kubebuilder:validation:UniqueItems=true
	Knights []string `json:&quot;knights,omitempty&quot;`

	Alias   Alias   `json:&quot;alias,omitempty&quot;`
	Rank    Rank    `json:&quot;rank&quot;`
}

// +kubebuilder:validation:Enum=Lion;Wolf;Dragon
type Alias string

// +kubebuilder:validation:Minimum=1
// +kubebuilder:validation:Maximum=3
// +kubebuilder:validation:ExclusiveMaximum=false
type Rank int32

</code></pre>
<h2><a class="header" href="#additional-printer-columns" id="additional-printer-columns">Additional Printer Columns</a></h2>
<p>Starting with Kubernetes 1.11, <code>kubectl get</code> can ask the server what
columns to display.  For CRDs, this can be used to provide useful,
type-specific information with <code>kubectl get</code>, similar to the information
provided for built-in types.</p>
<p>The information that gets displayed can be controlled with the
[additionalPrinterColumns field][kube-additional-printer-columns] on your
CRD, which is controlled by the
<a href="reference/./markers/crd.html" title="CRD Generation"><code>+kubebuilder:printcolumn</code></a> marker on the Go type for
your CRD.</p>
<p>For instance, in the following example, we add fields to display
information about the knights, rank, and alias fields from the validation
example:</p>
<pre><code class="language-go">// +kubebuilder:printcolumn:name=&quot;Alias&quot;,type=string,JSONPath=`.spec.alias`
// +kubebuilder:printcolumn:name=&quot;Rank&quot;,type=integer,JSONPath=`.spec.rank`
// +kubebuilder:printcolumn:name=&quot;Bravely Run Away&quot;,type=boolean,JSONPath=`.spec.knights[?(@ == &quot;Sir Robin&quot;)]`,description=&quot;when danger rears its ugly head, he bravely turned his tail and fled&quot;,priority=10
type Toy struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   ToySpec   `json:&quot;spec,omitempty&quot;`
	Status ToyStatus `json:&quot;status,omitempty&quot;`
}

</code></pre>
<h2><a class="header" href="#subresources" id="subresources">Subresources</a></h2>
<p>CRDs can choose to implement the <code>/status</code> and <code>/scale</code>
<a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#status-subresource" title="Custom Resource Definitions: Status Subresource">subresources</a> as of Kubernetes 1.13.</p>
<p>It’s generally reccomended that you make use of the <code>/status</code> subresource
on all resources that have a status field.</p>
<p>Both subresources have a corresponding <a href="reference/./markers/crd.html" title="CRD Generation">marker</a>.</p>
<h3><a class="header" href="#status" id="status">Status</a></h3>
<p>The status subresource is enabled via <code>+kubebuilder:subresource:status</code>.
When enabled, updates at the main resource will not change status.
Similarly, updates to the status subresource cannot change anything but
the status field.</p>
<p>For example:</p>
<pre><code class="language-go">// +kubebuilder:subresource:status
type Toy struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   ToySpec   `json:&quot;spec,omitempty&quot;`
	Status ToyStatus `json:&quot;status,omitempty&quot;`
}
</code></pre>
<h3><a class="header" href="#scale" id="scale">Scale</a></h3>
<p>The scale subresource is enabled via <code>+kubebuilder:subresource:scale</code>.
When enabled, users will be able to use <code>kubectl scale</code> with your
resource.  If the <code>selectorpath</code> argument pointed to the string form of
a label selector, the HorizontalPodAutoscaler will be able to autoscale
your resource.</p>
<p>For example:</p>
<pre><code class="language-go">type CustomSetSpec struct {
	Replicas *int32 `json:&quot;replicas&quot;`
}

type CustomSetStatus struct {
	Replicas int32 `json:&quot;replicas&quot;`
    Selector string `json:&quot;selector&quot;` // this must be the string form of the selector
}


// +kubebuilder:subresource:status
// +kubebuilder:subresource:scale:specpath=.spec.replicas,statuspath=.status.replicas,selectorpath=.status.selector
type CustomSet struct {
	metav1.TypeMeta   `json:&quot;,inline&quot;`
	metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`

	Spec   ToySpec   `json:&quot;spec,omitempty&quot;`
	Status ToyStatus `json:&quot;status,omitempty&quot;`
}
</code></pre>
<h2><a class="header" href="#multiple-versions" id="multiple-versions">Multiple Versions</a></h2>
<p>As of Kubernetes 1.13, you can have multiple versions of your Kind defined
in your CRD, and use a webhook to convert between them.</p>
<p>For more details on this process, see the <a href="reference//multiversion-tutorial/tutorial.html">multiversion
tutorial</a>.</p>
<p>By default, KubeBuilder disables generating different validation for
different versions of the Kind in your CRD, to be compatible with older
Kubernetes versions.</p>
<p>You’ll need to enable this by switching the line in your makefile that
says <code>CRD_OPTIONS ?= &quot;crd:trivialVersions=true</code> to <code>CRD_OPTIONS ?= crd</code></p>
<p>Then, you can use the <code>+kubebuilder:storageversion</code> <a href="reference/./markers/crd.html" title="CRD Generation">marker</a>
to indicate the <a href="reference//cronjob-tutorial/gvks.html" title="Group-Version-Kind">GVK</a> that
should be used to store data by the API server.</p>
<h2><a class="header" href="#under-the-hood" id="under-the-hood">Under the hood</a></h2>
<p>KubeBuilder scaffolds out make rules to run <code>controller-gen</code>.  The rules
will automatically install controller-gen if it’s not on your path using
<code>go get</code> with Go modules.</p>
<p>You can also run <code>controller-gen</code> directly, if you want to see what it’s
doing.</p>
<p>Each controller-gen “generator” is controlled by an option to
controller-gen, using the same syntax as markers.  For instance, to
generate CRDs with “trivial versions” (no version conversion webhooks), we
call <code>controller-gen crd:trivialVersions=true paths=./api/...</code>.</p>
<p>controller-gen also supports different output “rules” to control how
and where output goes.  Notice the <code>manifests</code> make rule (condensed
slightly to only generate CRDs):</p>
<pre><code class="language-makefile"># Generate manifests for CRDs
manifests: controller-gen
	$(CONTROLLER_GEN) crd:trivialVersions=true paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases
</code></pre>
<p>It uses the <code>output:crd:artifacts</code> output rule to indicate that
CRD-related config (non-code) artifacts should end up in
<code>config/crd/bases</code> instead of <code>config/crd</code>.</p>
<p>To see all the options for <code>controller-gen</code>, run</p>
<pre><code class="language-shell">$ controller-gen -h
</code></pre>
<p>or, for more details:</p>
<pre><code class="language-shell">$ controller-gen -hhh
</code></pre>
<h1><a class="header" href="#using-finalizers" id="using-finalizers">Using Finalizers</a></h1>
<p><code>Finalizers</code> allow controllers to implement asynchronous pre-delete hooks. Let’s
say you create an external resource (such as a storage bucket) for each object of
your API type, and you want to delete the associated external resource
on object’s deletion from Kubernetes, you can use a finalizer to do that.</p>
<p>You can read more about the finalizers in the <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#finalizers">Kubernetes reference docs</a>. The section below demonstrates how to register and trigger pre-delete hooks
in the <code>Reconcile</code> method of a controller.</p>
<p>The key point to note is that a finalizer causes “delete” on the object to become 
an “update” to set deletion timestamp. Presence of deletion timestamp on the object
indicates that it is being deleted. Otherwise, without finalizers, a delete
shows up as a reconcile where the object is missing from the cache.</p>
<p>Highlights:</p>
<ul>
<li>If the object is not being deleted and does not have the finalizer registered,
then add the finalizer and update the object in Kubernetes.</li>
<li>If object is being deleted and the finalizer is still present in finalizers list,
then execute the pre-delete logic and remove the finalizer and update the
object.</li>
<li>Ensure that the pre-delete logic is idempotent.</li>
</ul>
<div class="literate"><cite class="literate-source"><a href="https://sigs.k8s.io/kubebuilder/docs/book/src/cronjob-tutorial/testdata/finalizer_example.go">../../cronjob-tutorial/testdata/finalizer_example.go</a></cite><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Apache License</span></pre></summary>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</details><details class="collapse-code"><summary class="hljs"><pre class="hljs"><span class="hljs-comment">Imports</span></pre></summary>
<p>First, we start out with some standard imports.
As before, we need the core controller-runtime library, as well as
the client package, and the package for our API types.</p>
<pre><code class="language-go">package controllers

import (
	&quot;context&quot;

	&quot;github.com/go-logr/logr&quot;
	ctrl &quot;sigs.k8s.io/controller-runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;

	batchv1 &quot;tutorial.kubebuilder.io/project/api/v1&quot;
)
</code></pre>
</details>
<p>The code snippet below shows skeleton code for implementing a finalizer.</p>
<pre><code class="language-go">func (r *CronJobReconciler) Reconcile(req ctrl.Request) (ctrl.Result, error) {
	ctx := context.Background()
	log := r.Log.WithValues(&quot;cronjob&quot;, req.NamespacedName)

	var cronJob *batchv1.CronJob
	if err := r.Get(ctx, req.NamespacedName, cronJob); err != nil {
		log.Error(err, &quot;unable to fetch CronJob&quot;)
		// we'll ignore not-found errors, since they can't be fixed by an immediate
		// requeue (we'll need to wait for a new notification), and we can get them
		// on deleted requests.
		return ctrl.Result{}, client.IgnoreNotFound(err)
	}

	// name of our custom finalizer
	myFinalizerName := &quot;storage.finalizers.tutorial.kubebuilder.io&quot;

	// examine DeletionTimestamp to determine if object is under deletion
	if cronJob.ObjectMeta.DeletionTimestamp.IsZero() {
		// The object is not being deleted, so if it does not have our finalizer,
		// then lets add the finalizer and update the object. This is equivalent
		// registering our finalizer.
		if !containsString(cronJob.ObjectMeta.Finalizers, myFinalizerName) {
			cronJob.ObjectMeta.Finalizers = append(cronJob.ObjectMeta.Finalizers, myFinalizerName)
			if err := r.Update(context.Background(), cronJob); err != nil {
				return ctrl.Result{}, err
			}
		}
	} else {
		// The object is being deleted
		if containsString(cronJob.ObjectMeta.Finalizers, myFinalizerName) {
			// our finalizer is present, so lets handle any external dependency
			if err := r.deleteExternalResources(cronJob); err != nil {
				// if fail to delete the external dependency here, return with error
				// so that it can be retried
				return ctrl.Result{}, err
			}

			// remove our finalizer from the list and update it.
			cronJob.ObjectMeta.Finalizers = removeString(cronJob.ObjectMeta.Finalizers, myFinalizerName)
			if err := r.Update(context.Background(), cronJob); err != nil {
				return ctrl.Result{}, err
			}
		}

		// Stop reconciliation as the item is being deleted
		return ctrl.Result{}, nil
	}

	// Your reconcile logic

	return ctrl.Result{}, nil
}

func (r *Reconciler) deleteExternalResources(cronJob *batch.CronJob) error {
	//
	// delete any external resources associated with the cronJob
	//
	// Ensure that delete implementation is idempotent and safe to invoke
	// multiple types for same object.
}

// Helper functions to check and remove string from a slice of strings.
func containsString(slice []string, s string) bool {
	for _, item := range slice {
		if item == s {
			return true
		}
	}
	return false
}

func removeString(slice []string, s string) (result []string) {
	for _, item := range slice {
		if item == s {
			continue
		}
		result = append(result, item)
	}
	return
}
</code></pre>
</div>
<h1><a class="header" href="#kind-cluster-1" id="kind-cluster-1">Kind Cluster</a></h1>
<p>This only cover the basics to use a kind cluster. You can find more details at
<a href="https://kind.sigs.k8s.io/">kind documentation</a>.</p>
<h2><a class="header" href="#installation" id="installation">Installation</a></h2>
<p>You can follow <a href="https://kind.sigs.k8s.io/#installation-and-usage">this</a> to
install <code>kind</code>.</p>
<h2><a class="header" href="#create-a-cluster" id="create-a-cluster">Create a Cluster</a></h2>
<p>You can simply create a <code>kind</code> cluster by</p>
<pre><code class="language-bash">kind create cluster
</code></pre>
<p>To customize your cluster, you can provide additional configuration.
For example, the following is a sample <code>kind</code> configuration.</p>
<pre><code class="language-yaml">kind: Cluster
apiVersion: kind.sigs.k8s.io/v1alpha3
nodes:
  - role: control-plane
  - role: worker
  - role: worker
  - role: worker
</code></pre>
<p>Using the configuration above, run the following command will give you a k8s
1.14.2 cluster with 1 master and 3 workers.</p>
<pre><code class="language-bash">kind create cluster --config hack/kind-config.yaml --image=kindest/node:v1.14.2
</code></pre>
<p>You can use <code>--image</code> flag to specify the cluster version you want, e.g.
<code>--image=kindest/node:v1.13.6</code>, the supported version are listed
<a href="https://hub.docker.com/r/kindest/node/tags">here</a></p>
<h2><a class="header" href="#cheetsheet" id="cheetsheet">Cheetsheet</a></h2>
<ul>
<li><a href="https://kind.sigs.k8s.io/docs/user/quick-start/#loading-an-image-into-your-cluster">Load a local image into a kind cluster</a>.</li>
</ul>
<pre><code class="language-bash">kind load docker-image your-image-name:your-tag
</code></pre>
<ul>
<li>Point <code>kubectl</code> to the kind cluster</li>
</ul>
<pre><code class="language-bash">kind export kubeconfig
</code></pre>
<ul>
<li>Delete a kind cluster</li>
</ul>
<pre><code class="language-bash">kind delete cluster
</code></pre>
<h1><a class="header" href="#webhook" id="webhook">Webhook</a></h1>
<p>Webhooks are requests for information sent in a blocking fashion. A web
application implementing webhooks will send an HTTP request to other application
when certain event happens.</p>
<p>In the kubernetes world, there are 3 kinds of webhooks:
<a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#admission-webhooks">admission webhook</a>,
<a href="https://kubernetes.io/docs/reference/access-authn-authz/webhook/">authorization webhook</a> and
<a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definition-versioning/#webhook-conversion">CRD conversion webhook</a>.</p>
<p>In <a href="https://godoc.org/sigs.k8s.io/controller-runtime/pkg/webhook">controller-runtime</a>
libraries, we support admission webhooks and CRD conversion webhooks.</p>
<p>Kubernetes supports these dynamic admission webhooks as of version 1.9 (when the
feature entered beta).</p>
<p>Kubernetes supports the conversion webhooks as of version 1.15 (when the
feature entered beta).</p>
<h1><a class="header" href="#admission-webhooks" id="admission-webhooks">Admission Webhooks</a></h1>
<p>Admission webhooks are HTTP callbacks that receive admission requests, process
them and return admission responses.</p>
<p>Kubernetes provides the following types of admission webhooks:</p>
<ul>
<li>
<p><strong>Mutating Admission Webhook</strong>:
These can mutate the object while it’s being created or updated, before it gets
stored. It can be used to default fields in a resource requests, e.g. fields in
Deployment that are not specified by the user. It can be used to inject sidecar
containers.</p>
</li>
<li>
<p><strong>Validating Admission Webhook</strong>:
These can validate the object while it’s being created or updated, before it gets
stored. It allows more complex validation than pure schema-based validation.
e.g. cross-field validation and pod image whitelisting.</p>
</li>
</ul>
<p>The apiserver by default doesn’t authenticate itself to the webhooks. However,
if you want to authenticate the clients, you can configure the apiserver to use
basic auth, bearer token, or a cert to authenticate itself to the webhooks.
You can find detailed steps
<a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#authenticate-apiservers">here</a>.</p>
<h1><a class="header" href="#admission-webhook-for-core-types" id="admission-webhook-for-core-types">Admission Webhook for Core Types</a></h1>
<p>It is very easy to build admission webhooks for CRDs, which has been covered in
the CronJob tutorial. Given that kubebuilder doesn’t support webhook scaffolding
for core types, you have to use the library from controler-runtime to handle it.
There is an <a href="https://github.com/kubernetes-sigs/controller-runtime/tree/master/examples/builtins">example</a>
in controller-runtime.</p>
<p>It is suggested to use kubebuilder to initialize a project, and then you can
follow the steps below to add admission webhooks for core types.</p>
<h2><a class="header" href="#implement-your-handler" id="implement-your-handler">Implement Your Handler</a></h2>
<p>You need to have your handler implements the
<a href="https://godoc.org/github.com/kubernetes-sigs/controller-runtime/pkg/webhook/admission#Handler">admission.Handler</a>
interface.</p>
<pre><code class="language-go">type podAnnotator struct {
	Client  client.Client
	decoder *admission.Decoder
}

func (a *podAnnotator) Handle(ctx context.Context, req admission.Request) admission.Response {
	pod := &amp;corev1.Pod{}
	err := a.decoder.Decode(req, pod)
	if err != nil {
		return admission.Errored(http.StatusBadRequest, err)
	}

	// mutate the fields in pod

	marshaledPod, err := json.Marshal(pod)
	if err != nil {
		return admission.Errored(http.StatusInternalServerError, err)
	}
	return admission.PatchResponseFromRaw(req.Object.Raw, marshaledPod)
}
</code></pre>
<p>If you need a client, just pass in the client at struct construction time.</p>
<p>If you add the <code>InjectDecoder</code> method for your handler, a decoder will be
injected for you.</p>
<pre><code class="language-go">func (a *podAnnotator) InjectDecoder(d *admission.Decoder) error {
	a.decoder = d
	return nil
}
</code></pre>
<p><strong>Note</strong>: in order to have controller-gen generate the webhook configuration for
you, you need to add markers. For example,
<code>// +kubebuilder:webhook:path=/mutate-v1-pod,mutating=true,failurePolicy=fail,groups=&quot;&quot;,resources=pods,verbs=create;update,versions=v1,name=mpod.kb.io</code></p>
<h2><a class="header" href="#update-maingo" id="update-maingo">Update main.go</a></h2>
<p>Now you need to register your handler in the webhook server.</p>
<pre><code class="language-go">mgr.GetWebhookServer().Register(&quot;/mutate-v1-pod&quot;, &amp;webhook.Admission{Handler: &amp;podAnnotator{Client: mgr.GetClient()}})
</code></pre>
<p>You need to ensure the path here match the path in the marker.</p>
<h2><a class="header" href="#deploy" id="deploy">Deploy</a></h2>
<p>Deploying it is just like deploying a webhook server for CRD. You need to</p>
<ol>
<li>provision the serving certificate 2) deploy the server</li>
</ol>
<p>You can follow the <a href="reference//cronjob-tutorial/running.html">tutorial</a>.</p>
<h1><a class="header" href="#markers-for-configcode-generation" id="markers-for-configcode-generation">Markers for Config/Code Generation</a></h1>
<p>KubeBuilder makes use of a tool called
<a href="reference//reference/controller-gen.html">controller-gen</a> for
generating utility code and Kubernetes YAML.  This code and config
generation is controlled by the presence of special “marker comments” in
Go code.</p>
<p>Markers are single-line comments that start with a plus, followed by
a marker name, optionally followed by some marker specific configuration:</p>
<pre><code class="language-go">// +kubebuilder:validation:Optional
// +kubebuilder:validation:MaxItems=2
// +kubebuilder:printcolumn:JSONPath=&quot;.status.replicas&quot;,name=Replicas,type=string
</code></pre>
<p>See each subsection for information about different types of code and YAML
generation.</p>
<h2><a class="header" href="#generating-code--artifacts-in-kubebuilder" id="generating-code--artifacts-in-kubebuilder">Generating Code &amp; Artifacts in KubeBuilder</a></h2>
<p>KubeBuilder projects have two <code>make</code> targets that make use of
controller-gen:</p>
<ul>
<li>
<p><code>make manifests</code> generates Kubernetes object YAML, like
<a href="reference/./markers/crd.html">CustomResourceDefinitions</a>,
<a href="reference/./markers/webhook.html">WebhookConfigurations</a>, and <a href="reference/./markers/rbac.html">RBAC
roles</a>.</p>
</li>
<li>
<p><code>make generate</code> generates code, like <a href="reference/./markers/object.html">runtime.Object/DeepCopy
implementations</a>.</p>
</li>
</ul>
<p>See <a href="reference/./generating-crd.html">Generating CRDs</a> for a comprehensive overview.</p>
<h2><a class="header" href="#marker-syntax" id="marker-syntax">Marker Syntax</a></h2>
<p>Exact syntax is described in the <a href="https://godoc.org/sigs.k8s.io/controller-tools/pkg/markers">godocs for
controller-tools</a>.</p>
<p>In general, markers may either be: </p>
<ul>
<li>
<p><strong>Empty</strong> (<code>+kubebuilder:validation:Optional</code>): empty markers are like boolean flags on the command line
-- just specifying them enables some behavior.</p>
</li>
<li>
<p><strong>Anonymous</strong> (<code>+kubebuilder:validation:MaxItems=2</code>): anonymous markers take
a single value as their argument.</p>
</li>
<li>
<p><strong>Multi-option</strong>
(<code>+kubebuilder:printcolumn:JSONPath=&quot;.status.replicas&quot;,name=Replicas,type=string</code>): multi-option
markers take one or more named arguments.  The first argument is
separated from the name by a colon, and latter arguments are
comma-separated.  Order of arguments doesn’t matter.  Some arguments may
be optional.</p>
</li>
</ul>
<p>Marker arguments may be strings, ints, bools, slices, or maps thereof.
Strings, ints, and bools follow their Go syntax:</p>
<pre><code class="language-go">// +kubebuilder:validation:ExclusiveMaximum=false
// +kubebuilder:validation:Format=&quot;date-time&quot;
// +kubebuilder:validation:Maximum=42
</code></pre>
<p>For convenience, in simple cases the quotes may be omitted from strings,
although this is not encouraged for anything other than single-word
strings:</p>
<pre><code class="language-go">// +kubebuilder:validation:Type=string
</code></pre>
<p>Slices may be specified either by surrounding them with curly braces and
separating with commas:</p>
<pre><code class="language-go">// +kubebuilder:webhooks:Enum={&quot;crackers, Gromit, we forgot the crackers!&quot;,&quot;not even wensleydale?&quot;}
</code></pre>
<p>or, in simple cases, by separating with semicolons:</p>
<pre><code class="language-go">// +kubebuilder:validation:Enum=Wallace;Gromit;Chicken
</code></pre>
<p>Maps are specified with string keys and values of any type (effectively
<code>map[string]interface{}</code>). A map is surrounded by curly braces (<code>{}</code>),
each key and value is separated by a colon (<code>:</code>), and each key-value
pair is separated by a comma:</p>
<pre><code class="language-go">// +kubebuilder:validation:Default={magic: {numero: 42, stringified: forty-two}}
</code></pre>
<h1><a class="header" href="#crd-generation" id="crd-generation">CRD Generation</a></h1>
<p>These markers describe how to construct a custom resource definition from
a series of Go types and packages.  Generation of the actual validation
schema is described by the <a href="reference/markers/./crd-validation.html">validation markers</a>.</p>
<p>See <a href="reference/markers//reference/generating-crd.html">Generating CRDs</a> for examples.</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-CRD"></input><label class="markers-summarize" for="markers-summarize-CRD">Show Detailed Argument Help</label><dl class="markers"><div class="marker anonymous" data-target="package"><dt class="literal name">groupName</dt><dd class="args"><dl class="args summary"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the API group name for this package.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:printcolumn</dt><dd class="args"><dl class="args summary"><dt class="argument literal">JSONPath</dt><dd class="argument type"><span class="optional">string</span></dd><dt class="argument literal optional">description</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal optional">format</dt><dd class="type optional argument"><span class="optional">string</span></dd><dt class="argument literal">name</dt><dd class="type argument"><span class="optional">string</span></dd><dt class="argument literal optional">priority</dt><dd class="argument type optional"><span class="optional">int</span></dd><dt class="argument literal">type</dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">adds a column to &#34;kubectl get&#34; output for this CRD.</summary></details><dl class="args"><dt class="argument literal">JSONPath</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the jsonpath expression used to extract the value of the column.</summary></details></dd><dt class="literal optional argument">description</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the help/description for this column.</summary></details></dd><dt class="argument literal optional">format</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">specifies the format of the column. </summary>
<p>It may be any OpenAPI data format corresponding to the type, listed at https://github.com/OAI/OpenAPI-Specification/blob/master/versions/2.0.md#data-types.</p>
</details></dd><dt class="argument literal">name</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the name of the column.</summary></details></dd><dt class="argument literal optional">priority</dt><dd class="argument type optional"><span class="optional">int</span></dd><dd class="description"><details ><summary class="">indicates how important it is that this column be displayed. </summary>
<p>Lower priority (<em>higher</em> numbered) columns will be hidden if the terminal width is too small.</p>
</details></dd><dt class="argument literal">type</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">indicates the type of the column. </summary>
<p>It may be any OpenAPI data type listed at https://github.com/OAI/OpenAPI-Specification/blob/master/versions/2.0.md#data-types.</p>
</details></dd></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:resource</dt><dd class="args"><dl class="args summary"><dt class="literal optional argument">categories</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dt class="argument literal optional">path</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal optional">scope</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal optional">shortName</dt><dd class="type optional argument"><span class="optional slice"><span class="optional">string</span></span></dd><dt class="argument literal optional">singular</dt><dd class="argument type optional"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">configures naming and scope for a CRD.</summary></details><dl class="args"><dt class="argument literal optional">categories</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="">specifies which group aliases this resource is part of. </summary>
<p>Group aliases are used to work with groups of resources at once. The most common one is “all“ which covers about a third of the base resources in Kubernetes, and is generally used for “user-facing“ resources.</p>
</details></dd><dt class="argument literal optional">path</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">specifies the plural &#34;resource&#34; for this CRD. </summary>
<p>It generally corresponds to a plural, lower-cased version of the Kind. See https://book.kubebuilder.io/cronjob-tutorial/gvks.html.</p>
</details></dd><dt class="argument literal optional">scope</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">overrides the scope of the CRD (cluster vs namespaced). </summary>
<p>Scope defaults to “namespaced“.  Cluster-scoped (“cluster“) resources don‘t exist in namespaces.</p>
</details></dd><dt class="argument literal optional">shortName</dt><dd class="optional argument type"><span class="slice optional"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="">specifies aliases for this CRD. </summary>
<p>Short names are often used when people have work with your resource over and over again.  For instance, “rs“ for “replicaset“ or “crd“ for customresourcedefinition.</p>
</details></dd><dt class="argument literal optional">singular</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">overrides the singular form of your resource. </summary>
<p>The singular form is otherwise defaulted off the plural (path).</p>
</details></dd></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">kubebuilder:skip</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">don&#39;t consider this package as an API version.</summary></details><dl class="args"></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:skipversion</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">removes the particular version of the CRD from the CRDs spec. </summary>
<p>This is useful if you need to skip generating and listing version entries for ‘internal‘ resource versions, which typically exist if using the Kubernetes upstream conversion-gen tool.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:storageversion</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">marks this version as the &#34;storage version&#34; for the CRD for conversion. </summary>
<p>When conversion is enabled for a CRD (i.e. it‘s not a trivial-versions/single-version CRD), one version is set as the “storage version“ to be stored in etcd.  Attempting to store any other version will result in conversion to the storage version via a conversion webhook.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:subresource:scale</dt><dd class="args"><dl class="args summary"><dt class="argument literal optional">selectorpath</dt><dd class="optional argument type"><span class="optional">string</span></dd><dt class="argument literal">specpath</dt><dd class="argument type"><span class="optional">string</span></dd><dt class="argument literal">statuspath</dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">enables the &#34;/scale&#34; subresource on a CRD.</summary></details><dl class="args"><dt class="optional argument literal">selectorpath</dt><dd class="optional argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">specifies the jsonpath to the pod label selector field for the scale&#39;s status. </summary>
<p>The selector field must be the <em>string</em> form (serialized form) of a selector. Setting a pod label selector is necessary for your type to work with the HorizontalPodAutoscaler.</p>
</details></dd><dt class="argument literal">specpath</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the jsonpath to the replicas field for the scale&#39;s spec.</summary></details></dd><dt class="argument literal">statuspath</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the jsonpath to the replicas field for the scale&#39;s status.</summary></details></dd></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:subresource:status</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">enables the &#34;/status&#34; subresource on a CRD.</summary></details><dl class="args"></dl></dd></div><div class="marker anonymous" data-target="package"><dt class="literal name">versionName</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">overrides the API group version for this package (defaults to the package name).</summary></details><dl class="args"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div></dl></div>
<h1><a class="header" href="#crd-validation" id="crd-validation">CRD Validation</a></h1>
<p>These markers modify how the CRD validation schema is produced for the
types and fields they modify.  Each corresponds roughly to an OpenAPI/JSON
schema option.</p>
<p>See <a href="reference/markers//reference/generating-crd.html">Generating CRDs</a> for examples.</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-CRD-validation"></input><label class="markers-summarize" for="markers-summarize-CRD-validation">Show Detailed Argument Help</label><dl class="markers"><div class="anonymous marker" data-target="field"><dt class="literal name">kubebuilder:default</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">any</span></dd></dl></dd><dd class="description"><details ><summary class="">sets the default value for this field. </summary>
<p>A default value will be accepted as any value valid for the field. Formatting for common types include: boolean: <code>true</code>, string: <code>Cluster</code>, numerical: <code>1.24</code>, array: <code>{1,2}</code>, object: <code>{policy: &amp;#34;delete&amp;#34;}</code>). Defaults should be defined in pruned form, and only best-effort validation will be performed. Full validation of a default requires submission of the containing CRD to an apiserver.</p>
</details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">any</span></dd><dd class="description"></dd></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">kubebuilder:validation:EmbeddedResource</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">EmbeddedResource marks a fields as an embedded resource with apiVersion, kind and metadata fields. </summary>
<p>An embedded resource is a value that has apiVersion, kind and metadata fields. They are validated implicitly according to the semantics of the currently running apiserver. It is not necessary to add any additional schema for these field, yet it is possible. This can be combined with PreserveUnknownFields.</p>
</details><dl class="args"></dl></dd></div><div class="anonymous marker" data-target="type"><dt class="literal name">kubebuilder:validation:Enum</dt><dd class="args"><dl class="args summary"><dt class="literal argument"></dt><dd class="argument type"><span class="slice"><span class="optional">any</span></span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this (scalar) field is restricted to the *exact* values specified here.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="slice"><span class="optional">any</span></span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:Enum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="slice"><span class="optional">any</span></span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this (scalar) field is restricted to the *exact* values specified here.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="slice"><span class="optional">any</span></span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:ExclusiveMaximum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">indicates that the maximum is &#34;up to&#34; but not including that value.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:ExclusiveMaximum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">indicates that the maximum is &#34;up to&#34; but not including that value.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:ExclusiveMinimum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">indicates that the minimum is &#34;up to&#34; but not including that value.</summary></details><dl class="args"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="anonymous marker" data-target="field"><dt class="literal name">kubebuilder:validation:ExclusiveMinimum</dt><dd class="args"><dl class="args summary"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">indicates that the minimum is &#34;up to&#34; but not including that value.</summary></details><dl class="args"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:Format</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">specifies additional &#34;complex&#34; formatting for this field. </summary>
<p>For example, a date-time field would be marked as “type: string“ and “format: date-time“.</p>
</details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:Format</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">specifies additional &#34;complex&#34; formatting for this field. </summary>
<p>For example, a date-time field would be marked as “type: string“ and “format: date-time“.</p>
</details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="anonymous marker" data-target="field"><dt class="literal name">kubebuilder:validation:MaxItems</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the maximum length for this list.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:MaxItems</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the maximum length for this list.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:MaxLength</dt><dd class="args"><dl class="args summary"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the maximum length for this string.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:MaxLength</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the maximum length for this string.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="anonymous marker" data-target="type"><dt class="literal name">kubebuilder:validation:Maximum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the maximum numeric value that this field can have.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:Maximum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the maximum numeric value that this field can have.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:MinItems</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the minimun length for this list.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:MinItems</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the minimun length for this list.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:MinLength</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the minimum length for this string.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:MinLength</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the minimum length for this string.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:Minimum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the minimum numeric value that this field can have.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="anonymous marker" data-target="field"><dt class="literal name">kubebuilder:validation:Minimum</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies the minimum numeric value that this field can have.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="anonymous marker" data-target="field"><dt class="literal name">kubebuilder:validation:MultipleOf</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this field must have a numeric value that&#39;s a multiple of this one.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="anonymous marker" data-target="type"><dt class="literal name">kubebuilder:validation:MultipleOf</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this field must have a numeric value that&#39;s a multiple of this one.</summary></details><dl class="args"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">int</span></dd><dd class="description"></dd></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">kubebuilder:validation:Optional</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this field is optional, if fields are required by default.</summary></details><dl class="args"></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">kubebuilder:validation:Optional</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">specifies that all fields in this package are optional by default.</summary></details><dl class="args"></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:Pattern</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this string must match the given regular expression.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:Pattern</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this string must match the given regular expression.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">kubebuilder:validation:Required</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this field is required, if fields are optional by default.</summary></details><dl class="args"></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">kubebuilder:validation:Required</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">specifies that all fields in this package are required by default.</summary></details><dl class="args"></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:Type</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">overrides the type for this field (which defaults to the equivalent of the Go type). </summary>
<p>This generally must be paired with custom serialization.  For example, the metav1.Time field would be marked as “type: string“ and “format: date-time“.</p>
</details><dl class="args"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:Type</dt><dd class="args"><dl class="args summary"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">overrides the type for this field (which defaults to the equivalent of the Go type). </summary>
<p>This generally must be paired with custom serialization.  For example, the metav1.Time field would be marked as “type: string“ and “format: date-time“.</p>
</details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="field"><dt class="literal name">kubebuilder:validation:UniqueItems</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that all items in this list must be unique.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:validation:UniqueItems</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies that all items in this list must be unique.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">kubebuilder:validation:XEmbeddedResource</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">EmbeddedResource marks a fields as an embedded resource with apiVersion, kind and metadata fields. </summary>
<p>An embedded resource is a value that has apiVersion, kind and metadata fields. They are validated implicitly according to the semantics of the currently running apiserver. It is not necessary to add any additional schema for these field, yet it is possible. This can be combined with PreserveUnknownFields.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:validation:XEmbeddedResource</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">EmbeddedResource marks a fields as an embedded resource with apiVersion, kind and metadata fields. </summary>
<p>An embedded resource is a value that has apiVersion, kind and metadata fields. They are validated implicitly according to the semantics of the currently running apiserver. It is not necessary to add any additional schema for these field, yet it is possible. This can be combined with PreserveUnknownFields.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">nullable</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">marks this field as allowing the &#34;null&#34; value. </summary>
<p>This is often not necessary, but may be helpful with custom serialization.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">optional</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">specifies that this field is optional, if fields are required by default.</summary></details><dl class="args"></dl></dd></div></dl></div>
<h1><a class="header" href="#crd-processing" id="crd-processing">CRD Processing</a></h1>
<p>These markers help control how the Kubernetes API server processes API
requests involving your custom resources.</p>
<p>See <a href="reference/markers//reference/generating-crd.html">Generating CRDs</a> for examples.</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-CRD-processing"></input><label class="markers-summarize" for="markers-summarize-CRD-processing">Show Detailed Argument Help</label><dl class="markers"><div class="marker" data-target="field"><dt class="literal name">kubebuilder:pruning:PreserveUnknownFields</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">PreserveUnknownFields stops the apiserver from pruning fields which are not specified. </summary>
<p>By default the apiserver drops unknown fields from the request payload during the decoding step. This marker stops the API server from doing so. It affects fields recursively, but switches back to normal pruning behaviour if nested  properties or additionalProperties are specified in the schema. This can either be true or undefined. False is forbidden.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="type"><dt class="literal name">kubebuilder:validation:XPreserveUnknownFields</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">PreserveUnknownFields stops the apiserver from pruning fields which are not specified. </summary>
<p>By default the apiserver drops unknown fields from the request payload during the decoding step. This marker stops the API server from doing so. It affects fields recursively, but switches back to normal pruning behaviour if nested  properties or additionalProperties are specified in the schema. This can either be true or undefined. False is forbidden.</p>
</details><dl class="args"></dl></dd></div><div class="marker" data-target="field"><dt class="literal name">kubebuilder:validation:XPreserveUnknownFields</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">PreserveUnknownFields stops the apiserver from pruning fields which are not specified. </summary>
<p>By default the apiserver drops unknown fields from the request payload during the decoding step. This marker stops the API server from doing so. It affects fields recursively, but switches back to normal pruning behaviour if nested  properties or additionalProperties are specified in the schema. This can either be true or undefined. False is forbidden.</p>
</details><dl class="args"></dl></dd></div></dl></div>
<h1><a class="header" href="#webhook-1" id="webhook-1">Webhook</a></h1>
<p>These markers describe how <a href="reference/markers/../webhook-overview.html">webhook configuration</a> is generated.
Use these to keep the description of your webhooks close to the code that
implements them.</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-Webhook"></input><label class="markers-summarize" for="markers-summarize-Webhook">Show Detailed Argument Help</label><dl class="markers"><div class="marker" data-target="package"><dt class="literal name">kubebuilder:webhook</dt><dd class="args"><dl class="args summary"><dt class="argument literal">failurePolicy</dt><dd class="argument type"><span class="optional">string</span></dd><dt class="argument literal">groups</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dt class="argument literal">mutating</dt><dd class="argument type"><span class="optional">bool</span></dd><dt class="argument literal">name</dt><dd class="argument type"><span class="optional">string</span></dd><dt class="argument literal">path</dt><dd class="argument type"><span class="optional">string</span></dd><dt class="argument literal">resources</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dt class="argument literal">verbs</dt><dd class="type argument"><span class="slice"><span class="optional">string</span></span></dd><dt class="argument literal">versions</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd></dl></dd><dd class="description"><details ><summary class="">specifies how a webhook should be served. </summary>
<p>It specifies only the details that are intrinsic to the application serving it (e.g. the resources it can handle, or the path it serves on).</p>
</details><dl class="args"><dt class="literal argument">failurePolicy</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="">specifies what should happen if the API server cannot reach the webhook. </summary>
<p>It may be either “ignore“ (to skip the webhook and continue on) or “fail“ (to reject the object in question).</p>
</details></dd><dt class="argument literal">groups</dt><dd class="type argument"><span class="slice"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">specifies the API groups that this webhook receives requests for.</summary></details></dd><dt class="argument literal">mutating</dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"><details ><summary class="">marks this as a mutating webhook (it&#39;s validating only if false) </summary>
<p>Mutating webhooks are allowed to change the object in their response, and are called <em>before</em> all validating webhooks.  Mutating webhooks may choose to reject an object, similarly to a validating webhook.</p>
</details></dd><dt class="argument literal">name</dt><dd class="type argument"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">indicates the name of this webhook configuration.</summary></details></dd><dt class="argument literal">path</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies that path that the API server should connect to this webhook on.</summary></details></dd><dt class="argument literal">resources</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">specifies the API resources that this webhook receives requests for.</summary></details></dd><dt class="argument literal">verbs</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="">specifies the Kubernetes API verbs that this webhook receives requests for. </summary>
<p>Only modification-like verbs may be specified. May be “create“, “update“, “delete“, “connect“, or “*“ (for all).</p>
</details></dd><dt class="argument literal">versions</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">specifies the API versions that this webhook receives requests for.</summary></details></dd></dl></dd></div></dl></div>
<h1><a class="header" href="#objectdeepcopy" id="objectdeepcopy">Object/DeepCopy</a></h1>
<p>These markers control when <code>DeepCopy</code> and <code>runtime.Object</code> implementation
methods are generated.</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-object"></input><label class="markers-summarize" for="markers-summarize-object">Show Detailed Argument Help</label><dl class="markers"><div class="marker deprecated anonymous" data-target="package" data-deprecated="kubebuilder:object:generate"><dt class="literal name">k8s:deepcopy-gen</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">raw</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">enables or disables object interface &amp; deepcopy implementation generation for this package</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">raw</span></dd><dd class="description"></dd></dl></dd></div><div class="marker deprecated anonymous" data-target="type" data-deprecated="kubebuilder:object:generate"><dt class="literal name">k8s:deepcopy-gen</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">raw</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">overrides enabling or disabling deepcopy generation for this type</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">raw</span></dd><dd class="description"></dd></dl></dd></div><div class="marker deprecated anonymous" data-target="type" data-deprecated="kubebuilder:object:root"><dt class="literal name">k8s:deepcopy-gen:interfaces</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">enables object interface implementation generation for this type</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="package"><dt class="literal name">kubebuilder:object:generate</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">enables or disables object interface &amp; deepcopy implementation generation for this package</summary></details><dl class="args"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:object:generate</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">overrides enabling or disabling deepcopy generation for this type</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="type argument"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div><div class="marker anonymous" data-target="type"><dt class="literal name">kubebuilder:object:root</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">enables object interface implementation generation for this type</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">bool</span></dd><dd class="description"></dd></dl></dd></div></dl></div>
<h1><a class="header" href="#rbac" id="rbac">RBAC</a></h1>
<p>These markers cause an <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-and-clusterrole">RBAC
ClusterRole</a>
to be generated.  This allows you to describe the permissions that your
controller requires alongside the code that makes use of those
permissions.</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-RBAC"></input><label class="markers-summarize" for="markers-summarize-RBAC">Show Detailed Argument Help</label><dl class="markers"><div class="marker" data-target="package"><dt class="literal name">kubebuilder:rbac</dt><dd class="args"><dl class="args summary"><dt class="optional argument literal">groups</dt><dd class="optional argument type"><span class="slice optional"><span class="optional">string</span></span></dd><dt class="optional argument literal">namespace</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal optional">resources</dt><dd class="optional argument type"><span class="slice optional"><span class="optional">string</span></span></dd><dt class="literal optional argument">urls</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dt class="argument literal">verbs</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd></dl></dd><dd class="description"><details ><summary class="no-details">specifies an RBAC rule to all access to some resources or non-resource URLs.</summary></details><dl class="args"><dt class="optional argument literal">groups</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">specifies the API groups that this rule encompasses.</summary></details></dd><dt class="literal optional argument">namespace</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the scope of the Rule. If not set, the Rule belongs to the generated ClusterRole. If set, the Rule belongs to a Role, whose namespace is specified by this field.</summary></details></dd><dt class="argument literal optional">resources</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">specifies the API resources that this rule encompasses.</summary></details></dd><dt class="argument literal optional">urls</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">URL specifies the non-resource URLs that this rule encompasses.</summary></details></dd><dt class="argument literal">verbs</dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="no-details">specifies the (lowercase) kubernetes API verbs that this rule encompasses.</summary></details></dd></dl></dd></div></dl></div>
<h1><a class="header" href="#controller-gen-cli" id="controller-gen-cli">controller-gen CLI</a></h1>
<p>KubeBuilder makes use of a tool called
<a href="https://sigs.k8s.io/controller-tools/cmd/controller-gen">controller-gen</a>
for generating utility code and Kubernetes YAML.  This code and config
generation is controlled by the presence of special <a href="reference//reference/markers.html">“marker
comments”</a> in Go code.</p>
<p>controller-gen is built out of different “generators” (which specify what
to generate) and “output rules” (which specify how and where to write the
results).</p>
<p>Both are configured through command line options specified in <a href="reference//reference/markers.html">marker
format</a>.</p>
<p>For instance,</p>
<pre><code class="language-shell">controller-gen paths=./... crd:trivialVersions=true rbac:roleName=controller-perms output:crd:artifacts:config=config/crd/bases
</code></pre>
<p>generates CRDs and RBAC, and specifically stores the generated CRD YAML in
<code>config/crd/bases</code>.  For the RBAC, it uses the default output rules
(<code>config/rbac</code>).  It considers every package in the current directory tree
(as per the normal rules of the go <code>...</code> wildcard).</p>
<h2><a class="header" href="#generators" id="generators">Generators</a></h2>
<p>Each different generator is configured through a CLI option.  Multiple
generators may be used in a single invocation of <code>controller-gen</code>.</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-CLI:-generators"></input><label class="markers-summarize" for="markers-summarize-CLI:-generators">Show Detailed Argument Help</label><dl class="markers"><div class="marker" data-target="package"><dt class="literal name">webhook</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">generates (partial) {Mutating,Validating}WebhookConfiguration objects.</summary></details><dl class="args"></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">schemapatch</dt><dd class="args"><dl class="args summary"><dt class="argument literal">manifests</dt><dd class="argument type"><span class="optional">string</span></dd><dt class="argument literal optional">maxDescLen</dt><dd class="argument type optional"><span class="optional">int</span></dd></dl></dd><dd class="description"><details ><summary class="">patches existing CRDs with new schemata. </summary>
<p>For legacy (v1beta1) single-version CRDs, it will simply replace the global schema. 
For legacy (v1beta1) multi-version CRDs, and any v1 CRDs, it will replace schemata of existing versions and <em>clear the schema</em> from any versions not specified in the Go code.  It will <em>not</em> add new versions, or remove old ones. 
For legacy multi-version CRDs with identical schemata, it will take care of lifting the per-version schema up to the global schema. 
It will generate output for each “CRD Version“ (API version of the CRD type itself) , e.g. apiextensions/v1beta1 and apiextensions/v1) available.</p>
</details><dl class="args"><dt class="argument literal">manifests</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">contains the CustomResourceDefinition YAML files.</summary></details></dd><dt class="argument literal optional">maxDescLen</dt><dd class="argument type optional"><span class="optional">int</span></dd><dd class="description"><details ><summary class="">specifies the maximum description length for fields in CRD&#39;s OpenAPI schema. </summary>
<p>0 indicates drop the description for all fields completely. n indicates limit the description to at most n characters and truncate the description to closest sentence boundary if it exceeds n characters.</p>
</details></dd></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">rbac</dt><dd class="args"><dl class="args summary"><dt class="argument literal">roleName</dt><dd class="type argument"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">generates ClusterRole objects.</summary></details><dl class="args"><dt class="argument literal">roleName</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">sets the name of the generated ClusterRole.</summary></details></dd></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">object</dt><dd class="args"><dl class="args summary"><dt class="argument literal optional">headerFile</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="literal optional argument">year</dt><dd class="argument type optional"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">generates code containing DeepCopy, DeepCopyInto, and DeepCopyObject method implementations.</summary></details><dl class="args"><dt class="argument literal optional">headerFile</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the header text (e.g. license) to prepend to generated files.</summary></details></dd><dt class="argument literal optional">year</dt><dd class="type optional argument"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">specifies the year to substitute for &#34; YEAR&#34; in the header file.</summary></details></dd></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">crd</dt><dd class="args"><dl class="args summary"><dt class="argument literal optional">crdVersions</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dt class="argument literal optional">maxDescLen</dt><dd class="optional argument type"><span class="optional">int</span></dd><dt class="argument literal optional">preserveUnknownFields</dt><dd class="optional argument type"><span class="optional">bool</span></dd><dt class="argument literal optional">trivialVersions</dt><dd class="optional argument type"><span class="optional">bool</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">generates CustomResourceDefinition objects.</summary></details><dl class="args"><dt class="argument literal optional">crdVersions</dt><dd class="argument type optional"><span class="slice optional"><span class="optional">string</span></span></dd><dd class="description"><details ><summary class="">specifies the target API versions of the CRD type itself to generate.  Defaults to v1beta1. </summary>
<p>The first version listed will be assumed to be the “default“ version and will not get a version suffix in the output filename. 
You‘ll need to use “v1“ to get support for features like defaulting, along with an API server that supports it (Kubernetes 1.16+).</p>
</details></dd><dt class="argument literal optional">maxDescLen</dt><dd class="argument type optional"><span class="optional">int</span></dd><dd class="description"><details ><summary class="">specifies the maximum description length for fields in CRD&#39;s OpenAPI schema. </summary>
<p>0 indicates drop the description for all fields completely. n indicates limit the description to at most n characters and truncate the description to closest sentence boundary if it exceeds n characters.</p>
</details></dd><dt class="literal optional argument">preserveUnknownFields</dt><dd class="argument type optional"><span class="optional">bool</span></dd><dd class="description"></dd><dt class="argument literal optional">trivialVersions</dt><dd class="argument type optional"><span class="optional">bool</span></dd><dd class="description"><details ><summary class="">indicates that we should produce a single-version CRD. </summary>
<p>Single “trivial-version“ CRDs are compatible with older (pre 1.13) Kubernetes API servers.  The storage version‘s schema will be used as the CRD‘s schema. 
Only works with the v1beta1 CRD version.</p>
</details></dd></dl></dd></div></dl></div>
<h2><a class="header" href="#output-rules" id="output-rules">Output Rules</a></h2>
<p>Output rules configure how a given generator outputs its results. There is
always one global “fallback” output rule (specified as <code>output:&lt;rule&gt;</code>),
plus per-generator overrides (specified as <code>output:&lt;generator&gt;:&lt;rule&gt;</code>).</p>
<aside class="note">
<h1><a class="header" href="#default-rules" id="default-rules">Default Rules</a></h1>
<p>When no fallback rule is specified manually, a set of default
per-generator rules are used which result in YAML going to
<code>config/&lt;generator&gt;</code>, and code staying where it belongs.</p>
<p>The default rules are equivalent to
<code>output:&lt;generator&gt;:artifacts:config=config/&lt;generator&gt;</code> for each
generator.</p>
<p>When a “fallback” rule is specified, that’ll be used instead of the
default rules.</p>
<p>For example, if you specify <code>crd rbac:roleName=controller-perms output:crd:stdout</code>, you’ll get CRDs on standard out, and rbac in a file in
<code>config/rbac</code>. If you were to add in a global rule instead, like <code>crd rbac:roleName=controller-perms output:crd:stdout output:none</code>, you’d get
CRDs to standard out, and everything else to /dev/null, because we’ve
explicitly specified a fallback.</p>
</aside>
<p>For brevity, the per-generator output rules (<code>output:&lt;generator&gt;:&lt;rule&gt;</code>)
are omitted below.  They are equivalent to the global fallback options
listed here.</p>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-CLI:-output-rules-(optionally-as-output:<generator>:...)"></input><label class="markers-summarize" for="markers-summarize-CLI:-output-rules-(optionally-as-output:<generator>:...)">Show Detailed Argument Help</label><dl class="markers"><div class="marker" data-target="package"><dt class="literal name">output:artifacts</dt><dd class="args"><dl class="args summary"><dt class="argument literal optional">code</dt><dd class="argument type optional"><span class="optional">string</span></dd><dt class="argument literal">config</dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="">outputs artifacts to different locations, depending on whether they&#39;re package-associated or not. </summary>
<p>Non-package associated artifacts are output to the Config directory, while package-associated ones are output to their package‘s source files‘ directory, unless an alternate path is specified in Code.</p>
</details><dl class="args"><dt class="argument literal optional">code</dt><dd class="argument type optional"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">overrides the directory in which to write new code (defaults to where the existing code lives).</summary></details></dd><dt class="argument literal">config</dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"><details ><summary class="no-details">points to the directory to which to write configuration.</summary></details></dd></dl></dd></div><div class="marker anonymous" data-target="package"><dt class="literal name">output:dir</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="optional">string</span></dd></dl></dd><dd class="description"><details ><summary class="no-details">outputs each artifact to the given directory, regardless of if it&#39;s package-associated or not.</summary></details><dl class="args"><dt class="literal argument"></dt><dd class="argument type"><span class="optional">string</span></dd><dd class="description"></dd></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">output:none</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="no-details">skips outputting anything.</summary></details><dl class="args"></dl></dd></div><div class="marker" data-target="package"><dt class="literal name">output:stdout</dt><dd class="args"><dl class="args summary"></dl></dd><dd class="description"><details ><summary class="">outputs everything to standard-out, with no separation. </summary>
<p>Generally useful for single-artifact outputs.</p>
</details><dl class="args"></dl></dd></div></dl></div>
<h2><a class="header" href="#other-options" id="other-options">Other Options</a></h2>
<div><input checked type="checkbox" class="markers-summarize" id="markers-summarize-CLI:-generic"></input><label class="markers-summarize" for="markers-summarize-CLI:-generic">Show Detailed Argument Help</label><dl class="markers"><div class="marker anonymous" data-target="package"><dt class="literal name">paths</dt><dd class="args"><dl class="args summary"><dt class="argument literal"></dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd></dl></dd><dd class="description"><details ><summary class="no-details">represents paths and go-style path patterns to use as package roots.</summary></details><dl class="args"><dt class="argument literal"></dt><dd class="argument type"><span class="slice"><span class="optional">string</span></span></dd><dd class="description"></dd></dl></dd></div></dl></div>
<h1><a class="header" href="#artifacts" id="artifacts">Artifacts</a></h1>
<p>Kubebuilder publishes test binaries and container images in addition
to the main binary releases.</p>
<h2><a class="header" href="#test-binaries" id="test-binaries">Test Binaries</a></h2>
<p>You can find all of the test binaries at <code>https://go.kubebuilder.io/test-tools</code>.
You can find individual test binaries at <code>https://go.kubebuilder.io/test-tools/${version}/${os}/${arch}</code>.</p>
<h2><a class="header" href="#container-images" id="container-images">Container Images</a></h2>
<p>You can find all container images for your os at <code>https://go.kubebuilder.io/images/${os}</code>
or at <code>gcr.io/kubebuilder/thirdparty-${os}</code>.
You can find individual container images at <code>https://go.kubebuilder.io/images/${os}/${version}</code>
or at <code>gcr.io/kubebuilder/thirdparty-${os}:${version}</code>.</p>
<h1><a class="header" href="#writing-controller-tests" id="writing-controller-tests">Writing controller tests</a></h1>
<p>Testing Kubernetes controller is a big subject, and the boilerplate testing
files generated for you by kubebuilder are fairly minimal.</p>
<p><a href="reference//reference/testing/envtest.html">Writing and Running Integration Tests</a> documents steps to consider when writing integration steps for your controllers, and available options for configuring your test control plane using <a href="https://godoc.org/github.com/kubernetes-sigs/controller-runtime/pkg/envtest"><code>envtest</code></a>.</p>
<p>Until more documentation has been written, your best bet to get started is to look at some
existing examples, such as:</p>
<ul>
<li>Azure Databricks Operator: see their fully fleshed-out
<a href="https://github.com/microsoft/azure-databricks-operator/blob/0f722a710fea06b86ecdccd9455336ca712bf775/controllers/suite_test.go"><code>suite_test.go</code></a>
as well as any <code>*_test.go</code> file in that directory <a href="https://github.com/microsoft/azure-databricks-operator/blob/0f722a710fea06b86ecdccd9455336ca712bf775/controllers/secretscope_controller_test.go">like this
one</a>.</li>
</ul>
<p>The basic approach is that, in your generated <code>suite_test.go</code> file, you will
create a local Kubernetes API server, instantiate and run your controllers, and
then write additional <code>*_test.go</code> files to test it using
<a href="http://onsi.github.io/ginkgo">Ginko</a>.</p>
<h2><a class="header" href="#using-envtest-in-integration-tests" id="using-envtest-in-integration-tests">Using envtest in integration tests</a></h2>
<p><a href="http://sigs.k8s.io/controller-runtime"><code>controller-runtime</code></a> offers <code>envtest</code> (<a href="https://godoc.org/github.com/kubernetes-sigs/controller-runtime/pkg/envtest">godoc</a>), a package that helps write integration tests for your controllers by setting up and starting an instance of etcd and the Kubernetes API server, without kubelet, controller-manager or other components.</p>
<p>Using <code>envtest</code> in integration tests follows the general flow of:</p>
<pre><code class="language-go">import sigs.k8s.io/controller-runtime/pkg/envtest

//specify testEnv configuration
testEnv = &amp;envtest.Environment{
	CRDDirectoryPaths: []string{filepath.Join(&quot;..&quot;, &quot;config&quot;, &quot;crd&quot;, &quot;bases&quot;)},
}

//start testEnv
cfg, err = testEnv.Start()

//write test logic

//stop testEnv
err = testEnv.Stop()
</code></pre>
<p><code>kubebuilder</code> does the boilerplate setup and teardown of testEnv for you, in the ginkgo test suite that it generates under the <code>/controllers</code> directory.</p>
<p>Logs from the test runs are prefixed with <code>test-env</code>.</p>
<h3><a class="header" href="#configuring-your-test-control-plane" id="configuring-your-test-control-plane">Configuring your test control plane</a></h3>
<p>You can use environment variables and/or flags to specify the <code>api-server</code> and <code>etcd</code> setup within your integration tests.</p>
<h4><a class="header" href="#environment-variables" id="environment-variables">Environment Variables</a></h4>
<table><thead><tr><th>Variable name</th><th align="left">Type</th><th align="left">When to use</th></tr></thead><tbody>
<tr><td><code>USE_EXISTING_CLUSTER</code></td><td align="left">boolean</td><td align="left">Instead of setting up a local control plane, point to the control plane of an existing cluster.</td></tr>
<tr><td><code>KUBEBUILDER_ASSETS</code></td><td align="left">path to directory</td><td align="left">Point integration tests to a directory containing all binaries (api-server, etcd and kubectl).</td></tr>
<tr><td><code>TEST_ASSET_KUBE_APISERVER</code>, <code>TEST_ASSET_ETCD</code>, <code>TEST_ASSET_KUBECTL</code></td><td align="left">paths to, respectively, api-server, etcd and kubectl binaries</td><td align="left">Similar to <code>KUBEBUILDER_ASSETS</code>, but more granular. Point integration tests to use binaries other than the default ones. These environment variables can also be used to ensure specific tests run with expected versions of these binaries.</td></tr>
<tr><td><code>KUBEBUILDER_CONTROLPLANE_START_TIMEOUT</code> and <code>KUBEBUILDER_CONTROLPLANE_STOP_TIMEOUT</code></td><td align="left">durations in format supported by <a href="https://golang.org/pkg/time/#ParseDuration"><code>time.ParseDuration</code></a></td><td align="left">Specify timeouts different from the default for the test control plane to (respectively) start and stop; any test run that exceeds them will fail.</td></tr>
<tr><td><code>KUBEBUILDER_ATTACH_CONTROL_PLANE_OUTPUT</code></td><td align="left">boolean</td><td align="left">Set to <code>true</code> to attach the control plane’s stdout and stderr to os.Stdout and os.Stderr. This can be useful when debugging test failures, as output will include output from the control plane.</td></tr>
</tbody></table>
<h4><a class="header" href="#flags" id="flags">Flags</a></h4>
<p>Here’s an example of modifying the flags with which to start the API server in your integration tests, compared to the default values in <code>envtest.DefaultKubeAPIServerFlags</code>:</p>
<pre><code class="language-go">customApiServerFlags := []string{
	&quot;--secure-port=6884&quot;,
	&quot;--admission-control=MutatingAdmissionWebhook&quot;,
}

apiServerFlags := append([]string(nil), envtest.DefaultKubeAPIServerFlags...)
apiServerFlags = append(apiServerFlags, customApiServerFlags...)

testEnv = &amp;envtest.Environment{
	CRDDirectoryPaths: []string{filepath.Join(&quot;..&quot;, &quot;config&quot;, &quot;crd&quot;, &quot;bases&quot;)},
	KubeAPIServerFlags: apiServerFlags,
}
</code></pre>
<h3><a class="header" href="#testing-considerations" id="testing-considerations">Testing considerations</a></h3>
<p>Unless you’re using an existing cluster, keep in mind that no built-in controllers are running in the test context. In some ways, the test control plane will behave differently from “real” clusters, and that might have an impact on how you write tests. One common example is garbage collection; because there are no controllers monitoring built-in resources, objects do not get deleted, even if an <code>OwnerReference</code> is set up.</p>
<p>To test that the deletion lifecycle works, test the ownership instead of asserting on existence. For example:</p>
<pre><code class="language-go">expectedOwnerReference := v1.OwnerReference{
	Kind:       &quot;MyCoolCustomResource&quot;,
	APIVersion: &quot;my.api.example.com/v1beta1&quot;,
	UID:        &quot;d9607e19-f88f-11e6-a518-42010a800195&quot;,
	Name:       &quot;userSpecifiedResourceName&quot;,
}
Expect(deployment.ObjectMeta.OwnerReferences).To(ContainElement(expectedOwnerReference))
</code></pre>
<h1><a class="header" href="#metrics" id="metrics">Metrics</a></h1>
<p>By default, controller-runtime builds a global prometheus registry and
publishes a collection of performance metrics for each controller.</p>
<h2><a class="header" href="#protecting-the-metrics" id="protecting-the-metrics">Protecting the Metrics</a></h2>
<p>These metrics are protected by <a href="https://github.com/brancz/kube-rbac-proxy">kube-auth-proxy</a>
by default if using kubebuilder. Kubebuilder v2.2.0+ scaffold a clusterrole which
can be found at <code>config/rbac/auth_proxy_client_clusterrole.yaml</code>.</p>
<p>You will need to grant permissions to your Prometheus server so that it can
scrape the protected metrics. To achieve that, you can create a
<code>clusterRoleBinding</code> to bind the <code>clusterRole</code> to the service account that your
Prometheus server uses.</p>
<p>You can run the following kubectl command to create it. If using kubebuilder
<code>&lt;project-prefix&gt;</code> is the <code>namePrefix</code> field in <code>config/default/kustomization.yaml</code>.</p>
<pre><code class="language-bash">kubectl create clusterrolebinding metrics --clusterrole=&lt;project-prefix&gt;-metrics-reader --serviceaccount=&lt;namespace&gt;:&lt;service-account-name&gt;
</code></pre>
<h2><a class="header" href="#exporting-metrics-for-prometheus" id="exporting-metrics-for-prometheus">Exporting Metrics for Prometheus</a></h2>
<p>Follow the steps below to export the metrics using the Prometheus Operator:</p>
<ol>
<li>Install Prometheus and Prometheus Operator.
We recommend using <a href="https://github.com/coreos/kube-prometheus#installing">kube-prometheus</a> 
in production if you don’t have your own monitoring system.
If you are just experimenting, you can only install Prometheus and Prometheus Operator.</li>
<li>Uncomment the line <code>- ../prometheus</code> in the <code>config/default/kustomization.yaml</code>.
It creates the <code>ServiceMonitor</code> resource which enables exporting the metrics.</li>
</ol>
<pre><code class="language-yaml"># [PROMETHEUS] To enable prometheus monitor, uncomment all sections with 'PROMETHEUS'.
- ../prometheus
</code></pre>
<p>Note that, when you install your project in the cluster, it will create the
<code>ServiceMonitor</code> to export the metrics. To check the ServiceMonitor, 
run <code>kubectl get ServiceMonitor -n &lt;project&gt;-system</code>. See an example:</p>
<pre><code>$ kubectl get ServiceMonitor -n monitor-system 
NAME                                         AGE
monitor-controller-manager-metrics-monitor   2m8s
</code></pre>
<p>Also, notice that the metrics are exported by default through port <code>8443</code>. In this way,
you are able to check the Prometheus metrics in its dashboard. To verify it, search 
for the metrics exported from the namespace where the project is running 
<code>{namespace=&quot;&lt;project&gt;-system&quot;}</code>. See an example: </p>
<img width="1680" alt="Screenshot 2019-10-02 at 13 07 13" src="https://user-images.githubusercontent.com/7708031/66042888-a497da80-e515-11e9-9d77-d8a9fc1159a5.png">  
<h2><a class="header" href="#publishing-additional-metrics" id="publishing-additional-metrics">Publishing Additional Metrics</a></h2>
<p>If you wish to publish additional metrics from your controllers, this
can be easily achieved by using the global registry from
<code>controller-runtime/pkg/metrics</code>.</p>
<p>One way to achieve this is to declare your collectors as global variables and then register them using <code>init()</code>.</p>
<p>For example:</p>
<pre><code class="language-go">import (
    &quot;github.com/prometheus/client_golang/prometheus&quot;
    &quot;sigs.k8s.io/controller-runtime/pkg/metrics&quot;
)

var (
    goobers = prometheus.NewCounter(
        prometheus.CounterOpts{
            Name: &quot;goobers_total&quot;,
            Help: &quot;Number of goobers proccessed&quot;,
        },
    )
    gooberFailures = prometheus.NewCounter(
        prometheus.CounterOpts{
            Name: &quot;goober_failures_total&quot;,
            Help: &quot;Number of failed goobers&quot;,
        },
    )
)

func init() {
    // Register custom metrics with the global prometheus registry
    metrics.Registry.MustRegister(goobers, gooberFailures)
}
</code></pre>
<p>You may then record metrics to those collectors from any part of your
reconcile loop, and those metrics will be available for prometheus or
other openmetrics systems to scrape.</p>
<h1><a class="header" href="#todo" id="todo">TODO</a></h1>
<p>If you’re seeing this page, it’s probably because something’s not done in
the book yet.  Go <a href="https://github.com/kubernetes-sigs/kubebuilder/issues?q=is%3Aopen+is%3Aissue+label%3Akind%2Fdocumentation">see if anyone else has found
this</a>
or <a href="https://github.com/kubernetes-sigs/kubebuilder/issues/new?assignees=&amp;labels=kind%2Fdocumentation">bug the
maintainers</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3001");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload(true); // force reload from server (not from cache)
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
